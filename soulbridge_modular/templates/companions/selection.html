{% extends "base.html" %}

{% block title %}Choose Your AI Companion - SoulBridge AI{% endblock %}

{% block content %}
<div class="companion-selection-container">
    <div class="selection-header">
        <h1>ü§ñ Choose Your AI Companion</h1>
        <p class="subtitle">Select your perfect AI companion for personalized conversations</p>
        
        <div class="user-status">
            <div class="status-card">
                <div class="status-info">
                    <span class="tier-badge tier-{{ user_plan }}">{{ user_plan.title() }} Tier</span>
                    {% if trial_active %}
                        <span class="trial-badge">üéÅ 5-Hour Trial Active</span>
                    {% endif %}
                </div>
                <div class="companion-count">
                    <strong>{{ accessible_ids|length }}</strong> of {{ companion_stats.total_companions }} companions available
                </div>
            </div>
        </div>
    </div>

    <!-- Bronze Tier Companions -->
    <div class="companion-tier-section">
        <div class="tier-header bronze">
            <h2>ü•â Bronze Companions</h2>
            <p>Always available to all users</p>
        </div>
        
        <div class="companion-grid">
            {% for companion in all_companions_by_tier.bronze %}
                <div class="companion-card {% if companion.id not in accessible_ids %}locked{% endif %}" 
                     data-companion-id="{{ companion.id }}"
                     data-tier="{{ companion.tier.value }}">
                    
                    <div class="companion-image">
                        <img src="{{ companion.image_url }}" alt="{{ companion.name }}" 
                             onerror="this.src='/static/logos/New IntroLogo.png'">
                        <div class="access-status">
                            {% if companion.id in accessible_ids %}
                                <span class="unlocked">‚úÖ Available</span>
                            {% else %}
                                <span class="locked">üîí Locked</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="companion-info">
                        <h3 class="companion-name">{{ companion.name }}</h3>
                        <p class="companion-description">{{ companion.description }}</p>
                        
                        {% if companion.id in accessible_ids %}
                            <button class="btn btn-primary start-chat-btn" 
                                    onclick="startChat('{{ companion.id }}')">
                                Start Chatting
                            </button>
                        {% else %}
                            <button class="btn btn-locked" disabled>
                                Locked
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Silver Tier Companions -->
    {% if all_companions_by_tier.silver %}
    <div class="companion-tier-section">
        <div class="tier-header silver">
            <h2>ü•à Silver Companions</h2>
            <p>Enhanced personalities for Silver tier users</p>
            {% if user_plan == 'bronze' and not trial_active %}
                <div class="upgrade-prompt">
                    <span>Upgrade to Silver tier to unlock these companions!</span>
                    <a href="/auth/activate-trial" class="btn btn-trial">Try 5-Hour Gold Trial</a>
                </div>
            {% endif %}
        </div>
        
        <div class="companion-grid">
            {% for companion in all_companions_by_tier.silver %}
                <div class="companion-card {% if companion.id not in accessible_ids %}locked{% endif %}" 
                     data-companion-id="{{ companion.id }}"
                     data-tier="{{ companion.tier.value }}">
                    
                    <div class="companion-image">
                        <img src="{{ companion.image_url }}" alt="{{ companion.name }}" 
                             onerror="this.src='/static/logos/New IntroLogo.png'">
                        <div class="access-status">
                            {% if companion.id in accessible_ids %}
                                <span class="unlocked">‚úÖ Available</span>
                            {% else %}
                                <span class="locked">üîí Silver Required</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="companion-info">
                        <h3 class="companion-name">{{ companion.name }}</h3>
                        <p class="companion-description">{{ companion.description }}</p>
                        
                        {% if companion.id in accessible_ids %}
                            <button class="btn btn-primary start-chat-btn" 
                                    onclick="startChat('{{ companion.id }}')">
                                Start Chatting
                            </button>
                        {% else %}
                            <button class="btn btn-locked" disabled>
                                Silver Tier Required
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Gold Tier Companions -->
    {% if all_companions_by_tier.gold %}
    <div class="companion-tier-section">
        <div class="tier-header gold">
            <h2>ü•á Gold Companions</h2>
            <p>Premium companions with unlimited possibilities</p>
            {% if user_plan != 'gold' and not trial_active %}
                <div class="upgrade-prompt">
                    <span>Upgrade to Gold tier for unlimited access!</span>
                    {% if user_plan == 'bronze' %}
                        <a href="/auth/activate-trial" class="btn btn-trial">Try 5-Hour Gold Trial</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
        
        <div class="companion-grid">
            {% for companion in all_companions_by_tier.gold %}
                <div class="companion-card {% if companion.id not in accessible_ids %}locked{% endif %}" 
                     data-companion-id="{{ companion.id }}"
                     data-tier="{{ companion.tier.value }}">
                    
                    <div class="companion-image">
                        <img src="{{ companion.image_url }}" alt="{{ companion.name }}" 
                             onerror="this.src='/static/logos/New IntroLogo.png'">
                        <div class="access-status">
                            {% if companion.id in accessible_ids %}
                                <span class="unlocked">‚úÖ Available</span>
                                {% if trial_active and user_plan == 'bronze' %}
                                    <small class="trial-note">Via Trial</small>
                                {% endif %}
                            {% else %}
                                <span class="locked">üîí Gold Required</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="companion-info">
                        <h3 class="companion-name">{{ companion.name }}</h3>
                        <p class="companion-description">{{ companion.description }}</p>
                        
                        {% if companion.id in accessible_ids %}
                            <button class="btn btn-primary start-chat-btn" 
                                    onclick="startChat('{{ companion.id }}')">
                                Start Chatting
                            </button>
                        {% else %}
                            <button class="btn btn-locked" disabled>
                                Gold Tier Required
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Referral Companions -->
    {% if all_companions_by_tier.referral %}
    <div class="companion-tier-section">
        <div class="tier-header referral">
            <h2>üèÜ Referral Companions</h2>
            <p>Exclusive companions for community builders</p>
            <div class="referral-info">
                Your referrals: <strong>{{ referral_count }}</strong>
            </div>
        </div>
        
        <div class="companion-grid">
            {% for companion in all_companions_by_tier.referral %}
                <div class="companion-card {% if companion.id not in accessible_ids %}locked{% endif %}" 
                     data-companion-id="{{ companion.id }}"
                     data-tier="{{ companion.tier.value }}">
                    
                    <div class="companion-image">
                        <img src="{{ companion.image_url }}" alt="{{ companion.name }}" 
                             onerror="this.src='/static/logos/New IntroLogo.png'">
                        <div class="access-status">
                            {% if companion.id in accessible_ids %}
                                <span class="unlocked">‚úÖ Unlocked</span>
                            {% else %}
                                <span class="locked">üîí {{ companion.min_referrals }} Referrals</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="companion-info">
                        <h3 class="companion-name">{{ companion.name }}</h3>
                        <p class="companion-description">{{ companion.description }}</p>
                        
                        {% if companion.id in accessible_ids %}
                            <button class="btn btn-primary start-chat-btn" 
                                    onclick="startChat('{{ companion.id }}')">
                                Start Chatting
                            </button>
                        {% else %}
                            <button class="btn btn-locked" disabled>
                                {{ companion.min_referrals }} Referrals Required
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Trial Activation -->
    {% if user_plan == 'bronze' and not trial_active %}
    <div class="trial-activation-section">
        <div class="trial-card">
            <div class="trial-content">
                <h3>üéÅ Free 5-Hour Gold Trial</h3>
                <p>Experience all premium companions and features for 5 hours!</p>
                <ul>
                    <li>‚úÖ Access all Silver and Gold companions</li>
                    <li>‚úÖ Unlimited daily uses</li>
                    <li>‚úÖ Premium features unlocked</li>
                    <li>‚úÖ 60 artistic time credits</li>
                </ul>
                <button id="activateTrialBtn" class="btn btn-trial-large" onclick="activateTrial()">
                    Activate Free Trial
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
.companion-selection-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem 0;
}

.selection-header {
    text-align: center;
    margin-bottom: 3rem;
}

.selection-header h1 {
    font-size: 2.5rem;
    color: var(--text-primary);
    margin-bottom: 1rem;
}

.subtitle {
    font-size: 1.2rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
}

.user-status {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.status-info {
    display: flex;
    gap: 1rem;
    justify-content: center;
    align-items: center;
    margin-bottom: 1rem;
}

.tier-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
    color: white;
}

.tier-badge.tier-bronze {
    background: var(--bronze-color);
}

.tier-badge.tier-silver {
    background: var(--silver-color);
    color: #333;
}

.tier-badge.tier-gold {
    background: var(--gold-color);
    color: #333;
}

.trial-badge {
    background: linear-gradient(135deg, #ffd700, #ffed4a);
    color: #333;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
}

.companion-count {
    color: var(--text-primary);
    font-size: 1.1rem;
}

.companion-tier-section {
    margin-bottom: 4rem;
}

.tier-header {
    text-align: center;
    margin-bottom: 2rem;
    padding: 2rem;
    border-radius: 15px;
    color: white;
}

.tier-header.bronze {
    background: linear-gradient(135deg, #CD7F32, #B8860B);
}

.tier-header.silver {
    background: linear-gradient(135deg, #C0C0C0, #708090);
}

.tier-header.gold {
    background: linear-gradient(135deg, #FFD700, #FFA500);
    color: #333;
}

.tier-header.referral {
    background: linear-gradient(135deg, #8A2BE2, #4B0082);
}

.tier-header h2 {
    margin: 0 0 0.5rem 0;
    font-size: 2rem;
}

.tier-header p {
    margin: 0;
    opacity: 0.9;
}

.upgrade-prompt {
    background: rgba(255,255,255,0.2);
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.btn-trial {
    background: var(--primary-gold);
    color: #333;
    text-decoration: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-trial:hover {
    background: #e6c200;
    transform: translateY(-2px);
}

.companion-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.companion-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border: 3px solid transparent;
}

.companion-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.companion-card.locked {
    opacity: 0.7;
    border-color: #ccc;
}

.companion-image {
    position: relative;
    height: 200px;
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    display: flex;
    align-items: center;
    justify-content: center;
}

.companion-image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

.access-status {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: 600;
}

.access-status .unlocked {
    background: #d4edda;
    color: #155724;
}

.access-status .locked {
    background: #f8d7da;
    color: #721c24;
}

.trial-note {
    display: block;
    font-size: 0.7rem;
    margin-top: 2px;
    opacity: 0.8;
}

.companion-info {
    padding: 1.5rem;
}

.companion-name {
    font-size: 1.3rem;
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
}

.companion-description {
    color: var(--text-secondary);
    margin: 0 0 1rem 0;
    line-height: 1.4;
}

.start-chat-btn {
    background: var(--primary-blue);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
}

.start-chat-btn:hover {
    background: #357abd;
    transform: translateY(-2px);
}

.btn-locked {
    background: #6c757d;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    width: 100%;
    cursor: not-allowed;
}

.trial-activation-section {
    text-align: center;
    margin-top: 3rem;
}

.trial-card {
    background: linear-gradient(135deg, #ffd700, #ffed4a);
    color: #333;
    border-radius: 15px;
    padding: 3rem 2rem;
    max-width: 600px;
    margin: 0 auto;
}

.trial-card h3 {
    font-size: 2rem;
    margin: 0 0 1rem 0;
}

.trial-card ul {
    text-align: left;
    margin: 1.5rem 0;
    list-style: none;
    padding: 0;
}

.trial-card li {
    padding: 0.5rem 0;
    font-weight: 600;
}

.btn-trial-large {
    background: #333;
    color: white;
    padding: 16px 32px;
    font-size: 1.1rem;
    border: none;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-trial-large:hover {
    background: #555;
    transform: translateY(-2px);
}

.referral-info {
    background: rgba(255,255,255,0.2);
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1rem;
}

@media (max-width: 768px) {
    .selection-header h1 {
        font-size: 2rem;
    }
    
    .companion-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .status-info {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .upgrade-prompt {
        flex-direction: column;
        text-align: center;
    }
}
</style>

<script>
function startChat(companionId) {
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Starting...';
    button.disabled = true;
    
    // Navigate to chat
    window.location.href = `/companions/chat/${companionId}`;
}

async function activateTrial() {
    const button = document.getElementById('activateTrialBtn');
    const originalText = button.textContent;
    
    // Show loading state
    button.textContent = 'Activating...';
    button.disabled = true;
    
    try {
        const response = await fetch('/auth/activate-trial', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            SoulBridge.showMessage(result.message, 'success');
            
            // Reload page after 2 seconds to show unlocked companions
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            SoulBridge.showMessage(result.error || 'Trial activation failed', 'error');
            button.textContent = originalText;
            button.disabled = false;
        }
    } catch (error) {
        console.error('Trial activation error:', error);
        SoulBridge.showMessage('An error occurred. Please try again.', 'error');
        button.textContent = originalText;
        button.disabled = false;
    }
}

// Auto-refresh if trial is active (to show when it expires)
{% if trial_active %}
// Refresh every 5 minutes to check trial status
setInterval(() => {
    fetch('/auth/check-session')
        .then(response => response.json())
        .then(data => {
            if (!data.trial_active && {{ trial_active|tojson }}) {
                // Trial expired, reload page
                window.location.reload();
            }
        })
        .catch(error => console.log('Session check failed:', error));
}, 5 * 60 * 1000);
{% endif %}
</script>
{% endblock %}