<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riddle Me Mini Game - SoulBridge AI</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Ad-Free Detection Script -->
    <script>
        window.__AD_FREE__ = {{ 'true' if ad_free else 'false' }};
        window.__USER_SESSION__ = {{ user_session | tojson | safe }};
    </script>
    
    <!-- Conditional AdSense Loading (Only for non-ad-free users) -->
    <script>
        (function() {
            var adFree = (window.__AD_FREE__ === true || window.__AD_FREE__ === 'true');
            if (!adFree) {
                var s = document.createElement('script');
                s.async = true;
                s.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3869471953521437";
                s.crossOrigin = "anonymous";
                document.head.appendChild(s);
                console.log('üì∫ AdSense loaded for Soul Riddle page');
            } else {
                console.log('üö´ AdSense blocked - user has ad-free subscription');
            }
        })();
    </script>
    
    <!-- React dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2a1810 100%);
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .riddle-game {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .game-header {
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .game-title h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #8b5cf6, #06b6d4, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .game-title p {
            color: rgba(226, 232, 240, 0.7);
            font-size: 1.1rem;
        }

        .user-stats {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .credits-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(139, 92, 246, 0.2);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .credits-icon {
            font-size: 1.2rem;
        }

        .credits-amount {
            font-size: 1.3rem;
            font-weight: bold;
            color: #8b5cf6;
        }

        .trial-countdown {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(245, 158, 11, 0.2);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b;
            font-size: 0.9rem;
        }

        .close-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: scale(1.05);
        }

        .nav-buttons {
            position: fixed;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 1001;
        }

        .nav-btn {
            background: rgba(15, 15, 35, 0.9);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #e2e8f0;
            padding: 10px 15px;
            border-radius: 8px;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .nav-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
        }

        /* Game Content */
        .game-content {
            flex: 1;
            padding: 40px 20px;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        /* Game Tabs */
        .game-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .game-tab {
            background: rgba(15, 15, 35, 0.8);
            border: 2px solid rgba(139, 92, 246, 0.3);
            color: #e2e8f0;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .game-tab.active {
            background: rgba(139, 92, 246, 0.3);
            border-color: #8b5cf6;
            color: #8b5cf6;
        }

        .game-tab:hover:not(.active) {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.5);
        }

        /* Difficulty Selection */
        .difficulty-selection {
            margin-bottom: 40px;
        }

        .difficulty-title {
            text-align: center;
            margin-bottom: 20px;
            color: #8b5cf6;
            font-size: 1.5rem;
        }

        .difficulty-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .difficulty-card {
            background: rgba(15, 15, 35, 0.8);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .difficulty-card:hover, .difficulty-card.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.2);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
        }

        .card-back {
            width: 80px;
            height: 100px;
            margin: 0 auto 15px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #1e293b, #334155);
            border: 2px solid rgba(139, 92, 246, 0.3);
        }

        .card-back.easy {
            background: linear-gradient(45deg, #10b981, #06d6a0);
            color: #fff;
        }

        .card-back.normal {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            color: #fff;
        }

        .card-back.hard {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: #fff;
        }

        .card-back.insane {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: #fff;
        }

        .memory-card-preview {
            background-image: url('/static/horoscope/back.png');
            background-size: cover;
            background-position: center;
            background-blend-mode: overlay;
        }

        .memory-card-preview.easy {
            background-image: url('/static/horoscope/back.png');
        }

        .memory-card-preview.normal {
            background-image: url('/static/logos/New IntroLogo.png');
        }

        .memory-card-preview.hard {
            background-image: url('/static/logos/The IntroLogo.png');
        }

        .memory-card-preview.insane {
            background-image: url('/static/horoscope/back.png');
            filter: hue-rotate(180deg);
        }

        .difficulty-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .difficulty-cost {
            font-size: 0.9rem;
            color: rgba(226, 232, 240, 0.7);
        }

        /* Riddle Area */
        .riddle-area {
            background: rgba(15, 15, 35, 0.8);
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .riddle-question {
            font-size: 1.4rem;
            line-height: 1.6;
            color: #e2e8f0;
            margin-bottom: 30px;
            background: rgba(139, 92, 246, 0.1);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .riddle-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .riddle-btn {
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .unlock-btn {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
        }

        .unlock-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .hint-btn {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
        }

        .hint-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3);
        }

        .reveal-btn {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            color: white;
        }

        .reveal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
        }

        .ad-btn {
            background: linear-gradient(45deg, #8b5cf6, #7c3aed);
            color: white;
        }

        .ad-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.3);
        }

        .riddle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Memory Match Game */
        .memory-game {
            display: grid;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .memory-card {
            aspect-ratio: 1;
            background: rgba(15, 15, 35, 0.8) url('/static/horoscope/back.png') center/cover;
            border: 2px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            transition: all 0.3s ease;
            background-blend-mode: overlay;
        }

        .memory-card:hover {
            border-color: #8b5cf6;
            background-color: rgba(139, 92, 246, 0.2);
        }

        .memory-card.flipped {
            background: linear-gradient(45deg, #8b5cf6, #06b6d4);
            color: white;
        }

        .memory-card.matched {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            cursor: default;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-stats {
                justify-content: center;
            }
            
            .game-title h1 {
                font-size: 2rem;
            }
            
            .nav-buttons {
                position: relative;
                top: auto;
                left: auto;
                justify-content: center;
                margin-bottom: 20px;
            }
            
            .difficulty-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .riddle-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .riddle-btn {
                width: 100%;
                max-width: 250px;
            }
        }

        @media (max-width: 480px) {
            .difficulty-cards {
                grid-template-columns: 1fr;
            }
            
            .game-content {
                padding: 20px 10px;
            }
        }

        /* Ad containers */
        .ad-container {
            margin: 20px 0;
            text-align: center;
            padding: 10px;
            border: 1px dashed rgba(139, 92, 246, 0.3);
            border-radius: 8px;
            background: rgba(15, 15, 35, 0.3);
        }

        .ad-container.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Navigation buttons -->
    <div class="nav-buttons">
        <a href="javascript:history.back()" class="nav-btn">
            ‚Üê Back to Chat
        </a>
        <a href="/intro" class="nav-btn">
            üè† Home
        </a>
    </div>

    <!-- Ad slot for non-ad-free users (top banner) -->
    <div class="ad-container" id="top-ad" style="display: none;">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3869471953521437"
             data-ad-slot="1234567890"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>

    <!-- Main game container -->
    <div id="riddle-game-root" class="riddle-game">
        <div class="game-header">
            <div class="game-title">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                    <img src="/static/logos/SoulCipher.png" alt="SoulCipher" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid rgba(139, 92, 246, 0.5);">
                    <h1>üß© Riddle Me Mini Game</h1>
                </div>
                <p>SoulCipher, the Soul Riddle Master challenges you‚Ä¶ Are you up for the challenge?</p>
            </div>
            
            <div class="user-stats">
                <div class="credits-display">
                    <span class="credits-icon">üíé</span>
                    <span class="credits-amount" id="credits-counter">100</span>
                    <span>Credits</span>
                </div>
                <div class="trial-countdown" id="trial-timer" style="display: none;">
                    <span>üî•</span>
                    <span>Trial: <span id="trial-time">5:00:00</span></span>
                </div>
            </div>
        </div>
        
        <div class="game-content">
            <!-- Game Tabs -->
            <div class="game-tabs">
                <button class="game-tab active" data-tab="riddles">üß© Riddles</button>
                <button class="game-tab" data-tab="memory">üß† Memory Match</button>
            </div>

            <!-- Riddles Tab Content -->
            <div class="tab-content" id="riddles-tab">
                <div class="difficulty-selection">
                    <h3 class="difficulty-title">Choose Your Challenge</h3>
                    <div class="difficulty-cards">
                        <div class="difficulty-card" data-difficulty="easy">
                            <div class="card-back easy">?</div>
                            <div class="difficulty-name">Easy</div>
                            <div class="difficulty-cost">Unlock: 1 üíé</div>
                        </div>
                        <div class="difficulty-card" data-difficulty="normal">
                            <div class="card-back normal">SB</div>
                            <div class="difficulty-name">Normal</div>
                            <div class="difficulty-cost">Unlock: 1 üíé</div>
                        </div>
                        <div class="difficulty-card" data-difficulty="hard">
                            <div class="card-back hard">üíñ</div>
                            <div class="difficulty-name">Hard</div>
                            <div class="difficulty-cost">Unlock: 1 üíé</div>
                        </div>
                        <div class="difficulty-card" data-difficulty="insane">
                            <div class="card-back insane">üëë</div>
                            <div class="difficulty-name">Insane</div>
                            <div class="difficulty-cost">Unlock: 1 üíé</div>
                        </div>
                    </div>
                </div>

                <div class="riddle-area" id="riddle-content" style="display: none;">
                    <div class="riddle-question" id="riddle-question">
                        Select a difficulty level to begin your challenge!
                    </div>
                    <div class="riddle-actions" id="riddle-actions">
                        <button class="riddle-btn unlock-btn" id="unlock-btn">üîì Unlock (-1 üíé)</button>
                        <button class="riddle-btn hint-btn" id="hint-btn">üí° Hint (-3 üíé)</button>
                        <button class="riddle-btn reveal-btn" id="reveal-btn">üéØ Reveal (-5 üíé)</button>
                        <button class="riddle-btn ad-btn" id="ad-unlock-btn" style="display: none;">üì∫ Watch Ad & Unlock</button>
                    </div>
                </div>
            </div>

            <!-- Memory Match Tab Content -->
            <div class="tab-content" id="memory-tab" style="display: none;">
                <div class="difficulty-selection">
                    <h3 class="difficulty-title">Memory Challenge</h3>
                    <div class="difficulty-cards">
                        <div class="difficulty-card" data-memory-difficulty="easy">
                            <div class="card-back easy memory-card-preview">4√ó4</div>
                            <div class="difficulty-name">Easy</div>
                            <div class="difficulty-cost">16 Cards</div>
                        </div>
                        <div class="difficulty-card" data-memory-difficulty="normal">
                            <div class="card-back normal memory-card-preview">6√ó6</div>
                            <div class="difficulty-name">Normal</div>
                            <div class="difficulty-cost">36 Cards</div>
                        </div>
                        <div class="difficulty-card" data-memory-difficulty="hard">
                            <div class="card-back hard memory-card-preview">8√ó8</div>
                            <div class="difficulty-name">Hard</div>
                            <div class="difficulty-cost">64 Cards</div>
                        </div>
                        <div class="difficulty-card" data-memory-difficulty="insane">
                            <div class="card-back insane memory-card-preview">10√ó10</div>
                            <div class="difficulty-name">Insane</div>
                            <div class="difficulty-cost">100 Cards</div>
                        </div>
                    </div>
                </div>

                <div class="memory-game" id="memory-grid" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Ad slot for non-ad-free users (bottom banner) -->
    <div class="ad-container" id="bottom-ad" style="display: none;">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3869471953521437"
             data-ad-slot="9876543210"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Game state
        let gameState = {
            credits: 100,
            plan: window.__USER_SESSION__?.plan || 'bronze',
            trial: {
                active: window.__USER_SESSION__?.trial_active || false,
                timeRemaining: 5 * 60 * 60 * 1000, // 5 hours in ms
                creditsRemaining: 60
            },
            currentTab: 'riddles',
            selectedDifficulty: null,
            currentRiddle: null,
            riddleUnlocked: false,
            riddleHinted: false,
            riddleRevealed: false
        };

        // Sample riddles by difficulty
        const riddles = {
            easy: [
                { question: "What has keys but no locks, space but no room?", answer: "keyboard", hint: "You use it to type" },
                { question: "What gets wet while drying?", answer: "towel", hint: "You use it after a shower" },
                { question: "What has hands but cannot clap?", answer: "clock", hint: "It tells time" }
            ],
            normal: [
                { question: "I speak without a mouth and hear without ears. What am I?", answer: "echo", hint: "Sound that returns to you" },
                { question: "The more you take, the more you leave behind. What am I?", answer: "footsteps", hint: "Made when walking" },
                { question: "What can travel around the world while staying in a corner?", answer: "stamp", hint: "Found on letters" }
            ],
            hard: [
                { question: "I am not alive, but I grow; I don't have lungs, but I need air.", answer: "fire", hint: "Hot and bright" },
                { question: "What is so fragile that saying its name breaks it?", answer: "silence", hint: "The absence of sound" },
                { question: "I have cities, but no houses. I have mountains, but no trees.", answer: "map", hint: "Shows geography" }
            ],
            insane: [
                { question: "What comes once in a minute, twice in a moment, but never in a thousand years?", answer: "m", hint: "Look at the letters" },
                { question: "The man who invented it doesn't want it. The man who bought it doesn't need it.", answer: "coffin", hint: "Related to death" },
                { question: "What has a heart that doesn't beat?", answer: "artichoke", hint: "It's a vegetable" }
            ]
        };

        // Main App Component
        const RiddleGame = () => {
            const [credits, setCredits] = useState(gameState.credits);
            const [currentTab, setCurrentTab] = useState('riddles');
            const [selectedDifficulty, setSelectedDifficulty] = useState(null);
            const [currentRiddle, setCurrentRiddle] = useState(null);
            const [riddleState, setRiddleState] = useState({
                unlocked: false,
                hinted: false,
                revealed: false
            });
            const [trialTime, setTrialTime] = useState(gameState.trial.timeRemaining);

            // Update credits display
            useEffect(() => {
                document.getElementById('credits-counter').textContent = credits;
            }, [credits]);

            // Trial countdown timer
            useEffect(() => {
                if (gameState.trial.active) {
                    document.getElementById('trial-timer').style.display = 'flex';
                    
                    const timer = setInterval(() => {
                        setTrialTime(prev => {
                            const newTime = prev - 1000;
                            if (newTime <= 0) {
                                gameState.trial.active = false;
                                document.getElementById('trial-timer').style.display = 'none';
                                clearInterval(timer);
                                return 0;
                            }
                            
                            const hours = Math.floor(newTime / (1000 * 60 * 60));
                            const minutes = Math.floor((newTime % (1000 * 60 * 60)) / (1000 * 60));
                            const seconds = Math.floor((newTime % (1000 * 60)) / 1000);
                            
                            document.getElementById('trial-time').textContent = 
                                `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                            
                            return newTime;
                        });
                    }, 1000);
                    
                    return () => clearInterval(timer);
                }
            }, []);

            const handleTabSwitch = (tab) => {
                setCurrentTab(tab);
                document.querySelectorAll('.game-tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
                
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.style.display = 'none';
                });
                document.getElementById(`${tab}-tab`).style.display = 'block';
            };

            const handleDifficultySelect = (difficulty) => {
                setSelectedDifficulty(difficulty);
                const riddleList = riddles[difficulty];
                const randomRiddle = riddleList[Math.floor(Math.random() * riddleList.length)];
                setCurrentRiddle(randomRiddle);
                setRiddleState({ unlocked: false, hinted: false, revealed: false });
                
                document.getElementById('riddle-content').style.display = 'block';
                document.getElementById('riddle-question').textContent = "üîí Riddle is locked! Choose an action to proceed.";
                
                // Update button visibility based on plan
                const isBronze = gameState.plan === 'bronze' && !gameState.trial.active;
                document.getElementById('unlock-btn').style.display = isBronze ? 'none' : 'inline-block';
                document.getElementById('hint-btn').style.display = isBronze ? 'none' : 'inline-block';
                document.getElementById('reveal-btn').style.display = isBronze ? 'none' : 'inline-block';
                document.getElementById('ad-unlock-btn').style.display = isBronze ? 'inline-block' : 'none';
            };

            const handleUnlock = () => {
                if (credits >= 1) {
                    setCredits(prev => prev - 1);
                    setRiddleState(prev => ({ ...prev, unlocked: true }));
                    document.getElementById('riddle-question').textContent = currentRiddle.question;
                    
                    // Track usage via API
                    fetch('/api/soul-riddle/use', { method: 'POST' });
                }
            };

            const handleHint = () => {
                if (credits >= 3) {
                    setCredits(prev => prev - 3);
                    setRiddleState(prev => ({ ...prev, hinted: true }));
                    
                    if (!riddleState.unlocked) {
                        document.getElementById('riddle-question').textContent = currentRiddle.question;
                        setRiddleState(prev => ({ ...prev, unlocked: true }));
                    }
                    
                    document.getElementById('riddle-question').innerHTML = 
                        `${currentRiddle.question}<br><br>üí° <em>Hint: ${currentRiddle.hint}</em>`;
                }
            };

            const handleReveal = () => {
                if (credits >= 5) {
                    setCredits(prev => prev - 5);
                    setRiddleState(prev => ({ ...prev, revealed: true, unlocked: true }));
                    
                    document.getElementById('riddle-question').innerHTML = 
                        `${currentRiddle.question}<br><br>üéØ <strong>Answer: ${currentRiddle.answer}</strong>`;
                    
                    // Trigger confetti
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                }
            };

            const handleAdUnlock = () => {
                // Simulate ad watching
                alert('Ad watched! Riddle unlocked!');
                setRiddleState(prev => ({ ...prev, unlocked: true }));
                document.getElementById('riddle-question').textContent = currentRiddle.question;
                
                // Track usage via API
                fetch('/api/soul-riddle/use', { method: 'POST' });
            };

            const setupMemoryGame = (difficulty) => {
                const sizes = { easy: 4, normal: 6, hard: 8, insane: 10 };
                const gridSize = sizes[difficulty];
                const totalCards = gridSize * gridSize;
                
                const grid = document.getElementById('memory-grid');
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
                grid.innerHTML = '';
                
                // Create card pairs
                const symbols = ['üéµ', 'üé∏', 'üé§', 'üéπ', 'üé∫', 'üé∑', 'ü•Å', 'üéª', 'üé™', 'üé≠', 'üé®', 'üéØ', 'üé≤', 'üéÆ', 'üé≥', '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'üéæ'];
                const cardPairs = [];
                
                for (let i = 0; i < totalCards / 2; i++) {
                    const symbol = symbols[i % symbols.length];
                    cardPairs.push(symbol, symbol);
                }
                
                // Shuffle cards
                for (let i = cardPairs.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cardPairs[i], cardPairs[j]] = [cardPairs[j], cardPairs[i]];
                }
                
                // Get card back image based on difficulty
                const cardBackImages = {
                    easy: '/static/horoscope/back.png',
                    normal: '/static/logos/New IntroLogo.png',
                    hard: '/static/logos/The IntroLogo.png',
                    insane: '/static/horoscope/back.png'
                };
                
                // Create card elements
                cardPairs.forEach((symbol, index) => {
                    const card = document.createElement('div');
                    card.className = 'memory-card';
                    card.style.backgroundImage = `url('${cardBackImages[difficulty]}')`;
                    card.style.backgroundSize = 'cover';
                    card.style.backgroundPosition = 'center';
                    card.style.backgroundBlendMode = 'overlay';
                    if (difficulty === 'insane') {
                        card.style.filter = 'hue-rotate(180deg)';
                    }
                    card.dataset.symbol = symbol;
                    card.dataset.index = index;
                    card.addEventListener('click', handleCardClick);
                    grid.appendChild(card);
                });
            };

            let flippedCards = [];
            let matchedPairs = 0;
            
            const handleCardClick = (e) => {
                const card = e.target;
                
                if (card.classList.contains('flipped') || card.classList.contains('matched') || flippedCards.length >= 2) {
                    return;
                }
                
                card.classList.add('flipped');
                card.textContent = card.dataset.symbol;
                flippedCards.push(card);
                
                if (flippedCards.length === 2) {
                    setTimeout(() => {
                        if (flippedCards[0].dataset.symbol === flippedCards[1].dataset.symbol) {
                            flippedCards.forEach(c => {
                                c.classList.remove('flipped');
                                c.classList.add('matched');
                            });
                            matchedPairs++;
                            
                            // Check if game won
                            const totalPairs = document.querySelectorAll('.memory-card').length / 2;
                            if (matchedPairs === totalPairs) {
                                setTimeout(() => {
                                    confetti({
                                        particleCount: 150,
                                        spread: 90,
                                        origin: { y: 0.6 }
                                    });
                                    alert('Congratulations! You won the memory game!');
                                }, 300);
                            }
                        } else {
                            flippedCards.forEach(c => {
                                c.classList.remove('flipped');
                                c.textContent = '';
                            });
                        }
                        flippedCards = [];
                    }, 1000);
                }
            };

            // Event listeners setup
            useEffect(() => {
                // Tab switching
                document.querySelectorAll('.game-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        handleTabSwitch(e.target.dataset.tab);
                    });
                });

                // Difficulty selection for riddles
                document.querySelectorAll('[data-difficulty]').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const difficulty = e.currentTarget.dataset.difficulty;
                        document.querySelectorAll('[data-difficulty]').forEach(c => c.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        handleDifficultySelect(difficulty);
                    });
                });

                // Memory game difficulty selection
                document.querySelectorAll('[data-memory-difficulty]').forEach(card => {
                    card.addEventListener('click', (e) => {
                        const difficulty = e.currentTarget.dataset.memoryDifficulty;
                        document.querySelectorAll('[data-memory-difficulty]').forEach(c => c.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        matchedPairs = 0;
                        setupMemoryGame(difficulty);
                    });
                });

                // Riddle action buttons
                document.getElementById('unlock-btn').addEventListener('click', handleUnlock);
                document.getElementById('hint-btn').addEventListener('click', handleHint);
                document.getElementById('reveal-btn').addEventListener('click', handleReveal);
                document.getElementById('ad-unlock-btn').addEventListener('click', handleAdUnlock);

            }, []);

            return null; // We're manipulating DOM directly
        };

        // Initialize the game
        ReactDOM.render(<RiddleGame />, document.getElementById('riddle-game-root'));

        // Show ads for non-ad-free users
        window.addEventListener('load', function() {
            const adFree = (window.__AD_FREE__ === true || window.__AD_FREE__ === 'true');
            
            if (!adFree && !gameState.trial.active) {
                document.getElementById('top-ad').style.display = 'block';
                document.getElementById('bottom-ad').style.display = 'block';
                
                if (window.adsbygoogle) {
                    (adsbygoogle = window.adsbygoogle || []).push({});
                    (adsbygoogle = window.adsbygoogle || []).push({});
                }
            }
        });
    </script>
</body>
</html>