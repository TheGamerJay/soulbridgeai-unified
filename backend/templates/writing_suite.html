<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writing Suite - SoulBridge AI</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .panel-header h2 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .panel-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .category-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }

        .category-tab {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 0.9rem;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .category-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .category-content {
            display: none;
        }

        .category-content.active {
            display: block;
        }

        .writing-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .writing-type-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .writing-type-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.1);
        }

        .writing-type-card.selected {
            border-color: #667eea;
            background: #f0f3ff;
        }

        .writing-type-card h4 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .writing-type-card p {
            color: #666;
            font-size: 0.85rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .writing-type-features {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .feature-tag {
            background: #e7f0ff;
            color: #667eea;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9ff;
        }

        .form-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-row-three {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        .key-points-container {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 10px;
            min-height: 100px;
        }

        .key-point {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 8px;
            background: #f0f3ff;
            border-radius: 5px;
        }

        .key-point input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 2px;
        }

        .key-point .remove-btn {
            color: #ff6b6b;
            cursor: pointer;
            padding: 2px 5px;
        }

        .add-point-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
            margin-top: 10px;
        }

        .usage-info {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            color: #004085;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .output-container {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .output-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            font-size: 0.9rem;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: #f0f3ff;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 2px;
        }

        .stat-label {
            font-size: 0.75rem;
            color: #666;
        }

        .analysis-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9ff;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .analysis-section h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .suggestion {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 8px;
            margin: 5px 0;
            border-radius: 5px;
            font-size: 0.85rem;
        }

        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .action-buttons button {
            flex: 1;
            padding: 8px 15px;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .writing-type-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row,
            .form-row-three {
                grid-template-columns: 1fr;
            }
            
            .category-tabs {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Writing Generator Panel -->
        <div class="panel">
            <div class="panel-header">
                <h2><i class="fas fa-pen-fancy"></i> Writing Suite</h2>
                <p>Professional writing generation for all your needs</p>
            </div>
            <div class="panel-content">
                <div class="usage-info" id="usage-info">
                    Loading usage information...
                </div>

                <!-- Category Selection -->
                <div class="category-tabs">
                    <button class="category-tab active" data-category="scripts">
                        <i class="fas fa-film"></i> Scripts
                    </button>
                    <button class="category-tab" data-category="articles">
                        <i class="fas fa-newspaper"></i> Articles
                    </button>
                    <button class="category-tab" data-category="letters">
                        <i class="fas fa-envelope"></i> Letters
                    </button>
                    <button class="category-tab" data-category="creative">
                        <i class="fas fa-feather"></i> Creative
                    </button>
                </div>

                <!-- Category Contents -->
                <div id="scripts-content" class="category-content active">
                    <div class="writing-type-grid" id="scripts-grid"></div>
                </div>

                <div id="articles-content" class="category-content">
                    <div class="writing-type-grid" id="articles-grid"></div>
                </div>

                <div id="letters-content" class="category-content">
                    <div class="writing-type-grid" id="letters-grid"></div>
                </div>

                <div id="creative-content" class="category-content">
                    <div class="writing-type-grid" id="creative-grid"></div>
                </div>

                <!-- Writing Form -->
                <form id="writing-form" style="display: none;">
                    <div class="form-section">
                        <h3><i class="fas fa-cog"></i> Writing Configuration</h3>
                        
                        <div class="form-group">
                            <label for="topic">Topic/Subject *</label>
                            <textarea id="topic" name="topic" placeholder="Describe what you want to write about..." required maxlength="200"></textarea>
                            <small>Max 200 characters</small>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="tone">Tone & Style</label>
                                <select id="tone" name="tone">
                                    <option value="professional">Professional</option>
                                    <option value="formal">Formal</option>
                                    <option value="casual">Casual</option>
                                    <option value="friendly">Friendly</option>
                                    <option value="persuasive">Persuasive</option>
                                    <option value="informative">Informative</option>
                                    <option value="creative">Creative</option>
                                    <option value="humorous">Humorous</option>
                                    <option value="serious">Serious</option>
                                    <option value="empathetic">Empathetic</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="length">Length</label>
                                <select id="length" name="length">
                                    <option value="short">Short</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="long">Long</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="target-audience">Target Audience</label>
                            <input type="text" id="target-audience" name="target_audience" placeholder="e.g., business professionals, general public, students...">
                        </div>

                        <div class="form-group">
                            <label>Key Points to Include</label>
                            <div class="key-points-container" id="key-points-container">
                                <div class="key-point">
                                    <i class="fas fa-grip-vertical" style="color: #ccc;"></i>
                                    <input type="text" placeholder="Enter a key point...">
                                    <i class="fas fa-times remove-btn" onclick="removeKeyPoint(this)"></i>
                                </div>
                            </div>
                            <button type="button" class="add-point-btn" onclick="addKeyPoint()">
                                <i class="fas fa-plus"></i> Add Point
                            </button>
                        </div>

                        <div class="form-group">
                            <label for="additional-requirements">Additional Requirements</label>
                            <textarea id="additional-requirements" name="additional_requirements" placeholder="Any specific formatting, style, or content requirements..." rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="save-title">Save As (Optional)</label>
                            <input type="text" id="save-title" name="save_title" placeholder="Give your writing a title to save it...">
                        </div>
                    </div>

                    <button type="submit" class="btn" id="generate-btn">
                        <i class="fas fa-magic"></i> Generate Writing
                    </button>
                </form>

                <div id="analyze-section" style="display: none;">
                    <div class="form-section">
                        <h3><i class="fas fa-chart-line"></i> Analyze Existing Writing</h3>
                        
                        <div class="form-group">
                            <label for="analyze-content">Paste Your Writing *</label>
                            <textarea id="analyze-content" placeholder="Paste your text here for analysis..." rows="6" required></textarea>
                            <small>Max 50,000 characters</small>
                        </div>

                        <div class="form-group">
                            <label for="analyze-type">Writing Type (Optional)</label>
                            <select id="analyze-type">
                                <option value="">Auto-detect</option>
                            </select>
                        </div>

                        <button type="button" class="btn" onclick="analyzeWriting()">
                            <i class="fas fa-search"></i> Analyze Writing
                        </button>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="showAnalyzeSection()">
                        <i class="fas fa-chart-line"></i> Analyze Existing Writing
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="panel">
            <div class="panel-header">
                <h2><i class="fas fa-file-alt"></i> Generated Content</h2>
                <p>Your AI-generated writing and analysis</p>
            </div>
            <div class="panel-content" id="results-content">
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-pen-alt" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                    <p>Select a writing type and generate content to see results here</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedWritingType = null;
        let keyPointCount = 1;
        let userStats = null;
        let categories = {};

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadWritingTypes();
            loadUserStats();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Category tab switching
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchCategory(this.dataset.category);
                });
            });

            // Form submission
            document.getElementById('writing-form').addEventListener('submit', function(e) {
                e.preventDefault();
                generateWriting();
            });
        }

        function switchCategory(categoryName) {
            // Update active tab
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-category="${categoryName}"]`).classList.add('active');

            // Update active content
            document.querySelectorAll('.category-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${categoryName}-content`).classList.add('active');

            // Hide form if no type selected
            if (selectedWritingType === null) {
                document.getElementById('writing-form').style.display = 'none';
            }
        }

        async function loadWritingTypes() {
            try {
                const response = await fetch('/api/writing/types');
                const data = await response.json();

                if (data.success) {
                    categories = data.categories;
                    
                    // Populate each category
                    Object.keys(categories).forEach(categoryKey => {
                        const category = categories[categoryKey];
                        const grid = document.getElementById(`${categoryKey}-grid`);
                        
                        grid.innerHTML = '';
                        category.types.forEach(type => {
                            const card = createWritingTypeCard(type);
                            grid.appendChild(card);
                        });
                    });

                    // Populate tone options (already done in HTML, but could be dynamic)
                    // Populate analyze type options
                    const analyzeSelect = document.getElementById('analyze-type');
                    Object.keys(categories).forEach(categoryKey => {
                        categories[categoryKey].types.forEach(type => {
                            const option = document.createElement('option');
                            option.value = type.value;
                            option.textContent = type.name;
                            analyzeSelect.appendChild(option);
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading writing types:', error);
            }
        }

        function createWritingTypeCard(type) {
            const card = document.createElement('div');
            card.className = 'writing-type-card';
            card.dataset.writingType = type.value;
            
            card.innerHTML = `
                <h4>${type.name}</h4>
                <p>${type.description}</p>
                <div class="writing-type-features">
                    ${type.features.map(feature => `<span class="feature-tag">${feature}</span>`).join('')}
                </div>
            `;
            
            card.addEventListener('click', function() {
                selectWritingType(type.value);
                
                // Update visual selection
                document.querySelectorAll('.writing-type-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
            });
            
            return card;
        }

        function selectWritingType(writingType) {
            selectedWritingType = writingType;
            document.getElementById('writing-form').style.display = 'block';
            document.getElementById('analyze-section').style.display = 'none';
            
            // Scroll to form
            document.getElementById('writing-form').scrollIntoView({ behavior: 'smooth' });
        }

        async function loadUserStats() {
            try {
                const response = await fetch('/api/writing/stats');
                const data = await response.json();

                if (data.success) {
                    userStats = data.stats;
                    updateUsageDisplay();
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function updateUsageDisplay() {
            if (!userStats) return;

            const usageInfo = document.getElementById('usage-info');
            const limit = userStats.daily_limit;
            const usage = userStats.current_usage;

            let html = `<strong>${userStats.user_plan.toUpperCase()} TIER</strong><br>`;
            
            if (limit === -1) {
                html += `Writing Generation: Unlimited (${usage} used today)`;
            } else {
                html += `Writing Generation: ${userStats.remaining_usage}/${limit} remaining today`;
            }

            usageInfo.innerHTML = html;
        }

        function addKeyPoint() {
            if (keyPointCount >= 10) {
                alert('Maximum 10 key points allowed');
                return;
            }
            
            keyPointCount++;
            const container = document.getElementById('key-points-container');
            const keyPoint = document.createElement('div');
            keyPoint.className = 'key-point';
            
            keyPoint.innerHTML = `
                <i class="fas fa-grip-vertical" style="color: #ccc;"></i>
                <input type="text" placeholder="Enter a key point...">
                <i class="fas fa-times remove-btn" onclick="removeKeyPoint(this)"></i>
            `;
            
            container.insertBefore(keyPoint, container.lastElementChild);
        }

        function removeKeyPoint(element) {
            if (keyPointCount <= 1) {
                alert('At least one key point is required');
                return;
            }
            
            keyPointCount--;
            element.parentElement.remove();
        }

        function getKeyPoints() {
            const inputs = document.querySelectorAll('.key-point input');
            const points = [];
            inputs.forEach(input => {
                if (input.value.trim()) {
                    points.push(input.value.trim());
                }
            });
            return points;
        }

        async function generateWriting() {
            if (!selectedWritingType) {
                alert('Please select a writing type first');
                return;
            }

            const btn = document.getElementById('generate-btn');
            const resultsContent = document.getElementById('results-content');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
            
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div>Generating your writing...</div>';

            try {
                const formData = new FormData(document.getElementById('writing-form'));
                const keyPoints = getKeyPoints();
                
                const data = {
                    writing_type: selectedWritingType,
                    topic: formData.get('topic'),
                    tone: formData.get('tone'),
                    length: formData.get('length'),
                    target_audience: formData.get('target_audience'),
                    key_points: keyPoints,
                    additional_requirements: formData.get('additional_requirements'),
                    save_title: formData.get('save_title')
                };

                const response = await fetch('/api/writing/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    displayWritingResult(result);
                    loadUserStats(); // Refresh usage
                } else {
                    showError(result.error);
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic"></i> Generate Writing';
        }

        function displayWritingResult(result) {
            const resultsContent = document.getElementById('results-content');
            const writing = result.writing;
            const prompt = result.prompt_details;
            
            let html = `
                <div class="success">✅ Writing generated successfully!</div>
                
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-value">${writing.word_count.toLocaleString()}</div>
                        <div class="stat-label">Words</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${writing.character_count.toLocaleString()}</div>
                        <div class="stat-label">Characters</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${writing.estimated_reading_time}</div>
                        <div class="stat-label">Min Read</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Math.round(writing.readability_score)}</div>
                        <div class="stat-label">Readability</div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4><i class="fas fa-info-circle"></i> Writing Details</h4>
                    <p><strong>Type:</strong> ${prompt.writing_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</p>
                    <p><strong>Tone:</strong> ${prompt.tone.replace(/\b\w/g, l => l.toUpperCase())}</p>
                    <p><strong>Length:</strong> ${prompt.length.replace(/\b\w/g, l => l.toUpperCase())}</p>
                    <p><strong>Audience:</strong> ${prompt.target_audience || 'General'}</p>
                </div>

                <div class="output-container">
                    <div class="output-content">${writing.content}</div>
                </div>
            `;

            if (writing.suggestions && writing.suggestions.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h4><i class="fas fa-lightbulb"></i> Suggestions for Improvement</h4>
                `;
                writing.suggestions.forEach(suggestion => {
                    html += `<div class="suggestion">${suggestion}</div>`;
                });
                html += '</div>';
            }

            html += `
                <div class="action-buttons">
                    <button class="btn" onclick="copyToClipboard(\`${writing.content.replace(/`/g, '\\`')}\`)">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                    <button class="btn" onclick="downloadAsText(\`${writing.content.replace(/`/g, '\\`')}\`, '${prompt.writing_type}')">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            `;
            
            resultsContent.innerHTML = html;
        }

        function showAnalyzeSection() {
            document.getElementById('writing-form').style.display = 'none';
            document.getElementById('analyze-section').style.display = 'block';
            
            // Clear selected writing type
            selectedWritingType = null;
            document.querySelectorAll('.writing-type-card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        async function analyzeWriting() {
            const content = document.getElementById('analyze-content').value;
            const writingType = document.getElementById('analyze-type').value;
            const resultsContent = document.getElementById('results-content');
            
            if (!content.trim()) {
                alert('Please enter some content to analyze');
                return;
            }
            
            resultsContent.innerHTML = '<div class="loading"><div class="spinner"></div>Analyzing your writing...</div>';

            try {
                const response = await fetch('/api/writing/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        writing_type: writingType
                    })
                });

                const result = await response.json();

                if (result.success) {
                    displayAnalysisResult(result.analysis);
                } else {
                    showError(result.error);
                }
            } catch (error) {
                showError('Network error: ' + error.message);
            }
        }

        function displayAnalysisResult(analysis) {
            const resultsContent = document.getElementById('results-content');
            
            let html = `
                <div class="success">✅ Analysis completed!</div>
                
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-value">${analysis.word_count.toLocaleString()}</div>
                        <div class="stat-label">Words</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${analysis.character_count.toLocaleString()}</div>
                        <div class="stat-label">Characters</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${analysis.estimated_reading_time}</div>
                        <div class="stat-label">Min Read</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Math.round(analysis.readability_score)}</div>
                        <div class="stat-label">Readability</div>
                    </div>
                </div>

                <div class="analysis-section">
                    <h4><i class="fas fa-chart-bar"></i> Structure Analysis</h4>
                    <p><strong>Paragraphs:</strong> ${analysis.structure_analysis.paragraph_count}</p>
                    <p><strong>Sentences:</strong> ${analysis.structure_analysis.sentence_count}</p>
                    <p><strong>Avg Sentence Length:</strong> ${analysis.structure_analysis.avg_sentence_length} words</p>
                    <p><strong>Style Score:</strong> ${Math.round(analysis.style_score * 100)}%</p>
                </div>
            `;

            if (analysis.format_analysis && Object.keys(analysis.format_analysis).length > 0) {
                html += `
                    <div class="analysis-section">
                        <h4><i class="fas fa-cogs"></i> Format Analysis</h4>
                `;
                Object.entries(analysis.format_analysis).forEach(([key, value]) => {
                    const label = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    html += `<p><strong>${label}:</strong> ${value}</p>`;
                });
                html += '</div>';
            }

            if (analysis.suggestions && analysis.suggestions.length > 0) {
                html += `
                    <div class="analysis-section">
                        <h4><i class="fas fa-lightbulb"></i> Improvement Suggestions</h4>
                `;
                analysis.suggestions.forEach(suggestion => {
                    html += `<div class="suggestion">${suggestion}</div>`;
                });
                html += '</div>';
            }
            
            resultsContent.innerHTML = html;
        }

        function showError(message) {
            const resultsContent = document.getElementById('results-content');
            resultsContent.innerHTML = `<div class="error">❌ ${message}</div>`;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Content copied to clipboard!');
            }).catch(() => {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Content copied to clipboard!');
            });
        }

        function downloadAsText(content, type) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${type}_${new Date().toISOString().slice(0,10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>