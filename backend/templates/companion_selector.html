<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Your Companion - SoulBridge AI</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <meta name="theme-color" content="#00ffff">
    
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v={{ range(1000000) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/companion_selector.css') }}?v={{ range(1000000) | random }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Trial Badge */
        .trial-badge {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #000;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            animation: pulse-gold 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
        }
        
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        
        /* Hide old timer elements to prevent conflicts - EXCLUDE NEW TIMER */
        #trialTimer, 
        #trialTimeDisplay,
        .trial-timer-old,
        .old-timer,
        [id*="trialTimer"],
        [id*="trialTimeDisplay"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
        
        /* PROTECT NEW TIMER - Override any hiding */
        #trial-timer-container,
        #trial-timer-container *,
        #timer-progress,
        #trial-time-text,
        .timer-glass-card {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            left: auto !important;
        }
        
        /* Except the container itself should be fixed positioned */
        #trial-timer-container {
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
        }
    </style>
</head>
<body>
    <!-- Back to Intro Button -->
    <a href="/intro" class="back-button" title="Back to Intro">
        ‚Üê Back to Intro
    </a>
    
    <!-- Trial Badge - Show when trial is active -->
    <span class="trial-badge" id="trial-badge" style="display: none;">
        üïê Trial Active
    </span>

    <!-- Advanced Trial Timer Widget -->
    <!-- üöÄ NEW Enhanced Trial Timer - Beautiful Modern Design -->
    <div id="trial-timer-container" style="display:none; position: fixed; top: 20px; right: 20px; z-index: 1500;">
        <div class="timer-glass-card">
            <div class="timer-glow-ring">
                <svg width="140" height="140" class="timer-svg">
                    <!-- Background ring -->
                    <circle cx="70" cy="70" r="60" stroke="rgba(0, 255, 255, 0.1)" stroke-width="4" fill="none"/>
                    <!-- Progress ring -->
                    <circle id="timer-progress" cx="70" cy="70" r="60" stroke="url(#timerGradient)" stroke-width="6" fill="none" 
                            stroke-dasharray="377" stroke-dashoffset="0" stroke-linecap="round"
                            style="transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;"/>
                    <!-- Gradient Definition -->
                    <defs>
                        <linearGradient id="timerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#00ffff"/>
                            <stop offset="50%" style="stop-color:#00cc88"/>
                            <stop offset="100%" style="stop-color:#0099ff"/>
                        </linearGradient>
                        <linearGradient id="warningGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ffaa00"/>
                            <stop offset="100%" style="stop-color:#ff8800"/>
                        </linearGradient>
                        <linearGradient id="criticalGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#ff4444"/>
                            <stop offset="100%" style="stop-color:#cc0000"/>
                        </linearGradient>
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge> 
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/> 
                            </feMerge>
                        </filter>
                    </defs>
                </svg>
                
                <!-- Timer Text Content -->
                <div class="timer-content">
                    <div id="trial-time-text" class="timer-display">5:00:00</div>
                    <div class="timer-label">TRIAL</div>
                    <div class="timer-status">Active</div>
                </div>
                
                <!-- Pulse Animation Ring -->
                <div class="pulse-ring"></div>
            </div>
        </div>
    </div>

    <style>
    /* üé® Beautiful Modern Timer Styles */
    .timer-glass-card {
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(15, 23, 42, 0.9) 100%);
        backdrop-filter: blur(20px);
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 20px;
        padding: 15px;
        box-shadow: 
            0 20px 40px rgba(0, 0, 0, 0.4),
            0 0 30px rgba(0, 255, 255, 0.2),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
        overflow: hidden;
    }

    .timer-glass-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: linear-gradient(90deg, transparent, rgba(0, 255, 255, 0.5), transparent);
    }

    .timer-glow-ring {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .timer-svg {
        filter: drop-shadow(0 0 10px rgba(0, 255, 255, 0.3));
        animation: timerRotate 20s linear infinite;
    }

    .timer-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 10;
    }

    .timer-display {
        font-size: 18px;
        font-weight: 700;
        color: #00ffff;
        text-shadow: 0 0 10px rgba(0, 255, 255, 0.8);
        margin-bottom: 2px;
        font-family: 'Courier New', monospace;
        letter-spacing: 1px;
    }

    .timer-label {
        font-size: 10px;
        font-weight: 600;
        color: rgba(0, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin-bottom: 1px;
    }

    .timer-status {
        font-size: 8px;
        color: #00cc88;
        font-weight: 500;
        opacity: 0.8;
        animation: statusPulse 2s ease-in-out infinite;
    }

    .pulse-ring {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 120px;
        height: 120px;
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 50%;
        transform: translate(-50%, -50%);
        animation: pulseRing 3s ease-in-out infinite;
        pointer-events: none;
    }

    /* üé¨ Smooth Animations */
    @keyframes timerRotate {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes pulseRing {
        0%, 100% { 
            opacity: 0.3; 
            transform: translate(-50%, -50%) scale(1); 
        }
        50% { 
            opacity: 0.1; 
            transform: translate(-50%, -50%) scale(1.1); 
        }
    }

    @keyframes statusPulse {
        0%, 100% { opacity: 0.6; }
        50% { opacity: 1; }
    }

    /* üéØ Responsive Design */
    @media (max-width: 768px) {
        #trial-timer-container {
            top: 15px;
            right: 15px;
            transform: scale(0.8);
            transform-origin: top right;
        }
        
        .timer-display {
            font-size: 14px;
        }
        
        .timer-svg {
            width: 120px;
            height: 120px;
        }
    }

    /* üåü Hover Effects */
    .timer-glass-card:hover {
        border-color: rgba(0, 255, 255, 0.6);
        box-shadow: 
            0 25px 50px rgba(0, 0, 0, 0.5),
            0 0 50px rgba(0, 255, 255, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
        transition: all 0.3s ease;
    }

    /* üö® Warning States */
    .timer-warning #timer-progress {
        stroke: url(#warningGradient) !important;
        animation: warningPulse 1s ease-in-out infinite;
    }

    .timer-critical #timer-progress {
        stroke: url(#criticalGradient) !important;
        animation: criticalPulse 0.5s ease-in-out infinite;
    }

    @keyframes warningPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    @keyframes criticalPulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
    </style>

    <!-- Main Content -->
    <div class="companion-selector">
        <div class="companion-header">
            <h1><i class="fas fa-robot"></i> Choose Your AI Companion</h1>
            <p>Select the perfect companion to guide you on your wellness journey</p>
        </div>

        <!-- Single Centralized Trial Button -->
        {% if not session.get('trial_used_permanently') and not session.get('trial_active') %}
        <div id="centralTrialOffer" class="central-trial-offer">
            <div class="trial-glow-effect"></div>
            <h3><i class="fas fa-star"></i> Unlock ALL Premium Companions</h3>
            <p>Get 5 hours of FREE access to Growth & Max tier companions</p>
            <div class="trial-features">
                <span><i class="fas fa-check"></i> Advanced AI personalities</span>
                <span><i class="fas fa-check"></i> Specialized therapy tools</span>
                <span><i class="fas fa-check"></i> Enhanced conversations</span>
            </div>
            <button id="startCentralTrial" class="btn-central-trial" onclick="startCentralTrial()">
                <i class="fas fa-rocket"></i>
                Start FREE 5-Hour Trial
            </button>
            <div class="trial-subtitle">No credit card required ‚Ä¢ Instant access</div>
        </div>
        {% endif %}
        
        <div class="companion-sections">
            <!-- Free Companions -->
            <div class="companion-section" id="free-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-heart"></i>
                        <span>Free Companions</span>
                        <span class="tier-badge tier-free">Free</span>
                    </div>
                </div>
                <div class="companions-scroll" id="free-companions">
                    <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 40px;">Loading companions...</p>
                </div>
            </div>
            
            
            <!-- Growth Companions -->
            <div class="companion-section" id="growth-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-seedling"></i>
                        <span>Growth Companions</span>
                        <span class="tier-badge tier-growth">Growth</span>
                    </div>
                </div>
                <div class="companions-scroll" id="growth-companions">
                    <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 40px;">Loading companions...</p>
                </div>
            </div>
            
            <!-- Max Companions -->
            <div class="companion-section" id="max-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-crown"></i>
                        <span>Max Companions</span>
                        <span class="tier-badge tier-max">Max</span>
                    </div>
                </div>
                <div class="companions-scroll" id="max-companions">
                    <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 40px;">Loading companions...</p>
                </div>
            </div>
            
            <!-- Referral Companions -->
            <div class="companion-section" id="referral-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-users"></i>
                        <span>Referral Companions</span>
                        <span class="tier-badge tier-referral">Referral</span>
                    </div>
                </div>
                <div class="companions-scroll" id="referral-companions">
                    <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 40px;">Loading companions...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Companion Details Modal -->
    <div class="companion-modal" id="companionModal" style="display: none;">
        <div class="modal-overlay" onclick="closeCompanionModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalCompanionName">Companion Details</h2>
                <button class="close-btn" onclick="closeCompanionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="companion-preview">
                    <img id="modalCompanionAvatar" src="" alt="Companion Avatar" class="modal-avatar">
                    <div class="companion-details">
                        <p id="modalCompanionBio"></p>
                        <div class="companion-tier" id="modalCompanionTier"></div>
                    </div>
                </div>
                
                <div class="upgrade-section" id="upgradeSection">
                    <h3>Unlock This Companion</h3>
                    <div class="plan-options">
                        <div class="plan-card growth-plan" onclick="selectUpgradePlan('growth')">
                            <div class="plan-header">
                                <span class="plan-name">Growth Plan</span>
                                <span class="plan-price">$12.99/month</span>
                            </div>
                            <p>Access to Growth companions and premium features</p>
                        </div>
                        
                        <div class="plan-card max-plan" onclick="selectUpgradePlan('max')">
                            <div class="plan-header">
                                <span class="plan-name">Max Plan</span>
                                <span class="plan-price">$19.99/month</span>
                            </div>
                            <p>All companions, advanced AI, and premium features</p>
                            <div class="recommended-badge">Most Popular</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // If not flagged in sessionStorage, log out immediately
        console.log('üîç Checking sessionStorage loggedIn flag:', sessionStorage.getItem('loggedIn'));
        if (!sessionStorage.getItem('loggedIn')) {
            console.log('‚ùå No sessionStorage flag - redirecting to login');
            fetch('/auth/logout').then(() => window.location = '/login');
        } else {
            console.log('‚úÖ sessionStorage flag found - allowing page to load');
        }
        
        // Forcibly remove any old timer elements that might appear
        function removeOldTimerElements() {
            const oldTimers = [
                'trialTimer',
                'trialTimeDisplay', 
                'trial-timer-old',
                'old-timer'
            ];
            
            oldTimers.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log('üóëÔ∏è Removing old timer element:', id);
                    element.remove();
                }
            });
            
            // Remove any elements with old timer classes
            const oldTimerClasses = document.querySelectorAll('.trial-timer-old, .old-timer');
            oldTimerClasses.forEach(el => {
                console.log('üóëÔ∏è Removing old timer class element');
                el.remove();
            });
        }
        
        // Run removal on page load only - DISABLED interval to prevent flickering
        document.addEventListener('DOMContentLoaded', removeOldTimerElements);
        // DISABLED: setInterval(removeOldTimerElements, 500); // Causing flickering
        
        // Use MutationObserver to catch dynamically created old timer elements
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        // Check if the added node is an old timer
                        if (node.id === 'trialTimer' || node.id === 'trialTimeDisplay' || 
                            node.className?.includes('trial-timer-old') ||
                            node.className?.includes('old-timer')) {
                            console.log('üö´ MutationObserver: Removing dynamically created old timer:', node.id || node.className);
                            node.remove();
                        }
                        
                        // Check child nodes for old timers
                        const oldTimerChildren = node.querySelectorAll('#trialTimer, #trialTimeDisplay, .trial-timer-old, .old-timer');
                        oldTimerChildren.forEach(el => {
                            console.log('üö´ MutationObserver: Removing old timer child element');
                            el.remove();
                        });
                    }
                });
            });
        });
        
        // Start observing
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
        
        // AGGRESSIVE DEBUGGING: Override createElement to catch old timer creation
        const originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
            const element = originalCreateElement.call(this, tagName);
            
            // Set up a watcher for when ID gets set
            const originalSetAttribute = element.setAttribute;
            element.setAttribute = function(name, value) {
                if (name === 'id' && (value === 'trialTimer' || value === 'trialTimeDisplay')) {
                    console.error('üö® CAUGHT OLD TIMER CREATION!', {
                        id: value,
                        tagName: tagName,
                        stack: new Error().stack
                    });
                    // Don't actually set the ID - block it!
                    return;
                }
                return originalSetAttribute.call(this, name, value);
            };
            
            // Also watch for direct id property assignment
            let originalId = element.id;
            Object.defineProperty(element, 'id', {
                get() { return originalId; },
                set(value) {
                    if (value === 'trialTimer' || value === 'trialTimeDisplay') {
                        console.error('üö® CAUGHT OLD TIMER ID ASSIGNMENT!', {
                            id: value,
                            tagName: tagName,
                            stack: new Error().stack
                        });
                        // Don't actually set the ID - block it!
                        return;
                    }
                    originalId = value;
                }
            });
            
            return element;
        };
        
        // DISABLED AGGRESSIVE MONITORING - was causing console spam
        // Old timer monitoring disabled to prevent performance issues
        
        // ULTRA AGGRESSIVE: Nuke any element that LOOKS like old timer
        function destroySuspiciousElements() {
            // Find elements by various criteria
            const suspiciousElements = document.querySelectorAll('div, span');
            
            suspiciousElements.forEach(el => {
                const style = el.style.cssText || '';
                const computed = window.getComputedStyle(el);
                
                // Check if it looks like old timer
                const looksLikeOldTimer = (
                    style.includes('gradient') && style.includes('#FF6B6B') ||
                    style.includes('position: fixed') && style.includes('top: 20px') ||
                    computed.background.includes('rgb(255, 107, 107)') ||
                    el.textContent.includes(':') && el.textContent.match(/\d+:\d+/) ||
                    computed.position === 'fixed' && computed.top === '20px' && computed.left.includes('%')
                );
                
                // Be more careful not to destroy the NEW timer
                const isNewTimer = (
                    el.id === 'trial-timer-container' ||
                    el.id === 'timer-progress' ||
                    el.id === 'trial-time-text' ||
                    el.classList.contains('trial-badge') ||
                    el.classList.contains('timer-glass-card') ||
                    el.classList.contains('timer-glow-ring') ||
                    el.classList.contains('timer-content') ||
                    el.classList.contains('timer-display') ||
                    el.parentElement?.id === 'trial-timer-container' ||
                    el.closest('#trial-timer-container')
                );
                
                if (looksLikeOldTimer && !isNewTimer) {
                    console.warn('üî• DESTROYING suspicious element:', {
                        element: el,
                        id: el.id,
                        className: el.className,
                        style: style,
                        textContent: el.textContent,
                        computed: {
                            position: computed.position,
                            top: computed.top,
                            left: computed.left,
                            background: computed.background
                        }
                    });
                    el.remove();
                }
            });
        }
        
        // DISABLED ALL AGGRESSIVE ELEMENT REMOVAL - was causing console spam and performance issues
        // destroySuspiciousElements(); // Disabled to prevent interference with new timer
        
        // DISABLED DEBUG: Timer visibility check - was causing flickering
        // Timer debug check disabled to prevent interference
        
        // DISABLED getElementById override - was causing console spam
        // getElementById override disabled to prevent interference
    </script>
    
    <!-- DISABLED NUCLEAR DESTROYER - was causing console spam -->
    <script>
    // Disabled aggressive timer removal to prevent console spam
    // setInterval(() => { ... }, 200); // DISABLED
    
    // Initial debug check
    console.log("Searching for old timer...");
    const oldTimer = document.getElementById("trialTimer");
    if (oldTimer) {
        console.warn("‚ùå OLD TIMER FOUND:", oldTimer);
        console.log("Created by:", oldTimer.outerHTML);
        oldTimer.remove();
    } else {
        console.log("‚úÖ No old timer found in DOM.");
    }
    </script>
    
    <!-- DISABLED FINAL FIX - was causing console spam -->
    <script>
    // Disabled all aggressive interval timers to prevent console spam and performance issues
    // All old timer removal scripts have been disabled
    </script>
    
    <!-- Enhanced Timer System Functions -->
    <script>
        // Enhanced Timer Update Function
        function updateEnhancedTimer(remainingMs) {
            console.log('üéØ Updating timer with remaining ms:', remainingMs);
            
            // FIRST: Remove any duplicate or conflicting timer elements
            const allTimerContainers = document.querySelectorAll('[id*="timer"], [class*="timer"]');
            console.log('üîç All timer-related elements found:', allTimerContainers.length);
            
            allTimerContainers.forEach((el, index) => {
                if (el.id !== 'trial-timer-container' && 
                    el.id !== 'timer-progress' && 
                    el.id !== 'trial-time-text' &&
                    !el.classList.contains('timer-glass-card') &&
                    !el.closest('#trial-timer-container')) {
                    console.log(`üóëÔ∏è Removing conflicting timer element ${index}:`, el.id || el.className);
                    el.remove();
                }
            });
            
            const timerContainer = document.getElementById('trial-timer-container');
            const timeText = document.getElementById('trial-time-text');
            const progressCircle = document.getElementById('timer-progress');
            const timerCard = document.querySelector('.timer-glass-card');
            
            console.log('üîç Timer elements found:', {
                timerContainer: !!timerContainer,
                timeText: !!timeText,
                progressCircle: !!progressCircle,
                timerCard: !!timerCard
            });
            
            if (!timerContainer || !timeText || !progressCircle) {
                console.log('‚ùå Timer elements not found - cannot update timer');
                return;
            }
            
            // ENSURE only one progress circle exists
            const allProgressCircles = document.querySelectorAll('#timer-progress, circle[id*="progress"], circle[class*="progress"]');
            if (allProgressCircles.length > 1) {
                console.log(`üö® Multiple progress circles found (${allProgressCircles.length}), removing extras`);
                allProgressCircles.forEach((circle, index) => {
                    if (index > 0) { // Keep only the first one
                        circle.remove();
                    }
                });
            }
            
            if (remainingMs <= 0) {
                timerContainer.style.display = 'none';
                return;
            }
            
            // Show timer
            timerContainer.style.display = 'block';
            
            // Calculate time components
            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);
            
            // Update display
            timeText.textContent = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Calculate progress (5 hours = 18000000ms)
            const totalTrialMs = 5 * 60 * 60 * 1000; // 5 hours in milliseconds
            const progressPercent = (remainingMs / totalTrialMs) * 100;
            const circumference = 2 * Math.PI * 60; // radius = 60
            const strokeDashoffset = circumference * (1 - progressPercent / 100);
            
            progressCircle.style.strokeDashoffset = strokeDashoffset;
            
            // Add warning states
            timerCard.classList.remove('timer-warning', 'timer-critical');
            
            if (remainingMs < 600000) { // Less than 10 minutes
                timerCard.classList.add('timer-critical');
            } else if (remainingMs < 1800000) { // Less than 30 minutes
                timerCard.classList.add('timer-warning');
            }
        }

        // Real-time timer variables
        let trialEndTime = null;
        let timerInterval = null;

        // Real-time timer update (runs every second)
        function updateTimerDisplay() {
            if (!trialEndTime) return;
            
            const now = Date.now();
            const remainingMs = trialEndTime - now;
            
            if (remainingMs <= 0) {
                // Timer expired
                const timerContainer = document.getElementById('trial-timer-container');
                if (timerContainer) timerContainer.style.display = 'none';
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                return;
            }
            
            // Update timer display
            updateEnhancedTimer(remainingMs);
        }

        // Start real-time timer
        function startRealTimeTimer(remainingMs) {
            // Set end time
            trialEndTime = Date.now() + remainingMs;
            
            // Clear any existing interval
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            
            // Start updating every second
            timerInterval = setInterval(updateTimerDisplay, 1000);
            
            // Update immediately
            updateTimerDisplay();
        }

        // Check trial status and update timer
        async function refreshTrialStatus() {
            try {
                console.log('üîç Checking trial status...');
                const response = await fetch('/api/user-info');
                const data = await response.json();
                
                console.log('üîç Trial status data:', {
                    success: data.success,
                    trial_active: data.trial_active,
                    trial_remaining: data.trial_remaining,
                    user_plan: data.user_plan
                });
                
                if (data.success && data.trial_active && data.trial_remaining > 0) {
                    console.log('‚úÖ Trial active - starting real-time timer');
                    startRealTimeTimer(data.trial_remaining);
                } else {
                    console.log('‚ùå No trial active - hiding timer');
                    // Clear timer interval
                    if (timerInterval) {
                        clearInterval(timerInterval);
                        timerInterval = null;
                    }
                    trialEndTime = null;
                    
                    // Hide timer container
                    const timerContainer = document.getElementById('trial-timer-container');
                    if (timerContainer) {
                        timerContainer.style.display = 'none';
                        console.log('üîß Timer container hidden');
                    } else {
                        console.log('‚ö†Ô∏è Timer container not found!');
                    }
                }
            } catch (error) {
                console.error('Error checking trial status:', error);
            }
        }

        // Force show timer for testing (you can call this in console)
        window.forceShowTimer = function() {
            const timerContainer = document.getElementById('trial-timer-container');
            if (timerContainer) {
                timerContainer.style.display = 'block';
                console.log('üîß Timer force shown');
            } else {
                console.log('‚ùå Timer container not found!');
            }
        };

        // Clean up all timer conflicts (call this in console if needed)
        window.cleanTimers = function() {
            console.log('üßπ Starting timer cleanup...');
            
            // Remove ALL timer elements except our specific ones
            const allElements = document.querySelectorAll('*');
            let removed = 0;
            
            allElements.forEach(el => {
                const isOldTimer = (
                    el.id && (el.id.includes('trial') || el.id.includes('timer')) && 
                    el.id !== 'trial-timer-container' && 
                    el.id !== 'timer-progress' && 
                    el.id !== 'trial-time-text'
                ) || (
                    el.className && (el.className.includes('trial') || el.className.includes('timer')) &&
                    !el.classList.contains('timer-glass-card') &&
                    !el.classList.contains('timer-glow-ring') &&
                    !el.classList.contains('timer-content') &&
                    !el.classList.contains('timer-display') &&
                    !el.classList.contains('trial-badge')
                );
                
                if (isOldTimer && !el.closest('#trial-timer-container')) {
                    console.log('üóëÔ∏è Removing:', el.id || el.className);
                    el.remove();
                    removed++;
                }
            });
            
            console.log(`üßπ Cleanup complete. Removed ${removed} elements.`);
            
            // Force refresh the timer
            refreshTrialStatus();
        };

        // Debug function to inspect timer elements
        window.debugTimer = function() {
            console.log('üîç TIMER DEBUG - All timer-related elements:');
            
            // Find all elements with timer-related IDs or classes
            const allTimerElements = document.querySelectorAll('[id*="timer"], [class*="timer"], svg, circle');
            
            allTimerElements.forEach((el, index) => {
                console.log(`Element ${index}:`, {
                    tagName: el.tagName,
                    id: el.id,
                    className: el.className,
                    visible: el.offsetWidth > 0 && el.offsetHeight > 0,
                    parent: el.parentElement?.id || el.parentElement?.className,
                    innerHTML: el.innerHTML?.substring(0, 100) + '...'
                });
            });
            
            // Specifically check for multiple progress circles
            const progressCircles = document.querySelectorAll('#timer-progress, circle');
            console.log(`üéØ Found ${progressCircles.length} circles/progress elements`);
            
            progressCircles.forEach((circle, index) => {
                console.log(`Circle ${index}:`, {
                    id: circle.id,
                    cx: circle.getAttribute('cx'),
                    cy: circle.getAttribute('cy'),
                    r: circle.getAttribute('r'),
                    stroke: circle.getAttribute('stroke'),
                    visible: circle.offsetWidth > 0
                });
            });
        };

        // Initialize timer on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded - initializing timer...');
            
            // Debug timer elements first
            setTimeout(() => {
                debugTimer();
            }, 2000);
            
            refreshTrialStatus();
            
            // Refresh every 2 minutes (since we now have real-time updates)
            setInterval(refreshTrialStatus, 120000);
            
            // Debug: Log timer container status
            setTimeout(() => {
                const container = document.getElementById('trial-timer-container');
                console.log('üîç Timer container check:', {
                    exists: !!container,
                    display: container?.style.display,
                    visible: container?.offsetWidth > 0
                });
            }, 1000);
        });
    </script>
    
    <script src="{{ url_for('static', filename='js/companion_selector.js') }}?v={{ range(1000000) | random }}"></script>
</body>
</html>