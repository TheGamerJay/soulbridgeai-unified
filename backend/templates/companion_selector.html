<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choose Your Companion - SoulBridge AI</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <meta name="theme-color" content="#00ffff">
    
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v={{ range(1000000) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/companion_selector.css') }}?v={{ range(1000000) | random }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* Trial Badge */
        .trial-badge {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #000;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            animation: pulse-gold 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
            position: fixed;
            top: 80px;
            left: 20px;
            z-index: 1000;
        }
        
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }
        
        /* Hide old timer elements to prevent conflicts */
        #trialTimer, 
        #trialTimeDisplay,
        .trial-timer-old,
        .old-timer,
        [id*="trialTimer"],
        [id*="trialTimeDisplay"],
        [class*="trial-timer"]:not(.trial-badge),
        [id*="trial-timer"]:not(#trial-timer-container):not(#trial-timer-circle):not(#trial-time-text) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
        }
    </style>
</head>
<body>
    <!-- Back to Intro Button -->
    <a href="/intro" class="back-button" title="Back to Intro">
        ‚Üê Back to Intro
    </a>
    
    <!-- Trial Badge - Show when trial is active -->
    <span class="trial-badge" id="trial-badge" style="display: none;">
        üïê Trial Active
    </span>

    <!-- Advanced Trial Timer Widget -->
    <div id="trial-timer-container" style="display:none; position: fixed; top: 20px; right: 20px; z-index: 1500; background: rgba(0,0,0,0.9); padding: 15px; border-radius: 15px; border: 2px solid #00cc66;">
        <svg id="trial-timer-circle" width="120" height="120">
            <circle cx="60" cy="60" r="54" stroke="#333" stroke-width="8" fill="none"/>
            <circle id="timer-progress" cx="60" cy="60" r="54" stroke="#00cc66" stroke-width="8" fill="none" stroke-dasharray="339.29" stroke-dashoffset="0" transform="rotate(-90 60 60)"/>
        </svg>
        <div id="trial-time-text" style="font-size: 18px; margin-top: 10px; text-align: center; color: white; font-weight: bold;">5:00:00</div>
    </div>

    <!-- Main Content -->
    <div class="companion-selector">
        <div class="companion-header">
            <h1><i class="fas fa-robot"></i> Choose Your AI Companion</h1>
            <p>Select the perfect companion to guide you on your wellness journey</p>
        </div>

        <!-- Single Centralized Trial Button -->
        {% if not session.get('trial_used_permanently') and not session.get('trial_active') %}
        <div id="centralTrialOffer" class="central-trial-offer">
            <div class="trial-glow-effect"></div>
            <h3><i class="fas fa-star"></i> Unlock ALL Premium Companions</h3>
            <p>Get 5 hours of FREE access to Growth & Max tier companions</p>
            <div class="trial-features">
                <span><i class="fas fa-check"></i> Advanced AI personalities</span>
                <span><i class="fas fa-check"></i> Specialized therapy tools</span>
                <span><i class="fas fa-check"></i> Enhanced conversations</span>
            </div>
            <button id="startCentralTrial" class="btn-central-trial" onclick="startCentralTrial()">
                <i class="fas fa-rocket"></i>
                Start FREE 5-Hour Trial
            </button>
            <div class="trial-subtitle">No credit card required ‚Ä¢ Instant access</div>
        </div>
        {% endif %}
        
        <div class="companion-sections">
            <!-- Free Companions -->
            <div class="companion-section" id="free-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-heart"></i>
                        <span>Free Companions</span>
                        <span class="tier-badge tier-free">Free</span>
                    </div>
                </div>
                <div class="companions-scroll" id="free-companions">
                    <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 40px;">Loading companions...</p>
                </div>
            </div>
            
            
            <!-- Growth Companions -->
            <div class="companion-section" id="growth-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-seedling"></i>
                        <span>Growth Companions</span>
                        <span class="tier-badge tier-growth">Growth</span>
                    </div>
                </div>
                <div class="companions-scroll" id="growth-companions">
                    <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 40px;">Loading companions...</p>
                </div>
            </div>
            
            <!-- Max Companions -->
            <div class="companion-section" id="max-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-crown"></i>
                        <span>Max Companions</span>
                        <span class="tier-badge tier-max">Max</span>
                    </div>
                </div>
                <div class="companions-scroll" id="max-companions">
                    <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 40px;">Loading companions...</p>
                </div>
            </div>
            
            <!-- Referral Companions -->
            <div class="companion-section" id="referral-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-users"></i>
                        <span>Referral Companions</span>
                        <span class="tier-badge tier-referral">Referral</span>
                    </div>
                </div>
                <div class="companions-scroll" id="referral-companions">
                    <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 40px;">Loading companions...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Companion Details Modal -->
    <div class="companion-modal" id="companionModal" style="display: none;">
        <div class="modal-overlay" onclick="closeCompanionModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalCompanionName">Companion Details</h2>
                <button class="close-btn" onclick="closeCompanionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="companion-preview">
                    <img id="modalCompanionAvatar" src="" alt="Companion Avatar" class="modal-avatar">
                    <div class="companion-details">
                        <p id="modalCompanionBio"></p>
                        <div class="companion-tier" id="modalCompanionTier"></div>
                    </div>
                </div>
                
                <div class="upgrade-section" id="upgradeSection">
                    <h3>Unlock This Companion</h3>
                    <div class="plan-options">
                        <div class="plan-card growth-plan" onclick="selectUpgradePlan('growth')">
                            <div class="plan-header">
                                <span class="plan-name">Growth Plan</span>
                                <span class="plan-price">$12.99/month</span>
                            </div>
                            <p>Access to Growth companions and premium features</p>
                        </div>
                        
                        <div class="plan-card max-plan" onclick="selectUpgradePlan('max')">
                            <div class="plan-header">
                                <span class="plan-name">Max Plan</span>
                                <span class="plan-price">$19.99/month</span>
                            </div>
                            <p>All companions, advanced AI, and premium features</p>
                            <div class="recommended-badge">Most Popular</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // If not flagged in sessionStorage, log out immediately
        console.log('üîç Checking sessionStorage loggedIn flag:', sessionStorage.getItem('loggedIn'));
        if (!sessionStorage.getItem('loggedIn')) {
            console.log('‚ùå No sessionStorage flag - redirecting to login');
            fetch('/auth/logout').then(() => window.location = '/login');
        } else {
            console.log('‚úÖ sessionStorage flag found - allowing page to load');
        }
        
        // Forcibly remove any old timer elements that might appear
        function removeOldTimerElements() {
            const oldTimers = [
                'trialTimer',
                'trialTimeDisplay', 
                'trial-timer-old',
                'old-timer'
            ];
            
            oldTimers.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log('üóëÔ∏è Removing old timer element:', id);
                    element.remove();
                }
            });
            
            // Remove any elements with old timer classes
            const oldTimerClasses = document.querySelectorAll('.trial-timer-old, .old-timer');
            oldTimerClasses.forEach(el => {
                console.log('üóëÔ∏è Removing old timer class element');
                el.remove();
            });
        }
        
        // Run removal on page load and periodically to catch dynamic elements
        document.addEventListener('DOMContentLoaded', removeOldTimerElements);
        setInterval(removeOldTimerElements, 500); // Check every 500ms
        
        // Use MutationObserver to catch dynamically created old timer elements
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                        // Check if the added node is an old timer
                        if (node.id === 'trialTimer' || node.id === 'trialTimeDisplay' || 
                            node.className?.includes('trial-timer-old') ||
                            node.className?.includes('old-timer')) {
                            console.log('üö´ MutationObserver: Removing dynamically created old timer:', node.id || node.className);
                            node.remove();
                        }
                        
                        // Check child nodes for old timers
                        const oldTimerChildren = node.querySelectorAll('#trialTimer, #trialTimeDisplay, .trial-timer-old, .old-timer');
                        oldTimerChildren.forEach(el => {
                            console.log('üö´ MutationObserver: Removing old timer child element');
                            el.remove();
                        });
                    }
                });
            });
        });
        
        // Start observing
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
    <script src="{{ url_for('static', filename='js/companion_selector.js') }}?v={{ range(1000000) | random }}"></script>
</body>
</html>