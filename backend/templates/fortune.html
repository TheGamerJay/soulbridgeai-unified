<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SoulBridge AI - Mystical Tarot Reading</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Inter:wght@300;400;500&display=swap');
        
        :root {
            --gap: 14px;
            --card-w: 180px;
            --card-h: 300px;
            --radius: 12px;
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --dark: #1e1b4b;
            --darker: #0f0c29;
            --light: #f8fafc;
            --text-light: #e2e8f0;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            color: var(--text-light);
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #24184f 100%);
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        header {
            padding: 24px;
            background: rgba(30, 27, 75, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
            text-align: center;
        }
        
        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.5);
        }
        
        .subtitle {
            font-style: italic;
            color: var(--text-light);
            opacity: 0.8;
            margin-top: 8px;
            font-size: 1.1rem;
        }
        
        main {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .character-intro {
            background: rgba(30, 27, 75, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .character-intro h2 {
            font-family: 'Cinzel', serif;
            color: var(--accent);
            margin: 0 0 12px 0;
            font-size: 1.5rem;
        }
        
        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: end;
            margin-bottom: 24px;
        }
        
        .panel {
            background: rgba(30, 27, 75, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
        }
        
        label {
            color: var(--text-light);
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }
        
        select, input[type="text"], input[type="number"] {
            padding: 10px 12px;
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 8px;
            background: rgba(15, 12, 41, 0.8);
            color: var(--text-light);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        button {
            padding: 12px 24px;
            border: 0;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        button:disabled {
            opacity: .6;
            cursor: not-allowed;
            transform: none;
        }
        
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(var(--card-w), 1fr));
            gap: var(--gap);
            margin-top: 20px;
        }
        
        .card3d {
            width: var(--card-w);
            height: var(--card-h);
            perspective: 1000px;
            margin: 0 auto;
        }
        
        .inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform .7s ease;
            transform-style: preserve-3d;
            border-radius: var(--radius);
        }
        
        .flipped .inner {
            transform: rotateY(180deg);
        }
        
        .face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(245, 158, 11, 0.4);
        }
        
        .face img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .back {
            transform: rotateY(180deg);
        }
        
        .meta {
            margin-top: 12px;
            font-size: 14px;
            background: rgba(30, 27, 75, 0.6);
            backdrop-filter: blur(8px);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-right: 8px;
            margin-bottom: 4px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .sym {
            color: #94a3b8;
            font-size: 13px;
        }
        
        .pos {
            font-weight: 600;
        }
        
        details {
            background: rgba(30, 27, 75, 0.4);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 8px 10px;
            margin-top: 8px;
        }
        
        footer {
            color: #94a3b8;
            font-size: 12px;
            padding: 20px;
            text-align: center;
        }
        
        .usage-info {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .cards {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            
            :root {
                --card-w: 140px;
                --card-h: 240px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>✨ SoulBridge AI ✨</h1>
        <div class="subtitle">Mystical Tarot Reading Experience</div>
    </header>
    <main>
        <div class="character-intro">
            <h2 style="display: flex; align-items: center; gap: 12px; justify-content: center;">
                <img src="/static/logos/Fortune Teller Sky.png" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--accent); box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);" alt="Fortune Teller Sky">
                Welcome, seeker of wisdom
            </h2>
            <p>I am your spiritual guide, here to illuminate the path ahead through the ancient art of tarot. The cards hold profound insights waiting to be revealed. Let me draw the sacred cards and interpret their mystical messages for you...</p>
            <p><em>Choose your spread, focus your intention, and let the universe speak through the cards.</em></p>
        </div>
        
        <div id="usage-info" class="usage-info">
            Loading usage limits...
        </div>
        
        <div class="row">
            <div class="panel">
                <label>Spread 
                    <select id="spread">
                        <option value="one">1 Card - Quick Guidance</option>
                        <option value="three" selected>3 Card - Past, Present, Future</option>
                        <option value="five">5 Card - Comprehensive Reading</option>
                        <option value="celtic">Celtic Cross - Full Analysis</option>
                        <option value="grand">21 Card - Grand Life Spread</option>
                    </select>
                </label>
            </div>
            <div class="panel">
                <label><input type="checkbox" id="reversals" checked /> Include reversals</label>
            </div>
            <div class="panel">
                <label><input type="checkbox" id="interpretation" checked /> AI Interpretation</label>
            </div>
            <div class="panel">
                <button id="draw">🔮 Draw Cards</button>
            </div>
        </div>
        <div id="reading"></div>
    </main>
    <footer>Click cards to flip them. Your readings are powered by the full 78-card tarot deck with authentic meanings.</footer>

    <script>
        const API = "/api/fortune";
        const IMG_BASE = "/static/tarot/";
        const BACK_IMG = IMG_BASE + "back.png";

        function cardUrl(slug) {
            return IMG_BASE + slug + ".png";
        }

        async function loadUsageLimits() {
            try {
                const response = await fetch(API + "/limits");
                const data = await response.json();
                
                if (data.success) {
                    const usageInfo = document.getElementById('usage-info');
                    if (data.unlimited) {
                        usageInfo.innerHTML = '⭐ Unlimited fortune readings available';
                        usageInfo.style.background = 'rgba(34, 197, 94, 0.1)';
                        usageInfo.style.borderColor = 'rgba(34, 197, 94, 0.3)';
                    } else {
                        const remaining = data.remaining || 0;
                        usageInfo.innerHTML = `🔮 ${remaining} fortune readings remaining today (${data.usage_today}/${data.daily_limit} used)`;
                        
                        if (remaining === 0) {
                            usageInfo.style.background = 'rgba(239, 68, 68, 0.1)';
                            usageInfo.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                            document.getElementById('draw').disabled = true;
                            document.getElementById('draw').textContent = '🔮 Daily Limit Reached';
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load usage limits:', error);
                document.getElementById('usage-info').innerHTML = '🔮 Ready for your fortune reading';
            }
        }

        function cardHtml(item) {
            const rev = item.orientation === "Reversed";
            const flipClass = "card3d" + (rev ? " flipped" : "");
            const front = cardUrl(item.slug);
            const back = BACK_IMG;
            
            return `<div class="panel" style="padding:12px">
                <div class="${flipClass}" onclick="this.classList.toggle('flipped')">
                    <div class="inner">
                        <div class="face front"><img src="${front}" onerror="this.src='${back}'" alt="${item.card}" /></div>
                        <div class="face back"><img src="${back}" alt="Back" /></div>
                    </div>
                </div>
                <div class="meta">
                    <span class="badge">${item.position}</span>
                    <span class="badge">${item.orientation}</span>
                    <div><strong>${item.card}</strong></div>
                    <div class="grid">
                        <div>${item.meaning}</div>
                        ${item.symbols ? `<div class="sym"><strong>Symbols:</strong> ${item.symbols}</div>` : ""}
                    </div>
                </div>
            </div>`;
        }

        async function draw() {
            const button = document.getElementById('draw');
            const originalText = button.textContent;
            button.disabled = true;
            button.textContent = '🔮 Drawing Cards...';
            
            try {
                const spread = document.getElementById("spread").value;
                const reversals = document.getElementById("reversals").checked;
                const interpretation = document.getElementById("interpretation").checked;
                
                const body = { 
                    spread_type: spread,
                    reversals, 
                    interpretation,
                    question: "General guidance" 
                };
                
                const response = await fetch(API + "/reading", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                const wrap = document.getElementById("reading");
                
                if (data.error) {
                    wrap.innerHTML = `<div class="panel" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);"><p style='color:#ef4444'>${data.error}</p></div>`;
                    return;
                }
                
                if (!data.success) {
                    wrap.innerHTML = `<div class="panel" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);"><p style='color:#ef4444'>Reading failed. Please try again.</p></div>`;
                    return;
                }
                
                let html = `<div class="panel">
                    <div><strong>${data.spread}</strong> • ${data.reversals ? "Reversals On" : "Reversals Off"} • ${data.timestamp}</div>
                </div>
                <div class="cards">${data.cards.map(cardHtml).join("")}</div>`;
                
                // Add AI interpretation if available
                if (data.interpretation) {
                    html += `<div class="panel" style="margin-top: 24px; background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); backdrop-filter: blur(12px);">
                        <h3 style="color: var(--accent); margin-top: 0; font-family: 'Cinzel', serif; display: flex; align-items: center; gap: 12px;">
                            <img src="/static/logos/Fortune Teller Sky.png" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);" alt="Fortune Teller"> 
                            <span>Your Personal Reading</span>
                        </h3>
                        <div style="line-height: 1.7; color: var(--text-light); font-size: 16px; font-style: italic;">${data.interpretation.replace(/\n/g, '<br>')}</div>
                    </div>`;
                }
                
                wrap.innerHTML = html;
                
                // Refresh usage limits
                loadUsageLimits();
                
            } catch (error) {
                console.error('Reading error:', error);
                document.getElementById("reading").innerHTML = `<div class="panel" style="background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3);"><p style='color:#ef4444'>Connection error. Please try again.</p></div>`;
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }

        document.getElementById("draw").addEventListener("click", draw);
        loadUsageLimits();
    </script>
</body>
</html>