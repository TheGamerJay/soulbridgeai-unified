<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulBridge AI - {{ user_plan.title() }} Tier</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            font-family: system-ui, -apple-system, sans-serif;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">Loading SoulBridge AI...</div>
    </div>
    
    <!-- Pass data from Flask to React -->
    <script>
        window.APP_DATA = {
            userPlan: "{{ user_plan }}",
            trialActive: {{ 'true' if trial_active else 'false' }},
            companionInfo: {
                name: "{{ ai_character_name or companion_info.name if companion_info else 'GamerJay' }}",
                image: "{{ companion_avatar or companion_info.image_url if companion_info else '/static/logos/GamerJay_Free_companion.png' }}",
                greeting: "{{ (companion_info.greeting if companion_info and companion_info.greeting else 'Hey there! Ready to explore some features together?') | safe }}"
            }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const Send = window.lucide?.Send || (() => React.createElement('span', {}, 'â†’'));

        function UnifiedChatPage({ userPlan = "bronze", trialActive = false }) {
          // Get companion info from backend data
          const companion = window.APP_DATA?.companionInfo || {
            name: "GamerJay",
            image: "/static/logos/GamerJay_Free_companion.png", 
            greeting: "Hey there! Ready to explore some features together?"
          };
          
          // Load conversation history from localStorage or use default greeting
          const getStoredMessages = () => {
            try {
              const storageKey = `soulbridge_chat_${companion.name.replace(/\s+/g, '_')}`;
              const stored = localStorage.getItem(storageKey);
              if (stored) {
                const parsed = JSON.parse(stored);
                // Ensure messages have companion info
                return parsed.map(msg => ({
                  ...msg,
                  companion: msg.companion || companion
                }));
              }
            } catch (e) {
              console.warn('Failed to load chat history:', e);
            }
            // Default greeting if no stored messages
            return [{ id: 1, sender: "bot", text: `${companion.greeting} How can I help you today?`, companion: companion }];
          };

          const [messages, setMessages] = useState(getStoredMessages());
          const [input, setInput] = useState("");
          const [loading, setLoading] = useState(false);

          // Save messages to localStorage whenever messages change
          useEffect(() => {
            try {
              const storageKey = `soulbridge_chat_${companion.name.replace(/\s+/g, '_')}`;
              localStorage.setItem(storageKey, JSON.stringify(messages));
            } catch (e) {
              console.warn('Failed to save chat history:', e);
            }
          }, [messages, companion.name]);

          // Clear conversation function
          const clearConversation = () => {
            if (confirm('Clear this conversation? This cannot be undone.')) {
              const defaultMessages = [{ id: 1, sender: "bot", text: `${companion.greeting} How can I help you today?`, companion: companion }];
              setMessages(defaultMessages);
              try {
                const storageKey = `soulbridge_chat_${companion.name.replace(/\s+/g, '_')}`;
                localStorage.removeItem(storageKey);
              } catch (e) {
                console.warn('Failed to clear chat history:', e);
              }
            }
          };

          // TIER-SPECIFIC FEATURES - Matches your exact system
          const getFeatures = (plan, trial) => {
            const baseFeatures = [
              {
                icon: "ðŸ§ ", 
                label: "Decoder", 
                route: "decoder",
                tag: plan === 'gold' ? "999" : plan === 'silver' ? "15/day" : "3/day",
                available: true,
                tier: "bronze"
              },
              {
                icon: "ðŸ”®", 
                label: "Fortune", 
                route: "fortune",
                tag: plan === 'gold' ? "999" : plan === 'silver' ? "8/day" : "3/day",
                available: true,
                tier: "bronze"
              },
              {
                icon: "â­", 
                label: "Horoscope", 
                route: "horoscope",
                tag: plan === 'gold' ? "999" : plan === 'silver' ? "10/day" : "3/day",
                available: true,
                tier: "bronze"
              },
              {
                icon: "âœï¸", 
                label: "Creative Writer", 
                route: "creative-writing",
                tag: plan === 'bronze' ? "2/day" : plan === 'silver' ? "15/day" : "999",
                available: true,
                tier: "bronze"
              },
              {
                icon: "ðŸ¤–", 
                label: "AI Companions", 
                route: plan === 'bronze' ? "chat/bronze/gamerjay_bronze" : plan === 'silver' ? "chat/silver/sky_silver" : "chat/gold/crimson_gold",
                tag: `${plan.charAt(0).toUpperCase() + plan.slice(1)} Access`,
                available: true,
                tier: plan
              },
              {
                icon: "ðŸ“š", 
                label: "Library", 
                route: "library",
                tag: "Available",
                available: true,
                tier: "bronze"
              },
              {
                icon: "ðŸ’¾", 
                label: "Save Chat", 
                route: "save-chat",
                tag: "Available",
                available: true,
                tier: "bronze"
              }
            ];

            // Add trial counter for Bronze users who haven't used their trial yet
            if (plan === 'bronze' && !trial) {
              baseFeatures.push({
                icon: "â±ï¸", 
                label: "Trial Counter", 
                route: "trial-counter",
                tag: "One-Time Only",
                available: true,
                tier: "bronze"
              });
            }

            // Add Silver+ features (Theme Palette)
            if (plan !== 'bronze') {
              baseFeatures.push({
                icon: "ðŸŽ­", 
                label: "Theme Palette", 
                route: "theme-palette",
                tag: plan === 'gold' ? "24 Colors" : "12 Colors",
                available: true,
                tier: "silver"
              });
            }

            // Add premium features for Silver/Gold or Bronze with trial
            if (plan !== 'bronze' || trial) {
              baseFeatures.push(
                {
                  icon: "ðŸŽ¤", 
                  label: "Voice Journal", 
                  route: "voice-journaling",
                  tag: "Available",
                  available: true,
                  tier: "silver"
                },
                {
                  icon: "ðŸŽ¨", 
                  label: "AI Images", 
                  route: "ai-image-generation",
                  tag: plan === 'gold' ? "999" : "10/month",
                  available: true,
                  tier: "silver"
                },
                {
                  icon: "â¤ï¸", 
                  label: "Relationships", 
                  route: "relationship-profiles",
                  tag: "Available",
                  available: true,
                  tier: "silver"
                },
                {
                  icon: "ðŸ§˜", 
                  label: "Meditations", 
                  route: "emotional-meditations",
                  tag: "Available",
                  available: true,
                  tier: "silver"
                }
              );
            }

            // Add Gold exclusive features
            if (plan === 'gold' || (trial && plan === 'bronze')) {
              baseFeatures.push({
                icon: "ðŸŽµ", 
                label: "Mini Studio", 
                route: "mini-studio",
                tag: "Available",
                available: true,
                tier: "gold"
              });
            }

            // Add clear conversation button (always available)
            baseFeatures.push({
              icon: "ðŸ—‘ï¸", 
              label: "Clear Chat", 
              action: "clear_conversation",
              tag: "Reset",
              available: true,
              tier: "bronze"
            });

            return baseFeatures;
          };

          const features = getFeatures(userPlan, trialActive);

          const handleFeatureClick = (feature) => {
            // Handle special actions
            if (feature.action === 'clear_conversation') {
              clearConversation();
              return;
            }
            
            if (!feature.available) {
              alert(`This feature requires ${feature.tier === 'silver' ? 'Silver' : 'Gold'} tier. Upgrade now?`);
              window.location.href = '/plan-selection';
              return;
            }
            
            // Navigate to existing route (preserves all backend logic)
            window.location.href = `/${feature.route}`;
          };

          const sendMessage = async () => {
            if (!input.trim()) return;
            
            const userMessage = { id: Date.now(), sender: "user", text: input };
            setMessages(prev => [...prev, userMessage]);
            setInput("");
            setLoading(true);

            try {
              // Send conversation history for context
              const conversationHistory = messages.map(msg => ({
                role: msg.sender === "user" ? "user" : "assistant",
                content: msg.text
              }));
              
              const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ 
                  message: input,
                  character: companion.name,
                  conversation_history: conversationHistory,
                  user_tier: userPlan  // Send user tier for model selection
                })
              });

              const data = await response.json();
              
              if (data.success) {
                setMessages(prev => [...prev, {
                  id: Date.now() + 1,
                  sender: "bot",
                  text: data.response,
                  companion: companion
                }]);
              } else {
                throw new Error(data.error || 'Failed to get response');
              }
            } catch (error) {
              setMessages(prev => [...prev, {
                id: Date.now() + 1,
                sender: "bot",
                text: "I'm having trouble connecting right now. Please try again in a moment.",
                companion: companion
              }]);
            } finally {
              setLoading(false);
            }
          };

          // TIER-SPECIFIC STYLING
          const getTierColors = (plan) => {
            let colors;
            switch (plan) {
              case 'bronze':
                colors = {
                  primary: '#00FFFF',
                  secondary: '#1a1a1a',
                  gradient: 'from-cyan-500 to-cyan-600'
                };
                break;
              case 'silver':
                colors = {
                  primary: '#C0C0C0',
                  secondary: '#1a1a1a',
                  gradient: 'from-gray-400 to-gray-500'
                };
                break;
              case 'gold':
                colors = {
                  primary: '#FFD700',
                  secondary: '#1a1a1a',
                  gradient: 'from-yellow-400 to-yellow-500'
                };
                break;
              default:
                colors = {
                  primary: '#00FFFF',
                  secondary: '#1a1a1a',
                  gradient: 'from-cyan-500 to-cyan-600'
                };
                break;
            }
            console.log('ðŸŽ¨ TIER COLORS: plan =', plan, ', colors =', colors);
            return colors;
          };

          const colors = getTierColors(userPlan);

          return React.createElement('div', { className: "flex flex-col h-screen bg-gray-50 text-gray-900" },
            // Bronze tier ads notice
            userPlan === 'bronze' && React.createElement('div', { 
              className: "bg-yellow-100 text-yellow-800 text-center py-1 text-xs font-medium border-b" 
            }, 
              "ðŸ“¢ Bronze tier includes ads â€¢ Upgrade to Silver/Gold for ad-free experience"
            ),

            // Top bar with tier-specific feature chips
            React.createElement('div', { className: "sticky top-0 z-20 w-full bg-gray-900/95 backdrop-blur supports-[backdrop-filter]:bg-gray-900/80 shadow-sm" },
              // Tier indicator
              React.createElement('div', { className: "text-center py-2 text-sm font-medium text-white" },
                React.createElement('span', { style: { color: colors.primary } },
                  userPlan.charAt(0).toUpperCase() + userPlan.slice(1) + ' Tier'
                ),
                trialActive && React.createElement('span', { 
                  className: "ml-2 px-2 py-1 rounded-full bg-green-500/20 text-green-300 text-xs" 
                }, "Trial Active")
              ),
              
              // Feature chips
              React.createElement('div', { className: "max-w-6xl mx-auto px-3 py-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3" },
                features.map((f, i) => {
                  const isPremium = f.tag?.includes('ðŸ”’');
                  const isInfinity = f.tag === "999";
                  const isAvailable = f.available;
                  
                  return React.createElement('button', {
                    key: i,
                    onClick: () => handleFeatureClick(f),
                    className: `group flex flex-col items-center gap-1 rounded-lg px-2 py-3 text-sm font-medium ring-1 ring-white/10 transition-all min-h-[80px]
                      ${isAvailable 
                        ? "bg-gray-900 hover:bg-gray-800 cursor-pointer" 
                        : "bg-gray-800 hover:bg-gray-700 cursor-pointer opacity-75"
                      } text-white`,
                    style: {
                      borderColor: isAvailable ? colors.primary : '#666'
                    }
                  },
                    React.createElement('span', { className: "text-xl mb-1" }, f.icon),
                    React.createElement('span', { className: "text-xs font-medium text-center leading-tight px-1" }, f.label),

                    isInfinity && isAvailable && React.createElement('span', { 
                      className: "mt-1 rounded-md px-1.5 py-0.5 text-[10px] font-semibold bg-emerald-400/15 text-emerald-300 ring-1 ring-emerald-400/30" 
                    }, f.tag),

                    isPremium && React.createElement('span', { 
                      className: "mt-1 rounded-md px-1.5 py-0.5 text-[9px] font-semibold uppercase tracking-wide bg-amber-400/15 text-amber-300 ring-1 ring-amber-400/30" 
                    }, "Locked"),

                    !isPremium && !isInfinity && f.tag && React.createElement('span', {
                      className: "mt-1 rounded-md px-1.5 py-0.5 text-[10px] font-semibold ring-1",
                      style: {
                        backgroundColor: `${colors.primary}15`,
                        color: colors.primary,
                        borderColor: `${colors.primary}30`
                      }
                    }, f.tag)
                  );
                })
              )
            ),

            // Chat area
            React.createElement('div', { className: "flex-1 overflow-y-auto" },
              React.createElement('div', { className: "max-w-3xl mx-auto w-full p-4 space-y-4" },
                messages.map((msg) =>
                  React.createElement('div', {
                    key: msg.id,
                    className: `flex ${msg.sender === "user" ? "justify-end" : "justify-start"}`
                  },
                    msg.sender !== "user" && React.createElement('div', {
                      className: "w-8 h-8 shrink-0 mr-2 rounded-full overflow-hidden bg-gray-800 border-2",
                      style: {
                        borderColor: colors.primary
                      }
                    }, 
                      msg.companion && msg.companion.image 
                        ? React.createElement('img', {
                            src: msg.companion.image,
                            alt: msg.companion.name,
                            className: "w-full h-full object-cover"
                          })
                        : React.createElement('span', { className: "text-white grid place-items-center w-full h-full text-sm" }, "ðŸ¤–")
                    ),
                    
                    React.createElement('div', {
                      className: `px-4 py-2 rounded-2xl max-w-[80%] shadow-sm text-black`,
                      style: {
                        background: colors.primary
                      }
                    }, msg.text)
                  )
                ),
                loading && React.createElement('div', { className: "flex justify-start" },
                  React.createElement('div', {
                    className: "w-8 h-8 shrink-0 mr-2 rounded-full overflow-hidden bg-gray-800 border-2",
                    style: {
                      borderColor: colors.primary
                    }
                  }, 
                    companion && companion.image 
                      ? React.createElement('img', {
                          src: companion.image,
                          alt: companion.name,
                          className: "w-full h-full object-cover"
                        })
                      : React.createElement('span', { className: "text-white grid place-items-center w-full h-full text-sm" }, "ðŸ¤–")
                  ),
                  React.createElement('div', { 
                    className: "px-4 py-2 rounded-2xl text-black",
                    style: { background: colors.primary }
                  },
                    React.createElement('div', { className: "flex space-x-1" },
                      React.createElement('div', { className: "w-2 h-2 bg-black rounded-full animate-bounce" }),
                      React.createElement('div', { className: "w-2 h-2 bg-black rounded-full animate-bounce", style: { animationDelay: '0.1s' } }),
                      React.createElement('div', { className: "w-2 h-2 bg-black rounded-full animate-bounce", style: { animationDelay: '0.2s' } })
                    )
                  )
                )
              )
            ),

            // Input row
            React.createElement('div', { className: "border-t bg-white" },
              React.createElement('div', { className: "max-w-4xl mx-auto w-full p-4 flex items-center gap-3" },
                React.createElement('input', {
                  type: "text",
                  value: input,
                  onChange: (e) => setInput(e.target.value),
                  placeholder: "Message your AI companion...",
                  className: "flex-1 px-6 py-4 rounded-full border-2 focus:outline-none focus:ring-2 text-black placeholder-black placeholder-opacity-60 text-lg",
                  style: { 
                    background: colors.primary,
                    borderColor: colors.primary,
                    '--tw-ring-color': colors.primary + '50'
                  },
                  onKeyDown: (e) => e.key === "Enter" && !loading && sendMessage(),
                  disabled: loading
                }),
                React.createElement('button', {
                  onClick: sendMessage,
                  disabled: loading,
                  className: "h-14 w-14 rounded-full text-black grid place-items-center transition-colors",
                  style: {
                    background: colors.primary,
                    opacity: loading ? 0.5 : 1
                  },
                  'aria-label': "Send",
                  title: "Send"
                }, React.createElement(Send, { size: 20 }))
              )
            )
          );
        }

        // Safe mounting with error handling
        try {
            const container = document.getElementById('app');
            if (container && window.ReactDOM && window.APP_DATA) {
                console.log('ðŸŽ¨ TIER DEBUG: APP_DATA.userPlan =', window.APP_DATA.userPlan);
                console.log('ðŸŽ¨ TIER DEBUG: Expected colors for', window.APP_DATA.userPlan);
                
                const root = ReactDOM.createRoot(container);
                root.render(React.createElement(UnifiedChatPage, {
                    userPlan: window.APP_DATA.userPlan,
                    trialActive: window.APP_DATA.trialActive
                }));
                console.log('React app mounted successfully with userPlan:', window.APP_DATA.userPlan);
            } else {
                throw new Error('Missing container, ReactDOM, or APP_DATA');
            }
        } catch (error) {
            console.error('Failed to mount React app:', error);
            document.getElementById('app').innerHTML = '<div style="padding: 20px; text-align: center;"><h2>Loading Error</h2><p>Please refresh the page or <a href="/bronze">go back</a></p></div>';
        }
    </script>
</body>
</html>