<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulBridge AI - {{ user_plan.title() }} Tier</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    
    <!-- Pass data from Flask to React -->
    <script>
        window.APP_DATA = {
            userPlan: "{{ user_plan }}",
            trialActive: {{ 'true' if trial_active else 'false' }}
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Send } = lucide;

        function UnifiedChatPage({ userPlan = "bronze", trialActive = false }) {
          const [messages, setMessages] = useState([
            { id: 1, sender: "bot", text: `Welcome to SoulBridge AI! You're on the ${userPlan.charAt(0).toUpperCase() + userPlan.slice(1)} tier.` },
            { id: 2, sender: "bot", text: "How can I help you today?" }
          ]);
          const [input, setInput] = useState("");
          const [loading, setLoading] = useState(false);

          // TIER-SPECIFIC FEATURES - Matches your exact system
          const getFeatures = (plan, trial) => {
            const baseFeatures = [
              {
                icon: "ðŸ§ ", 
                label: "Decoder", 
                route: "decoder",
                tag: plan === 'gold' ? "999" : plan === 'silver' ? "15/day" : "3/day",
                available: true,
                tier: "bronze"
              },
              {
                icon: "ðŸ”®", 
                label: "Fortune", 
                route: "fortune",
                tag: plan === 'gold' ? "999" : plan === 'silver' ? "8/day" : "3/day",
                available: true,
                tier: "bronze"
              },
              {
                icon: "â­", 
                label: "Horoscope", 
                route: "horoscope",
                tag: plan === 'gold' ? "999" : plan === 'silver' ? "10/day" : "3/day",
                available: true,
                tier: "bronze"
              },
              {
                icon: "âœï¸", 
                label: "Creative Writer", 
                route: "creative-writing",
                tag: plan === 'bronze' ? "2/day" : plan === 'silver' ? "15/day" : "999",
                available: true,
                tier: "bronze"
              },
              {
                icon: "ðŸ¤–", 
                label: "AI Companions", 
                route: plan === 'bronze' ? "chat/gamerjay_bronze" : plan === 'silver' ? "chat/sky_silver" : "chat/crimson_gold",
                tag: `${plan.charAt(0).toUpperCase() + plan.slice(1)} Access`,
                available: true,
                tier: plan
              },
              {
                icon: "ðŸ“š", 
                label: "Library", 
                route: "library",
                tag: "Available",
                available: true,
                tier: "bronze"
              },
              {
                icon: "ðŸ—‘ï¸", 
                label: "Clear Chat", 
                route: "clear-chat",
                tag: "Available",
                available: true,
                tier: "bronze"
              },
              {
                icon: "ðŸ’¾", 
                label: "Save Chat", 
                route: "save-chat",
                tag: "Available",
                available: true,
                tier: "bronze"
              }
            ];

            // Add trial counter for Bronze users only
            if (plan === 'bronze') {
              baseFeatures.push({
                icon: "â±ï¸", 
                label: "Trial Counter", 
                route: "trial-counter",
                tag: "One-Time Only",
                available: true,
                tier: "bronze"
              });
            }

            // Add Silver+ features (Theme Palette)
            if (plan !== 'bronze') {
              baseFeatures.push({
                icon: "ðŸŽ­", 
                label: "Theme Palette", 
                route: "theme-palette",
                tag: plan === 'gold' ? "24 Colors" : "12 Colors",
                available: true,
                tier: "silver"
              });
            }

            // Add premium features for Silver/Gold or Bronze with trial
            if (plan !== 'bronze' || trial) {
              baseFeatures.push(
                {
                  icon: "ðŸŽ¤", 
                  label: "Voice Journal", 
                  route: "voice-journaling",
                  tag: "Available",
                  available: true,
                  tier: "silver"
                },
                {
                  icon: "ðŸŽ¨", 
                  label: "AI Images", 
                  route: "ai-image-generation",
                  tag: plan === 'gold' ? "999" : "10/month",
                  available: true,
                  tier: "silver"
                },
                {
                  icon: "â¤ï¸", 
                  label: "Relationships", 
                  route: "relationship-profiles",
                  tag: "Available",
                  available: true,
                  tier: "silver"
                },
                {
                  icon: "ðŸ§˜", 
                  label: "Meditations", 
                  route: "emotional-meditations",
                  tag: "Available",
                  available: true,
                  tier: "silver"
                }
              );
            }

            // Add Gold exclusive features
            if (plan === 'gold' || (trial && plan === 'bronze')) {
              baseFeatures.push({
                icon: "ðŸŽµ", 
                label: "Mini Studio", 
                route: "mini-studio",
                tag: "Available",
                available: true,
                tier: "gold"
              });
            }

            return baseFeatures;
          };

          const features = getFeatures(userPlan, trialActive);

          const handleFeatureClick = (feature) => {
            if (!feature.available) {
              alert(`This feature requires ${feature.tier === 'silver' ? 'Silver' : 'Gold'} tier. Upgrade now?`);
              window.location.href = '/plan-selection';
              return;
            }
            
            // Navigate to existing route (preserves all backend logic)
            window.location.href = `/${feature.route}`;
          };

          const sendMessage = async () => {
            if (!input.trim()) return;
            
            const userMessage = { id: Date.now(), sender: "user", text: input };
            setMessages(prev => [...prev, userMessage]);
            setInput("");
            setLoading(true);

            try {
              // Use existing chat API (preserves all backend logic)
              const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ message: input })
              });

              const data = await response.json();
              
              if (data.success) {
                setMessages(prev => [...prev, {
                  id: Date.now() + 1,
                  sender: "bot",
                  text: data.response
                }]);
              } else {
                throw new Error(data.error || 'Failed to get response');
              }
            } catch (error) {
              setMessages(prev => [...prev, {
                id: Date.now() + 1,
                sender: "bot",
                text: "I'm having trouble connecting right now. Please try again in a moment."
              }]);
            } finally {
              setLoading(false);
            }
          };

          // TIER-SPECIFIC STYLING
          const getTierColors = (plan) => {
            switch (plan) {
              case 'bronze':
                return {
                  primary: '#00FFFF',
                  secondary: '#1a1a1a',
                  gradient: 'from-cyan-500 to-cyan-600'
                };
              case 'silver':
                return {
                  primary: '#C0C0C0',
                  secondary: '#1a1a1a',
                  gradient: 'from-gray-400 to-gray-500'
                };
              case 'gold':
                return {
                  primary: '#FFD700',
                  secondary: '#1a1a1a',
                  gradient: 'from-yellow-400 to-yellow-500'
                };
              default:
                return {
                  primary: '#00FFFF',
                  secondary: '#1a1a1a',
                  gradient: 'from-cyan-500 to-cyan-600'
                };
            }
          };

          const colors = getTierColors(userPlan);

          return React.createElement('div', { className: "flex flex-col h-screen bg-gray-50 text-gray-900" },
            // Bronze tier ads notice
            userPlan === 'bronze' && React.createElement('div', { 
              className: "bg-yellow-100 text-yellow-800 text-center py-1 text-xs font-medium border-b" 
            }, 
              "ðŸ“¢ Bronze tier includes ads â€¢ Upgrade to Silver/Gold for ad-free experience"
            ),

            // Top bar with tier-specific feature chips
            React.createElement('div', { className: "sticky top-0 z-20 w-full bg-gray-900/95 backdrop-blur supports-[backdrop-filter]:bg-gray-900/80 shadow-sm" },
              // Tier indicator
              React.createElement('div', { className: "text-center py-2 text-sm font-medium text-white" },
                React.createElement('span', { style: { color: colors.primary } },
                  userPlan.charAt(0).toUpperCase() + userPlan.slice(1) + ' Tier'
                ),
                trialActive && React.createElement('span', { 
                  className: "ml-2 px-2 py-1 rounded-full bg-green-500/20 text-green-300 text-xs" 
                }, "Trial Active")
              ),
              
              // Feature chips
              React.createElement('div', { className: "max-w-6xl mx-auto px-3 py-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2" },
                features.map((f, i) => {
                  const isPremium = f.tag?.includes('ðŸ”’');
                  const isInfinity = f.tag === "999";
                  const isAvailable = f.available;
                  
                  return React.createElement('button', {
                    key: i,
                    onClick: () => handleFeatureClick(f),
                    className: `group flex items-center justify-between gap-2 rounded-lg px-3 py-2 text-sm font-medium ring-1 ring-white/10 transition-all
                      ${isAvailable 
                        ? "bg-gray-900 hover:bg-gray-800 cursor-pointer" 
                        : "bg-gray-800 hover:bg-gray-700 cursor-pointer opacity-75"
                      } text-white`,
                    style: {
                      borderColor: isAvailable ? colors.primary : '#666'
                    }
                  },
                    React.createElement('span', { className: "flex items-center gap-1.5" },
                      React.createElement('span', { className: "text-base" }, f.icon),
                      React.createElement('span', { className: "truncate" }, f.label)
                    ),

                    isInfinity && isAvailable && React.createElement('span', { 
                      className: "ml-2 rounded-md px-1.5 py-0.5 text-xs font-semibold bg-emerald-400/15 text-emerald-300 ring-1 ring-emerald-400/30" 
                    }, f.tag),

                    isPremium && React.createElement('span', { 
                      className: "ml-2 rounded-md px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide bg-amber-400/15 text-amber-300 ring-1 ring-amber-400/30" 
                    }, "Locked"),

                    !isPremium && !isInfinity && f.tag && React.createElement('span', {
                      className: "ml-2 rounded-md px-1.5 py-0.5 text-xs font-semibold ring-1",
                      style: {
                        backgroundColor: `${colors.primary}15`,
                        color: colors.primary,
                        borderColor: `${colors.primary}30`
                      }
                    }, f.tag)
                  );
                })
              )
            ),

            // Chat area
            React.createElement('div', { className: "flex-1 overflow-y-auto" },
              React.createElement('div', { className: "max-w-3xl mx-auto w-full p-4 space-y-4" },
                messages.map((msg) =>
                  React.createElement('div', {
                    key: msg.id,
                    className: `flex ${msg.sender === "user" ? "justify-end" : "justify-start"}`
                  },
                    msg.sender !== "user" && React.createElement('div', {
                      className: "w-8 h-8 shrink-0 mr-2 rounded-full text-white grid place-items-center",
                      style: {
                        background: `linear-gradient(135deg, ${colors.primary}, ${colors.secondary})`
                      }
                    }, "ðŸ¤–"),
                    
                    React.createElement('div', {
                      className: `px-4 py-2 rounded-2xl max-w-[80%] shadow-sm ${
                        msg.sender === "user"
                          ? `text-white`
                          : "bg-white text-gray-800 ring-1 ring-gray-200"
                      }`,
                      style: {
                        background: msg.sender === "user" ? colors.primary : undefined,
                        color: msg.sender === "user" ? colors.secondary : undefined
                      }
                    }, msg.text)
                  )
                ),
                loading && React.createElement('div', { className: "flex justify-start" },
                  React.createElement('div', {
                    className: "w-8 h-8 shrink-0 mr-2 rounded-full text-white grid place-items-center",
                    style: {
                      background: `linear-gradient(135deg, ${colors.primary}, ${colors.secondary})`
                    }
                  }, "ðŸ¤–"),
                  React.createElement('div', { className: "px-4 py-2 rounded-2xl bg-white text-gray-800 ring-1 ring-gray-200" },
                    React.createElement('div', { className: "flex space-x-1" },
                      React.createElement('div', { className: "w-2 h-2 bg-gray-400 rounded-full animate-bounce" }),
                      React.createElement('div', { className: "w-2 h-2 bg-gray-400 rounded-full animate-bounce", style: { animationDelay: '0.1s' } }),
                      React.createElement('div', { className: "w-2 h-2 bg-gray-400 rounded-full animate-bounce", style: { animationDelay: '0.2s' } })
                    )
                  )
                )
              )
            ),

            // Input row
            React.createElement('div', { className: "border-t bg-white" },
              React.createElement('div', { className: "max-w-3xl mx-auto w-full p-3 flex items-center gap-2" },
                React.createElement('input', {
                  type: "text",
                  value: input,
                  onChange: (e) => setInput(e.target.value),
                  placeholder: "Message your AI companion...",
                  className: "flex-1 px-4 py-3 rounded-full border border-gray-200 focus:outline-none focus:ring-2",
                  style: { 
                    '--tw-ring-color': colors.primary + '50'
                  },
                  onKeyDown: (e) => e.key === "Enter" && !loading && sendMessage(),
                  disabled: loading
                }),
                React.createElement('button', {
                  onClick: sendMessage,
                  disabled: loading,
                  className: "h-12 w-12 rounded-full text-white grid place-items-center transition-colors",
                  style: {
                    background: colors.primary,
                    opacity: loading ? 0.5 : 1
                  },
                  'aria-label': "Send",
                  title: "Send"
                }, React.createElement(Send, { size: 18 }))
              )
            )
          );
        }

        // Mount the app with data from Flask
        const container = document.getElementById('app');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(UnifiedChatPage, {
            userPlan: window.APP_DATA.userPlan,
            trialActive: window.APP_DATA.trialActive
        }));
    </script>
</body>
</html>