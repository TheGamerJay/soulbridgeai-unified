<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horoscope Readings - SoulBridge AI</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Ad-Free Detection Script -->
    <script>
        window.__AD_FREE__ = {{ 'true' if ad_free else 'false' }};
    </script>
    
    <!-- Conditional AdSense Loading (Only for non-ad-free users) -->
    <script>
        (function() {
            var adFree = (window.__AD_FREE__ === true || window.__AD_FREE__ === 'true');
            if (!adFree) {
                var s = document.createElement('script');
                s.async = true;
                s.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3869471953521437";
                s.crossOrigin = "anonymous";
                document.head.appendChild(s);
                console.log('üì∫ AdSense loaded for horoscope page');
            } else {
                console.log('üö´ AdSense blocked - user has ad-free subscription');
            }
        })();
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 50%, #2d1b4e 100%);
            color: #e2e8f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .back-btn {
            display: inline-block;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            color: #ffd700;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: translateY(-1px);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            color: #ffd700;
            margin-bottom: 16px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .header p {
            font-size: 1.2rem;
            color: #c7d2fe;
            max-width: 600px;
            margin: 0 auto;
        }

        .horoscope-interface {
            background: rgba(15, 15, 35, 0.8);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .horoscope-interface::before {
            content: '';
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            background: url('/static/logos/horoscope sky.png') center/contain;
            background-repeat: no-repeat;
            border-radius: 50%;
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            background-color: rgba(15, 15, 35, 0.9);
        }

        .usage-indicator {
            background: rgba(15, 15, 35, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .section {
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 215, 0, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 15px;
        }

        .section h2 {
            color: #ffd700;
            font-size: 1.5rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .section p {
            color: #c7d2fe;
            margin-bottom: 20px;
            text-align: center;
        }

        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .zodiac-sign {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .zodiac-sign:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
            transform: translateY(-2px);
        }

        .zodiac-sign.selected {
            background: rgba(255, 215, 0, 0.3);
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .zodiac-sign .emoji {
            font-size: 2rem;
            margin-bottom: 8px;
            display: block;
        }

        .zodiac-sign .name {
            font-weight: 600;
            color: #ffd700;
        }

        .compatibility-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }

        .sign-selector {
            text-align: center;
        }

        .sign-selector h3 {
            color: #ffd700;
            margin-bottom: 15px;
        }

        .generate-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a202c;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }

        .generate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .output-box {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            min-height: 150px;
            line-height: 1.6;
            display: none;
        }

        .output-box.show {
            display: block;
        }


        /* Mobile responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .horoscope-interface {
                padding: 20px;
            }

            .compatibility-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <a href="javascript:history.back()" class="back-btn">‚Üê Back to Chat</a>

    <div class="container">
        <div class="header">
            <h1>‚≠ê Horoscope Readings</h1>
            <p>Get simple, personalized cosmic guidance for your zodiac sign</p>
        </div>

        <div class="horoscope-interface">
            <!-- Usage Indicator -->
            <div class="usage-indicator">
                <span id="plan-description">‚≠ê Daily Horoscopes: <span id="usage-count">{{ current_usage or 0 }}</span> / <span id="usage-limit">{{ daily_limit if daily_limit else 3 }}</span> used</span>
            </div>

            <!-- Daily Horoscope Section -->
            <div class="section">
                <h2>üåü Daily Horoscope</h2>
                <p>Click your zodiac sign to get today's reading</p>
                
                <div class="zodiac-grid" id="daily-zodiac-grid">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <button id="daily-btn" class="generate-btn" disabled>
                    ‚≠ê Get My Daily Horoscope
                </button>
                
                <div id="daily-output" class="output-box"></div>
            </div>

            <!-- Compatibility Section -->
            <div class="section">
                <h2>üíï Compatibility Reading</h2>
                <p>See how compatible you are with someone else</p>
                
                <div class="compatibility-section">
                    <div class="sign-selector">
                        <h3>Your Sign</h3>
                        <div class="zodiac-grid" id="your-sign-grid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="sign-selector">
                        <h3>Their Sign</h3>
                        <div class="zodiac-grid" id="their-sign-grid">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <button id="compatibility-btn" class="generate-btn" disabled>
                    üíï Check Our Compatibility
                </button>
                
                <div id="compatibility-output" class="output-box"></div>
            </div>

            <!-- Monthly Forecast Section -->
            <div class="section">
                <h2>üìÖ Monthly Forecast</h2>
                <p>Get insights for the current month based on your sign</p>
                
                <div class="zodiac-grid" id="monthly-zodiac-grid">
                    <!-- Will be populated by JavaScript -->
                </div>
                
                <button id="monthly-btn" class="generate-btn" disabled>
                    üìÖ Get My Monthly Forecast
                </button>
                
                <div id="monthly-output" class="output-box"></div>
            </div>
        </div>
    </div>

<script>
// Zodiac signs data
const zodiacSigns = [
    { name: 'Aries', emoji: '‚ôà', dates: 'Mar 21 - Apr 19' },
    { name: 'Taurus', emoji: '‚ôâ', dates: 'Apr 20 - May 20' },
    { name: 'Gemini', emoji: '‚ôä', dates: 'May 21 - Jun 20' },
    { name: 'Cancer', emoji: '‚ôã', dates: 'Jun 21 - Jul 22' },
    { name: 'Leo', emoji: '‚ôå', dates: 'Jul 23 - Aug 22' },
    { name: 'Virgo', emoji: '‚ôç', dates: 'Aug 23 - Sep 22' },
    { name: 'Libra', emoji: '‚ôé', dates: 'Sep 23 - Oct 22' },
    { name: 'Scorpio', emoji: '‚ôè', dates: 'Oct 23 - Nov 21' },
    { name: 'Sagittarius', emoji: '‚ôê', dates: 'Nov 22 - Dec 21' },
    { name: 'Capricorn', emoji: '‚ôë', dates: 'Dec 22 - Jan 19' },
    { name: 'Aquarius', emoji: '‚ôí', dates: 'Jan 20 - Feb 18' },
    { name: 'Pisces', emoji: '‚ôì', dates: 'Feb 19 - Mar 20' }
];

// State variables
let selectedDailySign = null;
let selectedYourSign = null;
let selectedTheirSign = null;
let selectedMonthlySign = null;

// User state from backend
let userUsage = {{ current_usage or 0 }};
let userPlan = '{{ user_plan or "free" }}';
let dailyLimit = {{ daily_limit if daily_limit else "null" }};

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    createZodiacGrids();
    refreshHoroscopeLimits();
});

// Create zodiac sign grids
function createZodiacGrids() {
    const dailyGrid = document.getElementById('daily-zodiac-grid');
    const yourGrid = document.getElementById('your-sign-grid');
    const theirGrid = document.getElementById('their-sign-grid');
    const monthlyGrid = document.getElementById('monthly-zodiac-grid');

    zodiacSigns.forEach(sign => {
        // Daily horoscope grid
        const dailySign = createZodiacElement(sign, 'daily');
        dailyGrid.appendChild(dailySign);

        // Compatibility grids
        const yourSign = createZodiacElement(sign, 'your');
        yourGrid.appendChild(yourSign);

        const theirSign = createZodiacElement(sign, 'their');
        theirGrid.appendChild(theirSign);

        // Monthly grid
        const monthlySign = createZodiacElement(sign, 'monthly');
        monthlyGrid.appendChild(monthlySign);
    });
}

function createZodiacElement(sign, type) {
    const element = document.createElement('div');
    element.className = 'zodiac-sign';
    element.innerHTML = `
        <span class="emoji">${sign.emoji}</span>
        <div class="name">${sign.name}</div>
    `;
    
    element.addEventListener('click', () => selectZodiacSign(sign, type, element));
    return element;
}

function selectZodiacSign(sign, type, element) {
    // Remove previous selection in this grid
    const gridId = type === 'daily' ? 'daily-zodiac-grid' :
                   type === 'your' ? 'your-sign-grid' :
                   type === 'their' ? 'their-sign-grid' : 'monthly-zodiac-grid';
    
    document.querySelectorAll(`#${gridId} .zodiac-sign`).forEach(el => {
        el.classList.remove('selected');
    });
    
    // Select this sign
    element.classList.add('selected');
    
    // Update state
    if (type === 'daily') {
        selectedDailySign = sign;
        document.getElementById('daily-btn').disabled = false;
    } else if (type === 'your') {
        selectedYourSign = sign;
        updateCompatibilityButton();
    } else if (type === 'their') {
        selectedTheirSign = sign;
        updateCompatibilityButton();
    } else if (type === 'monthly') {
        selectedMonthlySign = sign;
        document.getElementById('monthly-btn').disabled = false;
    }
}

function updateCompatibilityButton() {
    const btn = document.getElementById('compatibility-btn');
    btn.disabled = !(selectedYourSign && selectedTheirSign);
}

// Event listeners for buttons
document.getElementById('daily-btn').addEventListener('click', generateDaily);
document.getElementById('compatibility-btn').addEventListener('click', generateCompatibility);
document.getElementById('monthly-btn').addEventListener('click', generateMonthly);

async function generateDaily() {
    if (!checkUsageLimit()) return;
    
    const btn = document.getElementById('daily-btn');
    const output = document.getElementById('daily-output');
    
    btn.disabled = true;
    btn.textContent = '‚≠ê Reading the stars...';
    output.className = 'output-box';
    output.innerHTML = '‚ú® Consulting the cosmic energies for your daily guidance...';
    output.classList.add('show');
    
    try {
        const prompt = `Give me a daily horoscope reading for ${selectedDailySign.name} for today. Include:
1. **Today's Energy**: What cosmic energies are affecting ${selectedDailySign.name} today?
2. **Love & Relationships**: Guidance for romantic connections and relationships
3. **Career & Money**: Professional and financial insights for today
4. **Health & Wellness**: Physical and emotional wellbeing advice
5. **Lucky Element**: A lucky color, number, or suggestion for today

Keep it positive, insightful, and practical. Make it personal for someone born under ${selectedDailySign.name}.`;

        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: prompt,
                character: 'Blayzo',
                context: 'daily_horoscope'
            })
        });

        const result = await response.json();
        
        if (result.success) {
            output.innerHTML = result.response;
            userUsage++;
            refreshHoroscopeLimits();
            
            // Auto-save to library
            await saveHoroscopeToLibrary(
                `Daily Horoscope - ${selectedDailySign.name}`,
                result.response,
                'daily_horoscope',
                { zodiac_sign: selectedDailySign.name, reading_type: 'daily' }
            );
        } else {
            output.innerHTML = '‚ö†Ô∏è Unable to generate your horoscope right now. Please try again.';
        }
    } catch (error) {
        console.error('Daily horoscope error:', error);
        output.innerHTML = '‚ö†Ô∏è Something went wrong. Please try again.';
    } finally {
        btn.disabled = false;
        btn.textContent = '‚≠ê Get My Daily Horoscope';
    }
}

async function generateCompatibility() {
    if (!checkUsageLimit()) return;
    
    const btn = document.getElementById('compatibility-btn');
    const output = document.getElementById('compatibility-output');
    
    btn.disabled = true;
    btn.textContent = 'üíï Analyzing compatibility...';
    output.className = 'output-box';
    output.innerHTML = 'üí´ Examining the cosmic connection between your signs...';
    output.classList.add('show');
    
    try {
        const prompt = `Analyze the compatibility between ${selectedYourSign.name} and ${selectedTheirSign.name}. Include:
1. **Overall Compatibility**: How well do these signs match? (Give a percentage or rating)
2. **Strengths**: What makes this pairing work well together?
3. **Challenges**: What areas might need extra attention or compromise?
4. **Love & Romance**: How these signs connect romantically
5. **Communication**: How they understand and communicate with each other
6. **Advice**: Practical tips for making this relationship thrive

Be balanced, honest, and helpful. Focus on how they can build a strong connection.`;

        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: prompt,
                character: 'Blayzo',
                context: 'compatibility_reading'
            })
        });

        const result = await response.json();
        
        if (result.success) {
            output.innerHTML = result.response;
            userUsage++;
            refreshHoroscopeLimits();
            
            // Auto-save to library
            await saveHoroscopeToLibrary(
                `Compatibility Reading - ${selectedYourSign.name} & ${selectedTheirSign.name}`,
                result.response,
                'compatibility_reading',
                { your_sign: selectedYourSign.name, their_sign: selectedTheirSign.name, reading_type: 'compatibility' }
            );
        } else {
            output.innerHTML = '‚ö†Ô∏è Unable to generate compatibility reading right now. Please try again.';
        }
    } catch (error) {
        console.error('Compatibility error:', error);
        output.innerHTML = '‚ö†Ô∏è Something went wrong. Please try again.';
    } finally {
        btn.disabled = selectedYourSign && selectedTheirSign ? false : true;
        btn.textContent = 'üíï Check Our Compatibility';
    }
}

async function generateMonthly() {
    if (!checkUsageLimit()) return;
    
    const btn = document.getElementById('monthly-btn');
    const output = document.getElementById('monthly-output');
    
    btn.disabled = true;
    btn.textContent = 'üìÖ Reading monthly forecast...';
    output.className = 'output-box';
    output.innerHTML = 'üåô Gathering insights for your month ahead...';
    output.classList.add('show');
    
    try {
        const currentMonth = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
        
        const prompt = `Give me a monthly horoscope forecast for ${selectedMonthlySign.name} for ${currentMonth}. Include:
1. **Month Overview**: What are the main themes and energies for ${selectedMonthlySign.name} this month?
2. **Key Dates**: Important time periods or cosmic events to watch for
3. **Love & Relationships**: Romantic prospects and relationship guidance for the month
4. **Career & Finance**: Professional opportunities and money matters
5. **Personal Growth**: Areas for self-improvement and spiritual development
6. **Challenges & Opportunities**: What to be aware of and how to make the most of this month

Make it inspiring, practical, and specifically tailored for ${selectedMonthlySign.name}.`;

        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: prompt,
                character: 'Blayzo',
                context: 'monthly_forecast'
            })
        });

        const result = await response.json();
        
        if (result.success) {
            output.innerHTML = result.response;
            userUsage++;
            refreshHoroscopeLimits();
            
            // Auto-save to library
            const currentMonth = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
            await saveHoroscopeToLibrary(
                `Monthly Forecast - ${selectedMonthlySign.name} (${currentMonth})`,
                result.response,
                'monthly_forecast',
                { zodiac_sign: selectedMonthlySign.name, month: currentMonth, reading_type: 'monthly' }
            );
        } else {
            output.innerHTML = '‚ö†Ô∏è Unable to generate monthly forecast right now. Please try again.';
        }
    } catch (error) {
        console.error('Monthly forecast error:', error);
        output.innerHTML = '‚ö†Ô∏è Something went wrong. Please try again.';
    } finally {
        btn.disabled = false;
        btn.textContent = 'üìÖ Get My Monthly Forecast';
    }
}

// Usage limit checking
function checkUsageLimit() {
    if (dailyLimit !== null && userUsage >= dailyLimit) {
        alert(`You've reached your daily limit of ${dailyLimit} horoscope readings. Upgrade to get more!`);
        return false;
    }
    return true;
}

async function refreshHoroscopeLimits() {
    try {
        const res = await fetch('/api/horoscope/check-limit');
        const data = await res.json();
        
        if (data.success) {
            userUsage = data.usage;
            userPlan = data.user_plan;
            dailyLimit = data.daily_limit;
            
            const usageCount = document.getElementById('usage-count');
            const usageLimit = document.getElementById('usage-limit');
            const planDesc = document.getElementById('plan-description');
            
            if (usageCount) usageCount.textContent = userUsage;
            if (usageLimit) usageLimit.textContent = dailyLimit === null ? '‚àû' : dailyLimit;
            if (planDesc) {
                const limitDisplay = dailyLimit === null ? '‚àû' : dailyLimit;
                planDesc.textContent = `‚≠ê Daily Horoscopes: ${userUsage} / ${limitDisplay} used`;
            }
        }
    } catch (error) {
        console.error('Failed to refresh horoscope limits:', error);
    }
}

// Auto-save horoscope readings to library
async function saveHoroscopeToLibrary(title, content, readingType, metadata) {
    try {
        const response = await fetch('/api/save-horoscope', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                title: title,
                content: content,
                reading_type: readingType,
                metadata: metadata
            })
        });
        
        const result = await response.json();
        if (result.success) {
            console.log('Horoscope reading saved to library:', title);
            // Optional: Show a subtle notification
            showSaveNotification('‚úÖ Reading saved to your library');
        } else {
            console.warn('Failed to save horoscope reading:', result.error);
        }
    } catch (error) {
        console.error('Error saving horoscope to library:', error);
    }
}

// Show subtle save notification
function showSaveNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: rgba(34, 197, 94, 0.9);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    // Add slide-in animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // Remove notification after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => {
            document.body.removeChild(notification);
            document.head.removeChild(style);
        }, 300);
    }, 3000);
}
</script>

</body>
</html>