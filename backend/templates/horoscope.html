<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Horoscope Sky - SoulBridge AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  
  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  
  <!-- Ad-Free Detection Script -->
  <script>
      window.__AD_FREE__ = {{ 'true' if ad_free else 'false' }};
  </script>
  
  <!-- Conditional AdSense Loading (Only for non-ad-free users) -->
  <script>
      (function() {
          var adFree = (window.__AD_FREE__ === true || window.__AD_FREE__ === 'true');
          if (!adFree) {
              var s = document.createElement('script');
              s.async = true;
              s.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3869471953521437";
              s.crossOrigin = "anonymous";
              document.head.appendChild(s);
              console.log('üì∫ AdSense loaded for horoscope page');
          } else {
              console.log('üö´ AdSense blocked - user has ad-free subscription');
          }
      })();
  </script>
  
  <style>
    :root { --w: 1100px; --gap: 14px; }
    body { 
      font-family: Georgia, 'Times New Roman', serif; 
      margin:0; 
      background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 40%, #2e1065 100%);
      color: #d4af37; 
      min-height: 100vh;
    }
    .back-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 215, 0, 0.8);
      color: #1a202c;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      z-index: 100;
    }
    .back-btn:hover {
      background: rgba(255, 215, 0, 1);
      transform: translateY(-2px);
    }
    header { 
      background: rgba(0,0,0,0.8); 
      color: #d4af37; 
      padding: 24px; 
      text-align: center;
      backdrop-filter: blur(10px);
      border-bottom: 2px solid #d4af37;
    }
    header h1 {
      font-size: 2.8rem;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
      font-weight: bold;
    }
    .subtitle {
      font-size: 1.2rem;
      margin-top: 8px;
      opacity: 0.9;
      font-style: italic;
    }
    main { max-width: var(--w); margin: 0 auto; padding: 20px; }
    .row { display:flex; flex-wrap:wrap; gap:12px; align-items:end; margin-bottom: 20px; }
    .panel { 
      background: rgba(20, 20, 40, 0.9); 
      border: 1px solid #d4af37; 
      border-radius: 15px; 
      padding: 16px;
      backdrop-filter: blur(5px);
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
    }
    .panel label {
      display: block;
      margin-bottom: 6px;
      font-weight: bold;
      color: #d4af37;
    }
    select, input, button { 
      padding: 10px 12px; 
      border: 1px solid #d4af37; 
      border-radius: 10px; 
      background: rgba(0,0,0,0.7);
      color: #d4af37;
      font-family: inherit;
    }
    select option {
      background: #1a1a2e;
      color: #d4af37;
    }
    button { 
      background: linear-gradient(45deg, #d4af37, #ffd700); 
      color: #0f0f23; 
      cursor: pointer; 
      font-weight: bold;
      border: none;
      transition: all 0.3s ease;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
    }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(350px,1fr)); gap: var(--gap); margin-top:20px; }
    .card { 
      background: rgba(20, 20, 40, 0.95); 
      border: 2px solid #d4af37; 
      border-radius: 20px; 
      padding: 20px; 
      display: flex; 
      gap: 16px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
      transition: all 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 35px rgba(212, 175, 55, 0.4);
    }
    .icon { 
      width: 80px; 
      height: 80px; 
      border-radius: 15px; 
      background: linear-gradient(45deg, #d4af37, #ffd700); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 42px; 
      color: #0f0f23;
      box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
    }
    .icon img {
      border-radius: 15px;
    }
    .meta { font-size: 14px; color: #a0a0c0; }
    .pill { 
      display: inline-block; 
      padding: 4px 12px; 
      border-radius: 20px; 
      background: rgba(212, 175, 55, 0.2); 
      border: 1px solid #d4af37;
      font-size: 12px; 
      margin-right: 8px;
      color: #d4af37;
      margin-bottom: 4px;
    }
    .lucky { 
      font-size: 14px; 
      color: #ffd700; 
      background: rgba(255, 215, 0, 0.1);
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ffd700;
      margin-top: 10px;
    }
    .card-title {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 8px;
      color: #ffd700;
    }
    .card-content {
      line-height: 1.6;
      color: #e0e0e0;
    }
    .usage-info {
      background: rgba(212, 175, 55, 0.1);
      border: 1px solid rgba(212, 175, 55, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin: 16px 0;
      text-align: center;
      color: #d4af37;
      font-size: 14px;
      font-weight: 500;
    }
    footer { 
      color: #a0a0c0; 
      font-size: 12px; 
      text-align: center; 
      padding: 20px;
      margin-top: 40px;
      border-top: 1px solid rgba(212, 175, 55, 0.3);
    }
    .compat-result {
      background: rgba(20, 20, 40, 0.95);
      border: 2px solid #d4af37;
      border-radius: 20px;
      padding: 20px;
      margin-top: 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(212, 175, 55, 0.3);
    }
    .compat-score {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ffd700;
      text-align: center;
      margin: 10px 0;
    }
    .loading {
      text-align: center;
      color: #ffd700;
      font-style: italic;
      padding: 20px;
    }
    hr {
      border: none;
      border-top: 1px solid rgba(212, 175, 55, 0.3);
      margin: 30px 0;
    }

  .upgrade-prompt {
      background: rgba(251, 191, 36, 0.1);
      border: 2px solid rgba(251, 191, 36, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      margin-top: 20px;
  }

  .upgrade-button {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #000;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
  }
  </style>
</head>
<body>
  <a href="javascript:history.back()" class="back-btn">‚Üê Back to Chat</a>
  
  <header>
    <div style="display: flex; align-items: center; justify-content: center; gap: 20px; flex-wrap: wrap;">
      <img src="/static/logos/horoscope sky.png" alt="Horoscope Sky" style="height: 80px; border-radius: 15px; box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);">
      <div>
        <h1 style="margin: 0;">Horoscope Sky</h1>
        <div class="subtitle">Your Daily Cosmic Guidance</div>
      </div>
    </div>
  </header>
  <main>
    <div class="row">
      <div class="panel">
        <label>üåü Choose Your Zodiac Sign
          <select id="sign">
            <option value="">Select your zodiac sign...</option>
            <option value="aries">Aries (Mar 21 ‚Äì Apr 19)</option>
            <option value="taurus">Taurus (Apr 20 ‚Äì May 20)</option>
            <option value="gemini">Gemini (May 21 ‚Äì Jun 20)</option>
            <option value="cancer">Cancer (Jun 21 ‚Äì Jul 22)</option>
            <option value="leo">Leo (Jul 23 ‚Äì Aug 22)</option>
            <option value="virgo">Virgo (Aug 23 ‚Äì Sep 22)</option>
            <option value="libra">Libra (Sep 23 ‚Äì Oct 22)</option>
            <option value="scorpio">Scorpio (Oct 23 ‚Äì Nov 21)</option>
            <option value="sagittarius">Sagittarius (Nov 22 ‚Äì Dec 21)</option>
            <option value="capricorn">Capricorn (Dec 22 ‚Äì Jan 19)</option>
            <option value="aquarius">Aquarius (Jan 20 ‚Äì Feb 18)</option>
            <option value="pisces">Pisces (Feb 19 ‚Äì Mar 20)</option>
          </select>
        </label>
      </div>
      <div class="panel">
        <label>üìÖ Reading Type
          <select id="period">
            <option value="daily">Daily Horoscope</option>
            <option value="weekly">Weekly Forecast</option>
            <option value="monthly">Monthly Reading</option>
          </select>
        </label>
      </div>
      <div class="panel">
        <label>üìÜ Specific Date (Optional)
          <input type="date" id="date" />
        </label>
        <small style="color: #a0a0c0; font-size: 11px;">Leave blank for today</small>
      </div>
      <div class="panel">
        <button id="go" style="font-size: 1.1rem; padding: 12px 20px;">‚ú® Get My Horoscope ‚ú®</button>
      </div>
      
      <!-- Upgrade Prompt -->
      <div class="upgrade-prompt" id="upgrade-prompt" style="display: none;">
        <h3 style="color: #fbbf24; margin-bottom: 12px;">üîì Unlock More Horoscope Readings</h3>
        <p>You've reached your daily limit. Upgrade to Silver (10 daily) or Gold (unlimited) for more horoscope readings plus premium features!</p>
        <button class="upgrade-button" onclick="window.location.href='/subscription'">
          Upgrade Now
        </button>
      </div>
    </div>
    
    <div id="usage-info" class="usage-info">
      Loading usage limits...
    </div>

    <div id="out" class="grid"></div>
    
    <!-- AdSense Ad Placement -->
    <div id="ad-container" style="text-align: center; margin: 20px 0; display: none;">
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-3869471953521437"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
    </div>

    <hr style="margin:20px 0; border:none; border-top:1px solid #eee"/>

    <div class="row">
      <div class="panel">
        <label>üíï First Sign
          <select id="compatA">
            <option value="">Select your zodiac sign...</option>
            <option value="aries">Aries (Mar 21 ‚Äì Apr 19)</option>
            <option value="taurus">Taurus (Apr 20 ‚Äì May 20)</option>
            <option value="gemini">Gemini (May 21 ‚Äì Jun 20)</option>
            <option value="cancer">Cancer (Jun 21 ‚Äì Jul 22)</option>
            <option value="leo">Leo (Jul 23 ‚Äì Aug 22)</option>
            <option value="virgo">Virgo (Aug 23 ‚Äì Sep 22)</option>
            <option value="libra">Libra (Sep 23 ‚Äì Oct 22)</option>
            <option value="scorpio">Scorpio (Oct 23 ‚Äì Nov 21)</option>
            <option value="sagittarius">Sagittarius (Nov 22 ‚Äì Dec 21)</option>
            <option value="capricorn">Capricorn (Dec 22 ‚Äì Jan 19)</option>
            <option value="aquarius">Aquarius (Jan 20 ‚Äì Feb 18)</option>
            <option value="pisces">Pisces (Feb 19 ‚Äì Mar 20)</option>
          </select>
        </label>
      </div>
      <div class="panel">
        <label>üíï Second Sign
          <select id="compatB">
            <option value="">Select your zodiac sign...</option>
            <option value="aries">Aries (Mar 21 ‚Äì Apr 19)</option>
            <option value="taurus">Taurus (Apr 20 ‚Äì May 20)</option>
            <option value="gemini">Gemini (May 21 ‚Äì Jun 20)</option>
            <option value="cancer">Cancer (Jun 21 ‚Äì Jul 22)</option>
            <option value="leo">Leo (Jul 23 ‚Äì Aug 22)</option>
            <option value="virgo">Virgo (Aug 23 ‚Äì Sep 22)</option>
            <option value="libra">Libra (Sep 23 ‚Äì Oct 22)</option>
            <option value="scorpio">Scorpio (Oct 23 ‚Äì Nov 21)</option>
            <option value="sagittarius">Sagittarius (Nov 22 ‚Äì Dec 21)</option>
            <option value="capricorn">Capricorn (Dec 22 ‚Äì Jan 19)</option>
            <option value="aquarius">Aquarius (Jan 20 ‚Äì Feb 18)</option>
            <option value="pisces">Pisces (Feb 19 ‚Äì Mar 20)</option>
          </select>
        </label>
      </div>
      <div class="panel">
        <label>üí´ Relationship Type
          <select id="compatType">
            <option value="romantic">üíñ Romantic Partnership</option>
            <option value="friendship">üëØ Friendship</option>
          </select>
        </label>
      </div>
      <div class="panel">
        <button id="compatGo" style="font-size: 1.1rem; padding: 12px 20px;">‚ú® Check Compatibility ‚ú®</button>
      </div>
    </div>
    <div id="compat"></div>
  </main>
  <footer>‚ú® Horoscope Sky's cosmic guidance ‚Ä¢ Celestial wisdom for your journey through the stars ‚ú®</footer>

<script>
const EXT = ".png";
const ICON = (s) => `/static/horoscope/${s}${EXT}`;
const pretty = (s) => s[0].toUpperCase()+s.slice(1);

async function fetchPeriod(sign, period, date){
  const body = { sign, period };
  if (date) body.date = date;
  const r = await fetch("/api/horoscope/period", {
    method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body)
  });
  return await r.json();
}

function card(h){
  const m = h.meta;
  return `
  <div class="card">
    <div class="icon"><img src="${ICON(h.sign)}" onerror="this.style.display='none'; this.parentElement.textContent=m.glyph" alt="${m.name}" width="80" height="80"/></div>
    <div style="flex: 1;">
      <div class="card-title">${m.name} ${h.period.charAt(0).toUpperCase() + h.period.slice(1)}</div>
      <div class="meta">${m.glyph} ‚Ä¢ ${m.dates}</div>
      <div style="margin: 10px 0;">
        <span class="pill">${m.element}</span>
        <span class="pill">${m.modality}</span>
        <span class="pill">${m.planet}</span>
      </div>
      <div class="card-content">${h.summary}</div>
      <div class="lucky">
        ‚ú® <strong>Cosmic Gifts:</strong> ${h.lucky.color} energy, ${h.lucky.time} power hour, numbers ${h.lucky.numbers.join(", ")}, ${h.lucky.mood} vibes
      </div>
      <div style="margin-top: 15px; text-align: center;">
        <button onclick="interpretReading('${h.sign}', '${h.period}', '${h.date}')" style="font-size: 0.95rem; padding: 8px 16px;">üîÆ Interpret My Reading üîÆ</button>
      </div>
      <div id="interpretation-${h.sign}-${h.period}" style="display: none; margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; border-left: 4px solid #d4af37;">
        <div class="loading">‚ú® Channeling deeper cosmic insights...</div>
      </div>
    </div>
  </div>`;
}

async function getHoroscope() {
  const s = document.getElementById("sign").value;
  const p = document.getElementById("period").value;
  const d = document.getElementById("date").value;
  const out = document.getElementById("out");
  
  if (!s) {
    out.innerHTML = "<div style='color:#ff6b6b; padding: 20px; text-align: center;'>Please select your zodiac sign first!</div>";
    return;
  }
  
  out.innerHTML = "<div class='loading'>‚ú® Consulting the cosmic energies...</div>";
  
  try {
    const h = await fetchPeriod(s, p, d || null);
    if (h.error) { 
      out.innerHTML = `<div style="color:#ff6b6b; padding: 20px; text-align: center;">${h.error}</div>`; 
      return; 
    }
    out.innerHTML = card(h);
    
    // Show ad after results (only for non-ad-free users)
    if (window.__AD_FREE__ !== true && window.__AD_FREE__ !== 'true') {
        const adContainer = document.getElementById('ad-container');
        if (adContainer) {
            adContainer.style.display = 'block';
            // Trigger AdSense
            try {
                (adsbygoogle = window.adsbygoogle || []).push({});
            } catch (e) {
                console.log('AdSense not ready yet');
            }
        }
    }
    
    // Refresh usage limits after successful horoscope generation
    loadUsageLimits();
  } catch (error) {
    out.innerHTML = `<div style="color:#ff6b6b; padding: 20px; text-align: center;">Connection error. Please try again.</div>`;
  }
}

// Simple button-only approach - no auto-triggering
document.getElementById("go").addEventListener("click", getHoroscope);

async function interpretReading(sign, period, date) {
  const interpretDiv = document.getElementById(`interpretation-${sign}-${period}`);
  
  if (interpretDiv.style.display === 'none') {
    interpretDiv.style.display = 'block';
    
    try {
      const body = { sign, period };
      if (date) body.date = date;
      
      const r = await fetch("/api/horoscope/interpret", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      
      const data = await r.json();
      
      if (data.error) {
        interpretDiv.innerHTML = `<div style="color:#ff6b6b;">${data.error}</div>`;
        return;
      }
      
      interpretDiv.innerHTML = `
        <div style="color: #d4af37; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #d4af37; padding-bottom: 8px;">
          üîÆ Deeper Cosmic Insights
        </div>
        <div style="line-height: 1.7; color: #e8e8e8; font-style: italic;">
          ${data.interpretation}
        </div>
      `;
    } catch (error) {
      interpretDiv.innerHTML = `<div style="color:#ff6b6b;">Connection error. Please try again.</div>`;
    }
  } else {
    interpretDiv.style.display = 'none';
  }
}

async function interpretCompatibility(a, b, score, type) {
  const interpretDiv = document.getElementById(`compat-interpretation-${a}-${b}`);
  
  if (interpretDiv.style.display === 'none') {
    interpretDiv.style.display = 'block';
    
    try {
      const body = { a, b, type };
      
      const r = await fetch("/api/horoscope/interpret-compat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      
      const data = await r.json();
      
      if (data.error) {
        interpretDiv.innerHTML = `<div style="color:#ff6b6b;">${data.error}</div>`;
        return;
      }
      
      // Convert markdown-style formatting to HTML
      let interpretation = data.interpretation
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/‚Ä¢ /g, '‚Ä¢ ');
      
      interpretDiv.innerHTML = `
        <div style="color: #d4af37; font-weight: bold; margin-bottom: 10px; border-bottom: 1px solid #d4af37; padding-bottom: 8px;">
          üí´ Compatibility Analysis
        </div>
        <div style="line-height: 1.7; color: #e8e8e8;">
          ${interpretation}
        </div>
      `;
    } catch (error) {
      interpretDiv.innerHTML = `<div style="color:#ff6b6b;">Connection error. Please try again.</div>`;
    }
  } else {
    interpretDiv.style.display = 'none';
  }
}

document.getElementById("compatGo").addEventListener("click", async () => {
  const a = document.getElementById("compatA").value;
  const b = document.getElementById("compatB").value;
  const type = document.getElementById("compatType").value;
  const wrap = document.getElementById("compat");
  
  if (!a || !b) {
    wrap.innerHTML = `<div style="color:#ff6b6b; padding: 20px; text-align: center;">Please select both zodiac signs!</div>`;
    return;
  }
  
  wrap.innerHTML = `<div class="loading">‚ú® Analyzing cosmic compatibility...</div>`;
  
  try {
    const r = await fetch(`/api/horoscope/compat?a=${a}&b=${b}&type=${type}`);
    const d = await r.json();
    if (d.error) { 
      wrap.innerHTML = `<div style="color:#ff6b6b; padding: 20px; text-align: center;">${d.error}</div>`; 
      return; 
    }
    wrap.innerHTML = `<div class="compat-result">
      <div class="card-title" style="text-align: center;">${pretty(d.a)} √ó ${pretty(d.b)} Compatibility</div>
      <div class="compat-score">${d.score}%</div>
      <div class="meta" style="text-align: center;">${d.note}</div>
      <div style="margin-top: 15px; text-align: center;">
        <button onclick="interpretCompatibility('${d.a}', '${d.b}', ${d.score}, '${d.type}')" style="font-size: 0.95rem; padding: 8px 16px;">üí´ Why This Score? üí´</button>
      </div>
      <div id="compat-interpretation-${d.a}-${d.b}" style="display: none; margin-top: 15px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 10px; border-left: 4px solid #d4af37;">
        <div class="loading">‚ú® Analyzing cosmic compatibility factors...</div>
      </div>
    </div>`;
  } catch (error) {
    wrap.innerHTML = `<div style="color:#ff6b6b; padding: 20px; text-align: center;">Connection error. Please try again.</div>`;
  }
});

// Load usage limits on page load
async function loadUsageLimits() {
    try {
        const response = await fetch('/api/horoscope/limits');
        const data = await response.json();
        
        if (data.success) {
            const usageInfo = document.getElementById('usage-info');
            const tierDisplay = data.user_tier.charAt(0).toUpperCase() + data.user_tier.slice(1);
            const tierEmoji = data.user_tier === 'gold' ? 'ü•á' : data.user_tier === 'silver' ? 'ü•à' : 'ü•â';
            const remaining = data.remaining;
            
            if (data.unlimited || remaining >= 999) {
                usageInfo.innerHTML = `${tierEmoji} ${tierDisplay} Tier - Unlimited horoscope readings available`;
            } else {
                usageInfo.innerHTML = `${tierEmoji} ${tierDisplay} Tier - ${remaining} horoscope readings remaining today (${data.usage_today}/${data.daily_limit} used)`;
                
                if (remaining === 0) {
                    usageInfo.style.background = 'rgba(239, 68, 68, 0.1)';
                    usageInfo.style.borderColor = 'rgba(239, 68, 68, 0.3)';
                    document.getElementById('go').disabled = true;
                    document.getElementById('go').textContent = 'üîÆ Daily Limit Reached';
                    document.getElementById('upgrade-prompt').style.display = 'block';
                }
            }
        } else {
            document.getElementById('usage-info').innerHTML = 'ü•â Bronze Tier - 0/5 horoscope readings used today';
        }
    } catch (error) {
        console.error('Failed to load usage limits:', error);
        document.getElementById('usage-info').innerHTML = 'ü•â Bronze Tier - 0/5 horoscope readings used today';
    }
}

// Load limits on page load
document.addEventListener('DOMContentLoaded', loadUsageLimits);
</script>
</body>
</html>