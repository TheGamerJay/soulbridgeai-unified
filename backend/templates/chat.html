<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with {{ companion_display_name or 'AI Assistant' }} - SoulBridge AI</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <meta name="theme-color" content="#00ffff">
    
    <!-- Open Graph / Social Media Meta Tags -->
    <meta property="og:title" content="SoulBridge AI - Chat with {{ companion_display_name or 'AI Assistant' }}">
    <meta property="og:description" content="Your AI companion for emotional wellness and spiritual growth">
    <meta property="og:image" content="{{ url_for('static', filename='logos/IntroLogo.png', _external=True) }}">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="SoulBridge AI">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="SoulBridge AI">
    <meta name="twitter:description" content="Your AI companion for emotional wellness and spiritual growth">
    <meta name="twitter:image" content="{{ url_for('static', filename='logos/IntroLogo.png', _external=True) }}">
    
    <!-- CSS with aggressive cache busting -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}?v={{ range(1000000) | random }}&t={{ range(1000000) | random }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}?v=tier-fix-{{ range(1000000) | random }}&t={{ range(1000000) | random }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Force no cache for this page -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div class="chat-container">
        <!-- Header -->
        <div class="chat-header">
            <div class="character-info">
                <img src="{{ companion_avatar or '/static/logos/New IntroLogo.png' }}" alt="{{ companion_display_name or 'AI Companion' }}" class="character-avatar">
                <div class="character-details">
                    <h2 data-character="{{ companion or 'AI Assistant' }}">{{ companion_display_name or 'AI Assistant' }}</h2>
                    <div class="character-status">
                        <span class="status-indicator"></span>
                        Online and ready to chat
                    </div>
                </div>
            </div>
            
            <div class="header-actions">
                <!-- BASIC FEATURES - Available to all users -->
                <a href="/tiers" class="action-btn">
                    <i class="fas fa-exchange-alt"></i>
                    Switch
                </a>
                
                <!-- Color Palette Button (Silver/Gold users only) -->
                {% if companion_tier == 'silver' or companion_tier == 'gold' %}
                <button onclick="toggleThemeSelector()" class="action-btn theme-selector-btn {% if companion_tier == 'gold' %}gold-theme-btn{% endif %}">
                    <i class="fas fa-palette"></i>
                    {% if companion_tier == 'gold' %}üåü Themes{% else %}üé® Themes{% endif %}
                </button>
                {% endif %}
                
                {% if companion_tier == 'silver' or companion_tier == 'gold' %}
                <button id="voiceChatBtn" class="action-btn voice-chat" onclick="toggleVoiceChat()" title="Full Voice Chat - Record and get AI response">
                    <i class="fas fa-phone"></i>
                    Voice Chat
                </button>
                {% endif %}
                <a href="/library" class="action-btn">
                    <i class="fas fa-book"></i>
                    Library
                </a>
                
                <!-- TIER ISOLATED FEATURES - Show to ALL users with their tier limits -->
                <!-- Free: 3/2/3, Growth: 15/8/10, Max: ‚àû -->
                <a href="/decoder" class="action-btn tier-btn" data-feature="decoder">
                    <i class="fas fa-brain"></i>
                    <div class="btn-content">
                        <span class="btn-title">üß† Decoder</span>
                    </div>
                </a>
                <a href="/fortune" class="action-btn tier-btn" data-feature="fortune">
                    <i class="fas fa-crystal-ball"></i>
                    <div class="btn-content">
                        <span class="btn-title">üîÆ Fortune</span>
                    </div>
                </a>
                <a href="/horoscope" class="action-btn tier-btn" data-feature="horoscope">
                    <i class="fas fa-star"></i>
                    <div class="btn-content">
                        <span class="btn-title">‚≠ê Horoscope</span>
                    </div>
                </a>
                
                <!-- COMPANION-TIER ARCHITECTURE: Each companion shows features based on its tier -->
                <!-- DEBUG: companion_tier = "{{ companion_tier }}" -->
                
                <!-- COMPANION-TIER-BASED FEATURES: Show features based on companion's tier -->
                <!-- Silver features: Show when companion is Silver/Gold tier -->
                {% if companion_tier == 'silver' or companion_tier == 'gold' %}
                <a href="/voice-journaling" class="action-btn" data-tier="silver">
                    <i class="fas fa-microphone"></i>
                    Voice Journal
                </a>
                <a href="/ai-image-generation" class="action-btn" data-tier="silver">
                    <i class="fas fa-palette"></i>
                    AI Images
                </a>
                <a href="/relationship-profiles" class="action-btn" data-tier="silver">
                    <i class="fas fa-heart"></i>
                    Relationships
                </a>
                <a href="/emotional-meditations" class="action-btn" data-tier="silver">
                    <i class="fas fa-om"></i>
                    Meditations
                </a>
                {% endif %}
                
                <!-- Gold exclusive features: Show when companion is Gold tier -->
                {% if companion_tier == 'gold' %}
                <a href="/mini-studio" class="action-btn" data-tier="gold">
                    <i class="fas fa-robot"></i>
                    Mini Studio
                </a>
                {% endif %}
                <a href="/creative-writing" class="action-btn creative-btn tier-btn" data-feature="creative_writer" title="Creative Writing Assistant">
                    <i class="fas fa-feather-alt"></i>
                    <div class="btn-content">
                        <span class="btn-title">Write</span>
                    </div>
                </a>
                
                <!-- DUPLICATE SECTION REMOVED - Using isolated tier blocks above -->
                
                <button onclick="saveConversationToLibrary()" class="action-btn" title="Save current conversation to library">
                    <i class="fas fa-save"></i>
                    Save
                </button>
                <button onclick="clearChat()" class="action-btn">
                    <i class="fas fa-trash"></i>
                    Clear
                </button>
                <a href="/intro" class="action-btn danger">
                    <i class="fas fa-home"></i>
                    Home
                </a>
                
                <!-- Timer removed from chat page - too distracting during conversations -->

                
                <!-- Trial Badge (shows when trial is active) -->
                <div class="trial-status-container">
                    <!-- Removed redundant trial badge - timer banner shows trial status -->
                    <div id="trial-banner" style="display: {% if session.get('trial_active') %}flex{% else %}none{% endif %}; align-items: center; gap: 15px; background: rgba(34, 211, 238, 0.1); border: 1px solid rgba(34, 211, 238, 0.3); border-radius: 12px; padding: 8px 12px; color: #22d3ee; font-weight: bold;">
                        <div><strong><i class="fas fa-clock"></i> Trial Active</strong></div>
                        <div id="trial-circular-timer"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Netflix-Style Theme Modal Backdrop -->
        <div id="themeModalBackdrop" class="theme-modal-backdrop" style="display: none;" onclick="toggleThemeSelector()"></div>
        
        <!-- Enhanced Theme Customization Panel (Silver/Gold users only) -->
        {% if companion_tier == 'silver' or companion_tier == 'gold' %}
        <div id="themeSelector" class="enhanced-theme-panel" style="display: none;">
            <div class="theme-panel-header">
                <h3>üé® {% if companion_tier == 'gold' %}Premium{% else %}Silver{% endif %} Theme Customization</h3>
                <button class="theme-close-btn" onclick="toggleThemeSelector()">√ó</button>
            </div>
            
            <!-- Background Color Section -->
            <div class="theme-section">
                <div class="section-header">
                    <i class="fas fa-image"></i>
                    <h4>Background Colors</h4>
                </div>
                <div class="color-grid background-colors">
                    {% if companion_tier == 'gold' %}
                    <!-- Gold Background Options -->
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #ffd700, #ffb347)" title="Classic Gold">
                        <div class="color-preview" style="background: linear-gradient(135deg, #ffd700, #ffb347);"></div>
                        <span>Classic Gold</span>
                    </div>
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #1a0033, #2d1b69)" title="Royal Purple">
                        <div class="color-preview" style="background: linear-gradient(135deg, #1a0033, #2d1b69);"></div>
                        <span>Royal Purple</span>
                    </div>
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #0d2818, #1a5a3e)" title="Emerald Green">
                        <div class="color-preview" style="background: linear-gradient(135deg, #0d2818, #1a5a3e);"></div>
                        <span>Emerald</span>
                    </div>
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #0a1a33, #1a3a6b)" title="Sapphire Blue">
                        <div class="color-preview" style="background: linear-gradient(135deg, #0a1a33, #1a3a6b);"></div>
                        <span>Sapphire</span>
                    </div>
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #330a1a, #6b1a3a)" title="Ruby Red">
                        <div class="color-preview" style="background: linear-gradient(135deg, #330a1a, #6b1a3a);"></div>
                        <span>Ruby</span>
                    </div>
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e)" title="Cosmic Dark">
                        <div class="color-preview" style="background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);"></div>
                        <span>Cosmic</span>
                    </div>
                    {% else %}
                    <!-- Silver Background Options -->
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #0a1a33, #1a3a6b)" title="Ocean Blue">
                        <div class="color-preview" style="background: linear-gradient(135deg, #0a1a33, #1a3a6b);"></div>
                        <span>Ocean</span>
                    </div>
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #1a0033, #2d1b69)" title="Purple Night">
                        <div class="color-preview" style="background: linear-gradient(135deg, #1a0033, #2d1b69);"></div>
                        <span>Purple</span>
                    </div>
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #0d2818, #1a5a3e)" title="Forest Green">
                        <div class="color-preview" style="background: linear-gradient(135deg, #0d2818, #1a5a3e);"></div>
                        <span>Forest</span>
                    </div>
                    <div class="color-option" data-type="background" data-value="linear-gradient(135deg, #330a1a, #6b1a3a)" title="Crimson">
                        <div class="color-preview" style="background: linear-gradient(135deg, #330a1a, #6b1a3a);"></div>
                        <span>Crimson</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Text Color Section -->
            <div class="theme-section">
                <div class="section-header">
                    <i class="fas fa-font"></i>
                    <h4>Text Colors</h4>
                </div>
                <div class="color-grid text-colors">
                    <!-- Universal Text Colors -->
                    <div class="color-option" data-type="text" data-value="#ffffff" title="Pure White">
                        <div class="color-preview" style="background: #ffffff;"></div>
                        <span>White</span>
                    </div>
                    <div class="color-option" data-type="text" data-value="#00ffff" title="Cyan">
                        <div class="color-preview" style="background: #00ffff;"></div>
                        <span>Cyan</span>
                    </div>
                    <div class="color-option" data-type="text" data-value="#ffd700" title="Gold">
                        <div class="color-preview" style="background: #ffd700;"></div>
                        <span>Gold</span>
                    </div>
                    <div class="color-option" data-type="text" data-value="#ff69b4" title="Hot Pink">
                        <div class="color-preview" style="background: #ff69b4;"></div>
                        <span>Pink</span>
                    </div>
                    <div class="color-option" data-type="text" data-value="#98fb98" title="Pale Green">
                        <div class="color-preview" style="background: #98fb98;"></div>
                        <span>Green</span>
                    </div>
                    <div class="color-option" data-type="text" data-value="#dda0dd" title="Plum">
                        <div class="color-preview" style="background: #dda0dd;"></div>
                        <span>Purple</span>
                    </div>
                    {% if companion_tier == 'gold' %}
                    <!-- Additional Gold Text Colors -->
                    <div class="color-option" data-type="text" data-value="#ff6347" title="Tomato">
                        <div class="color-preview" style="background: #ff6347;"></div>
                        <span>Coral</span>
                    </div>
                    <div class="color-option" data-type="text" data-value="#40e0d0" title="Turquoise">
                        <div class="color-preview" style="background: #40e0d0;"></div>
                        <span>Turquoise</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Quick Presets Section -->
            <div class="theme-section">
                <div class="section-header">
                    <i class="fas fa-magic"></i>
                    <h4>Quick Presets</h4>
                </div>
                <div class="preset-buttons">
                    <button class="preset-btn" data-preset="default">üåä Ocean Default</button>
                    <button class="preset-btn" data-preset="dark">üåô Midnight Dark</button>
                    <button class="preset-btn" data-preset="warm">üî• Warm Sunset</button>
                    {% if companion_tier == 'gold' %}
                    <button class="preset-btn" data-preset="gold">üëë Royal Gold</button>
                    <button class="preset-btn" data-preset="cosmic">‚ú® Cosmic Aurora</button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Messages Area -->
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be added here by JavaScript -->
        </div>
        
        <!-- Input Area -->
        <div class="chat-input-area">
            <div class="input-container">
                <button id="speechBtn" class="speech-button" title="Click to speak">
                    <i class="fas fa-microphone"></i>
                </button>
                <textarea 
                    id="messageInput" 
                    class="message-input" 
                    placeholder="Type your message here or click the microphone to speak..." 
                    rows="1"
                ></textarea>
                <button class="send-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            <div id="speechStatus" class="speech-status">Click microphone to start voice input</div>
        </div>
    </div>

    <!-- Trial Audio Alert - Disabled until audio files are added -->
    <!-- <audio id="trial-alert-sound" preload="auto">
        <source src="/static/sounds/trial-alert.mp3" type="audio/mpeg">
        <source src="/static/sounds/trial-alert.ogg" type="audio/ogg">
    </audio> -->

    <!-- Confetti Canvas -->
    <canvas id="confetti-canvas" class="hidden" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>

    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    
    <!-- Include Circular Trial Timer -->
    <script src="{{ url_for('static', filename='js/circular-trial-timer.js') }}"></script>

    <!-- JavaScript -->
    <script>
        // Set session flag for logged-in users
        sessionStorage.setItem('loggedIn', 'true');
        
        // Removed aggressive session check - server-side authentication handles this properly

        // Disclaimer removed - keeping chat interface clean and distraction-free
    </script>
    
    <!-- Creative Writing Modal -->
    <div id="creativeWritingModal" class="modal" style="display: none;">
        <div class="modal-overlay" onclick="closeCreativeWriting()"></div>
        <div class="modal-content creative-modal">
            <div class="modal-header">
                <h2><i class="fas fa-feather-alt"></i> Creative Writing Assistant</h2>
                <div class="usage-counter-display" id="creativeWritingUsageCounter" style="text-align: center; color: #22d3ee; font-size: 0.9rem; margin-top: 0.5rem; font-weight: 600;">
                    Loading usage...
                </div>
                <button class="close-btn" onclick="closeCreativeWriting()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="writing-intro">
                    <p class="assistant-greeting">
                        <i class="fas fa-sparkles"></i> 
                        Welcome to your personal Creative Writing Assistant! I'm here to help you craft beautiful poetry, inspiring stories, personal reflections, and more. 
                        Whether you're looking to express emotions through verse, create compelling narratives, or simply explore your creativity, I'll provide personalized guidance and suggestions to bring your ideas to life.
                        <br><br>
                        <strong>Choose a writing mode below to get started:</strong>
                    </p>
                </div>
                <div class="writing-modes">
                    <h3>Choose Your Creative Mode:</h3>
                    <div class="mode-grid">
                        <button class="mode-btn" onclick="selectWritingMode('poetry')" data-mode="poetry">
                            <i class="fas fa-heart"></i>
                            <span>Poetry & Verses</span>
                            <small>Beautiful poems to express emotions</small>
                        </button>
                        <button class="mode-btn" onclick="selectWritingMode('inspiration')" data-mode="inspiration">
                            <i class="fas fa-lightbulb"></i>
                            <span>Daily Inspiration</span>
                            <small>Uplifting quotes and affirmations</small>
                        </button>
                        <button class="mode-btn" onclick="selectWritingMode('story')" data-mode="story">
                            <i class="fas fa-book-open"></i>
                            <span>Short Stories</span>
                            <small>Creative mini-stories and scenarios</small>
                        </button>
                        <button class="mode-btn" onclick="selectWritingMode('music')" data-mode="music">
                            <i class="fas fa-music"></i>
                            <span>Music & Lyrics</span>
                            <small>Songs, lyrics, and musical ideas</small>
                        </button>
                        <button class="mode-btn" onclick="selectWritingMode('thoughts')" data-mode="thoughts">
                            <i class="fas fa-brain"></i>
                            <span>Thoughts & Notes</span>
                            <small>Journal entries and personal reflections</small>
                        </button>
                        <button class="mode-btn" onclick="selectWritingMode('letter')" data-mode="letter">
                            <i class="fas fa-envelope-open-text"></i>
                            <span>Personal Letters</span>
                            <small>Letters to yourself or loved ones</small>
                        </button>
                        <button class="mode-btn" onclick="selectWritingMode('canvas')" data-mode="canvas">
                            <i class="fas fa-palette"></i>
                            <span>Creative Canvas</span>
                            <small>Art therapy and emotional expression</small>
                        </button>
                    </div>
                </div>
                
                <div class="writing-input" id="writingInput" style="display: none;">
                    <h3 id="modeTitle">Creative Writing</h3>
                    <textarea id="writingPrompt" placeholder="Describe what you'd like help with..." rows="4"></textarea>
                    <div class="mood-selector">
                        <label>Mood/Tone:</label>
                        <select id="moodSelect" onchange="toggleCustomMood()">
                            <option value="uplifting">Uplifting & Positive</option>
                            <option value="calming">Calm & Peaceful</option>
                            <option value="motivational">Motivational & Energizing</option>
                            <option value="romantic">Romantic & Loving</option>
                            <option value="reflective">Reflective & Thoughtful</option>
                            <option value="playful">Playful & Fun</option>
                            <option value="custom">Custom (Write Your Own)</option>
                        </select>
                        <div id="customMoodInput" style="display: none; margin-top: 10px;">
                            <input type="text" id="customMood" placeholder="Describe your desired mood/tone (e.g., mysterious, nostalgic, adventurous...)" 
                                   style="width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(34, 211, 238, 0.3); 
                                          border-radius: 8px; color: #e2e8f0; font-size: 1rem;" maxlength="100">
                            <small style="color: #94a3b8; font-size: 0.8rem; margin-top: 5px; display: block;">
                                Keep it appropriate and descriptive (max 100 characters)
                            </small>
                        </div>
                    </div>
                    <button onclick="generateCreativeContent()" class="generate-btn">
                        <i class="fas fa-magic"></i> Generate Creative Content
                    </button>
                </div>
                
                <div class="writing-output" id="writingOutput" style="display: none;">
                    <div class="output-header">
                        <h3>Your Creative Content</h3>
                        <div class="output-actions">
                            <button onclick="copyCreativeContent()" class="copy-btn">
                                <i class="fas fa-copy"></i> Copy
                            </button>
                            <button onclick="readContentAloud()" class="read-btn" id="readBtn">
                                <i class="fas fa-volume-up"></i> Read Aloud
                            </button>
                            <button onclick="toggleTranslation()" class="translate-btn" id="translateBtn">
                                <i class="fas fa-language"></i> Translate
                            </button>
                            <button onclick="saveToLibrary()" class="save-btn">
                                <i class="fas fa-bookmark"></i> Save
                            </button>
                            <button onclick="exportCreativeContent()" class="export-btn">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <button onclick="shareToWellnessGallery()" class="share-btn">
                                <i class="fas fa-heart"></i> Share Anonymously
                            </button>
                        </div>
                    </div>
                    <div class="generated-content" id="generatedContent"></div>
                    
                    <!-- Translation Panel -->
                    <div class="translation-panel" id="translationPanel" style="display: none;">
                        <h4><i class="fas fa-language"></i> Translation Options</h4>
                        <div class="language-controls">
                            <label for="targetLanguage">Translate to:</label>
                            <select id="targetLanguage">
                                <option value="es">Spanish (Espa√±ol)</option>
                                <option value="fr">French (Fran√ßais)</option>
                                <option value="de">German (Deutsch)</option>
                                <option value="it">Italian (Italiano)</option>
                                <option value="pt">Portuguese (Portugu√™s)</option>
                                <option value="ru">Russian (–†—É—Å—Å–∫–∏–π)</option>
                                <option value="ja">Japanese (Êó•Êú¨Ë™û)</option>
                                <option value="ko">Korean (ÌïúÍµ≠Ïñ¥)</option>
                                <option value="zh">Chinese (‰∏≠Êñá)</option>
                                <option value="ar">Arabic (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</option>
                                <option value="hi">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                                <option value="nl">Dutch (Nederlands)</option>
                                <option value="sv">Swedish (Svenska)</option>
                                <option value="no">Norwegian (Norsk)</option>
                                <option value="da">Danish (Dansk)</option>
                                <option value="pl">Polish (Polski)</option>
                                <option value="tr">Turkish (T√ºrk√ße)</option>
                                <option value="he">Hebrew (◊¢◊ë◊®◊ô◊™)</option>
                                <option value="th">Thai (‡πÑ‡∏ó‡∏¢)</option>
                                <option value="vi">Vietnamese (Ti·∫øng Vi·ªát)</option>
                            </select>
                            <button onclick="translateContent()" class="translate-action-btn">
                                <i class="fas fa-globe"></i> Translate
                            </button>
                        </div>
                        <div class="translated-content" id="translatedContent" style="display: none;"></div>
                    </div>
                    
                    <button onclick="resetCreativeWriting()" class="reset-btn">
                        <i class="fas fa-redo"></i> Create Another
                    </button>
                </div>
                
                <!-- Canvas Mode Interface -->
                <div class="canvas-interface" id="canvasInterface" style="display: none;">
                    <h3 id="canvasTitle">Creative Canvas</h3>
                    <div class="canvas-prompt-section">
                        <textarea id="canvasPrompt" placeholder="What emotions or ideas would you like to express through art?" rows="3"></textarea>
                        <div class="mood-selector">
                            <label>Art Focus:</label>
                            <select id="canvasTheme">
                                <option value="mood">Express Current Mood</option>
                                <option value="stress">Release Stress & Tension</option>
                                <option value="gratitude">Gratitude & Joy</option>
                                <option value="peace">Find Inner Peace</option>
                                <option value="growth">Personal Growth</option>
                                <option value="dreams">Dreams & Aspirations</option>
                                <option value="healing">Healing & Recovery</option>
                                <option value="freeform">Free Expression</option>
                            </select>
                        </div>
                        <button onclick="startArtTherapy()" class="generate-btn">
                            <i class="fas fa-paint-brush"></i> Start Art Therapy Session
                        </button>
                    </div>
                </div>
                
                <!-- Canvas Drawing Area -->
                <div class="canvas-drawing" id="canvasDrawing" style="display: none;">
                    <div class="canvas-header">
                        <h3 id="canvasInstructions">Let your emotions flow through art</h3>
                        <div class="canvas-tools">
                            <div class="tool-group">
                                <label>Brush Size:</label>
                                <input type="range" id="brushSize" min="2" max="20" value="5">
                                <span id="brushSizeValue">5px</span>
                            </div>
                            <div class="tool-group">
                                <label>Color:</label>
                                <input type="color" id="brushColor" value="#22d3ee">
                            </div>
                            <div class="tool-group">
                                <button onclick="clearCanvas()" class="tool-btn">
                                    <i class="fas fa-eraser"></i> Clear
                                </button>
                                <button onclick="undoCanvas()" class="tool-btn">
                                    <i class="fas fa-undo"></i> Undo
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="canvas-container">
                        <canvas id="artCanvas" width="600" height="400"></canvas>
                    </div>
                    
                    <div class="canvas-actions">
                        <button onclick="saveCanvasArt()" class="save-btn">
                            <i class="fas fa-bookmark"></i> Save to Library
                        </button>
                        <button onclick="exportCanvasArt()" class="export-btn">
                            <i class="fas fa-download"></i> Export Art
                        </button>
                        <button onclick="shareCanvasToWellnessGallery()" class="share-btn">
                            <i class="fas fa-heart"></i> Share Anonymously
                        </button>
                        <button onclick="resetCanvas()" class="reset-btn">
                            <i class="fas fa-redo"></i> New Canvas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .creative-modal {
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .writing-intro {
            margin-bottom: 25px;
            text-align: center;
        }
        
        .assistant-greeting {
            background: rgba(34, 211, 238, 0.1);
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            padding: 20px;
            color: #e2e8f0;
            line-height: 1.6;
            margin: 0;
        }
        
        .assistant-greeting i {
            color: #22d3ee;
            margin-right: 8px;
        }
        
        .mode-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .mode-btn {
            background: rgba(34, 211, 238, 0.1);
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            padding: 20px 15px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .mode-btn:hover, .mode-btn.active {
            background: rgba(34, 211, 238, 0.2);
            border-color: #22d3ee;
            transform: translateY(-2px);
        }
        
        .mode-btn i {
            font-size: 2rem;
            color: #22d3ee;
            margin-bottom: 10px;
            display: block;
        }
        
        .mode-btn span {
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }
        
        .mode-btn small {
            color: #94a3b8;
            font-size: 0.8rem;
        }
        
        .writing-input textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: #e2e8f0;
            font-size: 1rem;
            margin: 15px 0;
            resize: vertical;
        }
        
        .mood-selector {
            margin: 15px 0;
        }
        
        .mood-selector label {
            color: #22d3ee;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }
        
        .mood-selector select {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #e2e8f0;
            font-size: 1rem;
        }
        
        .generate-btn {
            background: linear-gradient(135deg, #22d3ee, #0891b2);
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            font-size: 1.1rem;
            margin: 15px 0;
            transition: all 0.3s ease;
        }
        
        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(34, 211, 238, 0.3);
        }
        
        .generated-content {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            white-space: pre-wrap;
            line-height: 1.6;
            color: #e2e8f0;
        }
        
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .output-actions {
            display: flex;
            gap: 10px;
        }
        
        .copy-btn, .save-btn, .export-btn, .share-btn, .reset-btn, .read-btn, .translate-btn {
            background: rgba(34, 211, 238, 0.2);
            border: 1px solid #22d3ee;
            border-radius: 6px;
            padding: 8px 16px;
            color: #22d3ee;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .copy-btn:hover, .save-btn:hover, .export-btn:hover, .share-btn:hover, .reset-btn:hover, .read-btn:hover, .translate-btn:hover {
            background: rgba(34, 211, 238, 0.3);
        }
        
        .share-btn {
            background: rgba(255, 182, 193, 0.2) !important;
            border-color: #ffb6c1 !important;
            color: #ffb6c1 !important;
        }
        
        .share-btn:hover {
            background: rgba(255, 182, 193, 0.3) !important;
            transform: scale(1.05);
        }
        
        .creative-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed) !important;
            border: 2px solid rgba(139, 92, 246, 0.3) !important;
        }
        
        .creative-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9) !important;
            border-color: #8b5cf6 !important;
        }
        
        /* Text-to-Speech and Translation Button Styles */
        .read-btn {
            background: rgba(34, 197, 94, 0.2) !important;
            border-color: #22c55e !important;
            color: #22c55e !important;
        }
        
        .read-btn:hover {
            background: rgba(34, 197, 94, 0.3) !important;
        }
        
        .read-btn.speaking {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: #ef4444 !important;
            color: #ef4444 !important;
        }
        
        .translate-btn {
            background: rgba(168, 85, 247, 0.2) !important;
            border-color: #a855f7 !important;
            color: #a855f7 !important;
        }
        
        .translate-btn:hover {
            background: rgba(168, 85, 247, 0.3) !important;
        }
        
        /* Trial Badge & Simple Timer Styles */
        .trial-status-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            margin-left: 8px;
        }
        
        .trial-badge {
            background: linear-gradient(135deg, #ffd700, #ffb347);
            color: #000;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
        }
        
        .simple-timer {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 12px;
            padding: 4px 8px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            color: #00ffff;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-shadow: 0 0 5px rgba(0, 255, 255, 0.5);
            opacity: 0.9;
        }
        
        .simple-timer.warning {
            background: rgba(34, 211, 238, 0.15);
            border-color: rgba(34, 211, 238, 0.4);
            color: #22d3ee;
            text-shadow: 0 0 5px rgba(34, 211, 238, 0.5);
        }
        
        .simple-timer.critical {
            background: rgba(255, 69, 69, 0.1);
            border-color: rgba(255, 69, 69, 0.3);
            color: #ff4545;
            text-shadow: 0 0 5px rgba(255, 69, 69, 0.5);
            animation: criticalBlink 1s ease-in-out infinite alternate;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes criticalBlink {
            0% { opacity: 0.9; }
            100% { opacity: 0.6; }
        }
        
        /* Translation Panel Styles */
        .translation-panel {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(168, 85, 247, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .translation-panel h4 {
            color: #a855f7;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
        }
        
        .language-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        
        .language-controls label {
            color: #e2e8f0;
            font-weight: 600;
        }
        
        .language-controls select {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 6px;
            padding: 8px 12px;
            color: #e2e8f0;
            cursor: pointer;
        }
        
        .language-controls select:focus {
            outline: none;
            border-color: #a855f7;
        }
        
        .translate-action-btn {
            background: rgba(168, 85, 247, 0.2);
            border: 1px solid #a855f7;
            border-radius: 6px;
            padding: 8px 16px;
            color: #a855f7;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .translate-action-btn:hover {
            background: rgba(168, 85, 247, 0.3);
        }
        
        .translated-content {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(168, 85, 247, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        /* Canvas Interface Styles */
        .canvas-interface, .canvas-drawing {
            margin: 20px 0;
        }
        
        .canvas-prompt-section {
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .canvas-header {
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .canvas-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-top: 15px;
        }
        
        .tool-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .tool-group label {
            color: #22d3ee;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .tool-group input[type="range"] {
            width: 80px;
        }
        
        .tool-group input[type="color"] {
            width: 40px;
            height: 30px;
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
        }
        
        .tool-btn {
            background: rgba(34, 211, 238, 0.2);
            border: 1px solid #22d3ee;
            border-radius: 6px;
            padding: 6px 12px;
            color: #22d3ee;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .tool-btn:hover {
            background: rgba(34, 211, 238, 0.3);
        }
        
        .canvas-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            background: rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            padding: 20px;
        }
        
        #artCanvas {
            border: 2px solid rgba(34, 211, 238, 0.5);
            border-radius: 8px;
            background: white;
            cursor: crosshair;
            max-width: 100%;
            height: auto;
        }
        
        .canvas-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        #brushSizeValue {
            color: #e2e8f0;
            font-size: 0.8rem;
            min-width: 30px;
        }
        
        @media (max-width: 768px) {
            .canvas-tools {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tool-group {
                justify-content: space-between;
            }
            
            #artCanvas {
                width: 100%;
                max-width: 400px;
            }
            
            .canvas-actions {
                flex-direction: column;
                align-items: center;
            }
        }

        /* Speech Input Styles */
        .speech-button {
            background: rgba(34, 211, 238, 0.2);
            border: 2px solid rgba(34, 211, 238, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #22d3ee;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            min-width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .speech-button:hover {
            background: rgba(34, 211, 238, 0.3);
            border-color: #22d3ee;
            transform: scale(1.05);
        }

        .speech-button.listening {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
            color: #ef4444;
            animation: pulse 1.5s infinite;
        }

        .speech-button.listening i {
            animation: glow 1.5s infinite alternate;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes glow {
            0% { text-shadow: 0 0 5px #ef4444; }
            100% { text-shadow: 0 0 20px #ef4444, 0 0 30px #ef4444; }
        }

        .speech-status {
            font-size: 0.85rem;
            color: #94a3b8;
            text-align: center;
            margin-top: 8px;
            padding: 0 10px;
            transition: all 0.3s ease;
        }

        .speech-status.listening {
            color: #ef4444;
            font-weight: 600;
        }

        .speech-status.transcribing {
            color: #22d3ee;
            font-weight: 600;
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 0;
        }

        .message-input {
            flex: 1;
        }

        /* Creative Writing Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: transparent;
            cursor: pointer;
        }

        .modal-content {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border-radius: 16px;
            padding: 30px;
            max-width: 90%;
            max-height: 90%;
            width: 600px;
            position: relative;
            z-index: 10000;
            border: 2px solid #22d3ee;
            box-shadow: 0 20px 40px rgba(34, 211, 238, 0.3);
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            color: #22d3ee;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            background: none;
            border: none;
            color: #22d3ee;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: #fff;
            background: rgba(34, 211, 238, 0.2);
            border-radius: 50%;
        }
        
        /* Timer styles removed from chat page - too distracting during conversations */

        .hidden {
            display: none !important;
        }
        
        .trial-btn {
            animation: pulse-gold 2s infinite;
        }
        
        @keyframes pulse-gold {
            0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 215, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); }
        }

        /* Mobile responsive */
        @media screen and (max-width: 768px) {
            /* OLD ring timer mobile styles removed */
        }
        
        /* Tier Button Styling with Limits Display */
        .tier-btn {
            display: flex !important;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            min-width: 80px;
            position: relative;
        }
        
        .tier-btn .btn-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }
        
        .tier-btn .btn-title {
            font-size: 12px;
            font-weight: 600;
        }
        
        .tier-btn .btn-limit {
            font-size: 10px;
            font-family: 'Courier New', monospace;
            background: rgba(0, 255, 255, 0.2);
            padding: 1px 4px;
            border-radius: 4px;
            border: 1px solid rgba(0, 255, 255, 0.4);
            color: #00ffff;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .tier-btn.limit-exceeded .btn-limit {
            background: rgba(255, 69, 69, 0.2);
            border-color: rgba(255, 69, 69, 0.4);
            color: #ff4545;
        }
        
        .tier-btn.limit-warning .btn-limit {
            background: rgba(255, 165, 0, 0.2);
            border-color: rgba(255, 165, 0, 0.4);
            color: #ffa500;
        }
        
        .tier-btn.unlimited .btn-limit {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.4);
            color: #ffd700;
        }
        
        /* Tooltip for tier buttons */
        .tier-btn:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
        }
        
        /* ALLOW NEW ROBUST TIMER TO SHOW ONLY WHEN ACTIVE */
        #trial-banner {
            visibility: visible !important;
            opacity: 1 !important;
            position: static !important;
            left: auto !important;
            top: auto !important;
            /* Display controlled by template condition - no override */
        }
        
        /* Hide only the OLD problematic timers */
        #trial-timer-container, .timer-display, .timer-content, .timer-glass-card {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            width: 0 !important;
            height: 0 !important;
        }
    </style>

    <script>
        async function openCreativeWriting() {
            try {
                const modal = document.getElementById('creativeWritingModal');
                if (modal) {
                    modal.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                    // Update usage counter when modal opens
                    await updateCreativeWritingUsage();
                }
            } catch (error) {}
        }
        
        async function updateCreativeWritingUsage() {
            try {
                const counterEl = document.getElementById('creativeWritingUsageCounter');
                if (!counterEl) return;
                
                const response = await fetch('/api/tier-limits', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    const limit = data.limits?.creative_writer || 3;
                    const usage = data.usage?.creative_writer || 0;
                    
                    if (limit === 'unlimited' || limit >= 999) {
                        counterEl.textContent = '‚àû Unlimited Usage';
                        counterEl.style.color = '#FFD700';
                    } else {
                        counterEl.textContent = `${usage}/${limit} uses today`;
                        counterEl.style.color = usage >= limit ? '#ff6b6b' : '#22d3ee';
                    }
                }
            } catch (error) {
                console.error('Failed to update Creative Writing usage:', error);
            }
        }
        
        function closeCreativeWriting() {
            document.getElementById('creativeWritingModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            resetCreativeWriting();
        }
        
        // OLD tier usage update function REMOVED - now handled by new tier isolation system
        
        function selectWritingMode(mode) {
            // Remove active class from all buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to selected button
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // Show appropriate input section based on mode
            if (mode === 'canvas') {
                document.getElementById('writingInput').style.display = 'none';
                document.getElementById('canvasInterface').style.display = 'block';
                document.getElementById('canvasDrawing').style.display = 'none';
            } else {
                document.getElementById('writingInput').style.display = 'block';
                document.getElementById('canvasInterface').style.display = 'none';
                document.getElementById('canvasDrawing').style.display = 'none';
            }
            
            // Update title and placeholder based on mode
            const modeConfig = {
                poetry: {
                    title: 'Poetry & Verses',
                    placeholder: 'What emotion or theme would you like your poem to capture? (e.g., "love and gratitude", "overcoming challenges", "peaceful nature")'
                },
                inspiration: {
                    title: 'Daily Inspiration',
                    placeholder: 'What area of life do you need inspiration for? (e.g., "starting a new day", "staying motivated", "believing in myself")'
                },
                story: {
                    title: 'Short Stories',
                    placeholder: 'What kind of story would inspire you? (e.g., "adventure in a magical world", "overcoming a challenge", "finding unexpected friendship")'
                },
                music: {
                    title: 'Music & Lyrics',
                    placeholder: 'What song or musical idea would you like help with? (e.g., "uplifting song about hope", "rap about personal growth", "love ballad lyrics")'
                },
                thoughts: {
                    title: 'Thoughts & Notes',
                    placeholder: 'What would you like to explore or reflect on? (e.g., "processing my feelings today", "thoughts about my goals", "random ideas and observations")'
                },
                letter: {
                    title: 'Personal Letters',
                    placeholder: 'Who is this letter for and what message do you want to convey? (e.g., "letter to future self about goals", "thank you note to someone special")'
                },
                canvas: {
                    title: 'Creative Canvas',
                    placeholder: 'What emotions or ideas would you like to express through art? (e.g., "my current stress and how to release it", "gratitude for good things in my life")'
                }
            };
            
            document.getElementById('modeTitle').textContent = modeConfig[mode].title;
            document.getElementById('writingPrompt').placeholder = modeConfig[mode].placeholder;
            document.getElementById('writingPrompt').dataset.mode = mode;
        }
        
        function toggleCustomMood() {
            const moodSelect = document.getElementById('moodSelect');
            const customMoodInput = document.getElementById('customMoodInput');
            
            if (moodSelect.value === 'custom') {
                customMoodInput.style.display = 'block';
            } else {
                customMoodInput.style.display = 'none';
            }
        }
        
        async function generateCreativeContent() {
            const prompt = document.getElementById('writingPrompt').value.trim();
            const moodSelect = document.getElementById('moodSelect');
            const mode = document.getElementById('writingPrompt').dataset.mode;
            
            // Get mood - use custom input if "custom" is selected
            let mood;
            if (moodSelect.value === 'custom') {
                const customMood = document.getElementById('customMood').value.trim();
                if (!customMood) {
                    return;
                }
                mood = customMood;
            } else {
                mood = moodSelect.value;
            }
            
            if (!prompt) {
                return;
            }
            
            const generateBtn = document.querySelector('.generate-btn');
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating...';
            generateBtn.disabled = true;
            
            try {
                const response = await fetch('/api/creative-writing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: mode,
                        prompt: prompt,
                        mood: mood,
                        companion: currentCharacter || 'AI Assistant'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('generatedContent').textContent = data.content;
                    document.getElementById('writingOutput').style.display = 'block';
                    document.getElementById('writingInput').style.display = 'none';
                } else {
                    // Error: could not generate creative content
                }
            } catch (error) {
                // Error: creative writing error
            } finally {
                generateBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Creative Content';
                generateBtn.disabled = false;
            }
        }
        
        function copyCreativeContent() {
            const content = document.getElementById('generatedContent').textContent;
            navigator.clipboard.writeText(content).then(() => {
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                setTimeout(() => {
                    copyBtn.innerHTML = originalText;
                }, 2000);
            });
        }
        
        async function saveToLibrary() {
            const content = document.getElementById('generatedContent').textContent;
            const mode = document.getElementById('writingPrompt').dataset.mode;
            const prompt = document.getElementById('writingPrompt').value;
            const mood = document.getElementById('moodSelect').value;
            
            const saveBtn = document.querySelector('.save-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            
            try {
                const response = await fetch('/api/save-creative-content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        mode: mode,
                        prompt: prompt,
                        mood: mood,
                        companion: currentCharacter || 'AI Assistant'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Save failed');
                }
            } catch (error) {
                // Error: save error
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }
        
        function exportCreativeContent() {
            const content = document.getElementById('generatedContent').textContent;
            const mode = document.getElementById('writingPrompt').dataset.mode;
            const prompt = document.getElementById('writingPrompt').value;
            const mood = document.getElementById('moodSelect').value;
            
            // Create export content with metadata
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const modeNames = {
                poetry: 'Poetry & Verses',
                inspiration: 'Daily Inspiration',
                story: 'Short Stories',
                music: 'Music & Lyrics',
                thoughts: 'Thoughts & Notes',
                letter: 'Personal Letters'
            };
            
            const exportContent = `SoulBridge AI - Creative Writing Export
${'='.repeat(50)}

Type: ${modeNames[mode] || 'Creative Writing'}
Original Prompt: ${prompt}
Mood/Tone: ${mood.charAt(0).toUpperCase() + mood.slice(1)}
Created: ${currentDate}
Companion: ${currentCharacter || 'AI Assistant'}

${'='.repeat(50)}

${content}

${'='.repeat(50)}
Generated with SoulBridge AI Creative Writing Assistant
Where emotion meets expression.
`;
            
            // Create and download file
            const blob = new Blob([exportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SoulBridge_${mode}_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // Visual feedback
            const exportBtn = document.querySelector('.export-btn');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<i class="fas fa-check"></i> Exported!';
            setTimeout(() => {
                exportBtn.innerHTML = originalText;
            }, 2000);
        }
        
        function resetCreativeWriting() {
            document.getElementById('writingInput').style.display = 'none';
            document.getElementById('writingOutput').style.display = 'none';
            document.getElementById('canvasInterface').style.display = 'none';
            document.getElementById('canvasDrawing').style.display = 'none';
            document.getElementById('writingPrompt').value = '';
            document.getElementById('canvasPrompt').value = '';
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            
            // Clear canvas if it exists
            const canvas = document.getElementById('artCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        // Canvas Drawing Variables
        let canvas, ctx;
        let isDrawing = false;
        let canvasHistory = [];
        let historyStep = -1;
        
        function startArtTherapy() {
            const prompt = document.getElementById('canvasPrompt').value.trim();
            const theme = document.getElementById('canvasTheme').value;
            
            if (!prompt) {
                return;
            }
            
            // Show canvas drawing area
            document.getElementById('canvasInterface').style.display = 'none';
            document.getElementById('canvasDrawing').style.display = 'block';
            
            // Set theme-specific instructions
            const themeInstructions = {
                mood: 'Express your current mood using colors, shapes, and lines. Let your emotions guide your brush.',
                stress: 'Release your stress and tension through bold strokes. Draw what stress feels like, then transform it.',
                gratitude: 'Fill the canvas with symbols, colors, and shapes that represent what you\'re grateful for.',
                peace: 'Create a peaceful scene that brings you calm. Use gentle colors and flowing lines.',
                growth: 'Visualize your personal growth journey. Show where you\'ve been and where you\'re going.',
                dreams: 'Paint your dreams and aspirations. What does your ideal future look like?',
                healing: 'Use art to heal. Draw your pain transforming into strength and hope.',
                freeform: 'Let your creativity flow freely. There are no rules - just express yourself.'
            };
            
            document.getElementById('canvasInstructions').textContent = themeInstructions[theme] || 'Let your emotions flow through art';
            
            // Initialize canvas
            initializeCanvas();
        }
        
        function initializeCanvas() {
            canvas = document.getElementById('artCanvas');
            ctx = canvas.getContext('2d');
            
            // Set up canvas properties
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Clear canvas and set white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Save initial state
            saveCanvasState();
            
            // Add event listeners
            setupCanvasEvents();
            
            // Update brush size display
            updateBrushSize();
        }
        
        function setupCanvasEvents() {
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', handleTouch);
            canvas.addEventListener('touchmove', handleTouch);
            canvas.addEventListener('touchend', stopDrawing);
            
            // Brush size slider
            document.getElementById('brushSize').addEventListener('input', updateBrushSize);
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            ctx.lineWidth = document.getElementById('brushSize').value;
            ctx.strokeStyle = document.getElementById('brushColor').value;
            
            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        
        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                ctx.beginPath();
                saveCanvasState();
            }
        }
        
        function handleTouch(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                            e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }
        
        function updateBrushSize() {
            const size = document.getElementById('brushSize').value;
            document.getElementById('brushSizeValue').textContent = size + 'px';
        }
        
        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            saveCanvasState();
        }
        
        function undoCanvas() {
            if (historyStep > 0) {
                historyStep--;
                const canvasState = canvasHistory[historyStep];
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = canvasState;
            }
        }
        
        function saveCanvasState() {
            historyStep++;
            if (historyStep < canvasHistory.length) {
                canvasHistory.length = historyStep;
            }
            canvasHistory.push(canvas.toDataURL());
        }
        
        async function saveCanvasArt() {
            const canvasDataURL = canvas.toDataURL('image/png');
            const prompt = document.getElementById('canvasPrompt').value;
            const theme = document.getElementById('canvasTheme').value;
            
            const saveBtn = document.querySelector('#canvasDrawing .save-btn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            
            try {
                const response = await fetch('/api/save-canvas-art', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        artwork: canvasDataURL,
                        prompt: prompt,
                        theme: theme,
                        companion: currentCharacter || 'AI Assistant'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
                    setTimeout(() => {
                        saveBtn.innerHTML = originalText;
                        saveBtn.disabled = false;
                    }, 2000);
                } else {
                    throw new Error(data.error || 'Save failed');
                }
            } catch (error) {
                // Save canvas error
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }
        
        function exportCanvasArt() {
            const prompt = document.getElementById('canvasPrompt').value;
            const theme = document.getElementById('canvasTheme').value;
            
            // Export as PNG
            const link = document.createElement('a');
            link.download = `SoulBridge_Art_${theme}_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Visual feedback
            const exportBtn = document.querySelector('#canvasDrawing .export-btn');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<i class="fas fa-check"></i> Exported!';
            setTimeout(() => {
                exportBtn.innerHTML = originalText;
            }, 2000);
        }
        
        function resetCanvas() {
            document.getElementById('canvasInterface').style.display = 'block';
            document.getElementById('canvasDrawing').style.display = 'none';
            document.getElementById('canvasPrompt').value = '';
            clearCanvas();
        }
        
        async function shareToWellnessGallery() {
            const content = document.getElementById('generatedContent').textContent;
            const mode = document.getElementById('writingPrompt').dataset.mode;
            const prompt = document.getElementById('writingPrompt').value;
            const mood = document.getElementById('moodSelect').value;
            
            if (!content) {
                return;
            }
            
            const shareBtn = document.querySelector('.share-btn');
            const originalText = shareBtn.innerHTML;
            shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sharing...';
            shareBtn.disabled = true;
            
            try {
                const response = await fetch('/api/share-to-wellness-gallery', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        content_type: 'creative_writing',
                        theme: mode === 'thoughts' ? 'growth' : mode === 'inspiration' ? 'gratitude' : mode,
                        mood: mood
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    shareBtn.innerHTML = '<i class="fas fa-heart"></i> Shared!';
                    setTimeout(() => {
                        shareBtn.innerHTML = originalText;
                        shareBtn.disabled = false;
                    }, 3000);
                    
                    // Show success message with link to gallery
                    if (confirm(data.message + ' Would you like to visit the Wellness Gallery to see shared content?')) {
                        window.open('/wellness-gallery', '_blank');
                    }
                } else {
                    throw new Error(data.error || 'Share failed');
                }
            } catch (error) {
                console.error('Share error:', error);
                alert('Sorry, there was an error sharing your content. Please ensure your content follows our wellness community guidelines.');
                shareBtn.innerHTML = originalText;
                shareBtn.disabled = false;
            }
        }
        
        // Text-to-Speech functionality
        let currentSpeech = null;
        
        function readContentAloud() {
            const readBtn = document.getElementById('readBtn');
            const content = document.getElementById('generatedContent').textContent;
            
            if (!content.trim()) {
                return;
            }
            
            // Check if already speaking
            if (currentSpeech && !currentSpeech.paused) {
                // Stop current speech
                speechSynthesis.cancel();
                currentSpeech = null;
                readBtn.innerHTML = '<i class="fas fa-volume-up"></i> Read Aloud';
                readBtn.classList.remove('speaking');
                return;
            }
            
            // Create new speech synthesis
            currentSpeech = new SpeechSynthesisUtterance(content);
            
            // Configure speech settings
            currentSpeech.rate = 0.8; // Slightly slower for better comprehension
            currentSpeech.pitch = 1.0;
            currentSpeech.volume = 0.8;
            
            // Try to use a more natural voice if available
            const voices = speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.name.includes('Google') || 
                voice.name.includes('Microsoft') || 
                voice.localService === false
            );
            if (preferredVoice) {
                currentSpeech.voice = preferredVoice;
            }
            
            // Update button during speech
            readBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Reading';
            readBtn.classList.add('speaking');
            
            // Handle speech events
            currentSpeech.onend = () => {
                readBtn.innerHTML = '<i class="fas fa-volume-up"></i> Read Aloud';
                readBtn.classList.remove('speaking');
                currentSpeech = null;
            };
            
            currentSpeech.onerror = (event) => {
                readBtn.innerHTML = '<i class="fas fa-volume-up"></i> Read Aloud';
                readBtn.classList.remove('speaking');
                currentSpeech = null;
            };
            
            // Start speaking
            speechSynthesis.speak(currentSpeech);
        }
        
        // Translation functionality
        function toggleTranslation() {
            const translationPanel = document.getElementById('translationPanel');
            const translateBtn = document.getElementById('translateBtn');
            
            if (translationPanel.style.display === 'none' || !translationPanel.style.display) {
                translationPanel.style.display = 'block';
                translateBtn.innerHTML = '<i class="fas fa-times"></i> Close Translation';
            } else {
                translationPanel.style.display = 'none';
                translateBtn.innerHTML = '<i class="fas fa-language"></i> Translate';
            }
        }
        
        async function translateContent() {
            const content = document.getElementById('generatedContent').textContent;
            const targetLanguage = document.getElementById('targetLanguage').value;
            const translatedContentDiv = document.getElementById('translatedContent');
            const translateActionBtn = document.querySelector('.translate-action-btn');
            
            if (!content.trim()) {
                return;
            }
            
            // Show loading state
            const originalBtnText = translateActionBtn.innerHTML;
            translateActionBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Translating...';
            translateActionBtn.disabled = true;
            
            try {
                // Use the chat API to translate content
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Please translate the following text to ${getLanguageName(targetLanguage)}. Keep the formatting and structure exactly the same, only translate the words:\n\n${content}`,
                        companion: 'AI Assistant',
                        context: 'translation'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    translatedContentDiv.innerHTML = `
                        <h5><i class="fas fa-globe"></i> Translated to ${getLanguageName(targetLanguage)}:</h5>
                        <div style="white-space: pre-wrap;">${result.response}</div>
                    `;
                    translatedContentDiv.style.display = 'block';
                } else {
                    throw new Error(result.error || 'Translation failed');
                }
                
            } catch (error) {
                // Error handling for translation failure (silent in production)
            }
            
            // Reset button
            translateActionBtn.innerHTML = originalBtnText;
            translateActionBtn.disabled = false;
        }
        
        function getLanguageName(code) {
            const languageNames = {
                'es': 'Spanish',
                'fr': 'French',
                'de': 'German',
                'it': 'Italian',
                'pt': 'Portuguese',
                'ru': 'Russian',
                'ja': 'Japanese',
                'ko': 'Korean',
                'zh': 'Chinese',
                'ar': 'Arabic',
                'hi': 'Hindi',
                'nl': 'Dutch',
                'sv': 'Swedish',
                'no': 'Norwegian',
                'da': 'Danish',
                'pl': 'Polish',
                'tr': 'Turkish',
                'he': 'Hebrew',
                'th': 'Thai',
                'vi': 'Vietnamese'
            };
            return languageNames[code] || code.toUpperCase();
        }
        
        async function shareCanvasToWellnessGallery() {
            const canvasDataURL = canvas.toDataURL('image/png');
            const prompt = document.getElementById('canvasPrompt').value;
            const theme = document.getElementById('canvasTheme').value;
            
            if (!canvasDataURL) {
                return;
            }
            
            const shareBtn = document.querySelector('#canvasDrawing .share-btn');
            const originalText = shareBtn.innerHTML;
            shareBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sharing...';
            shareBtn.disabled = true;
            
            try {
                const response = await fetch('/api/share-to-wellness-gallery', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: canvasDataURL,
                        content_type: 'canvas_art',
                        theme: theme,
                        mood: ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    shareBtn.innerHTML = '<i class="fas fa-heart"></i> Shared!';
                    setTimeout(() => {
                        shareBtn.innerHTML = originalText;
                        shareBtn.disabled = false;
                    }, 3000);
                } else {
                    throw new Error(data.error || 'Share failed');
                }
            } catch (error) {
                shareBtn.innerHTML = originalText;
                shareBtn.disabled = false;
            }
        }
        
        // Voice chat functionality (Full conversation mode)
        let isVoiceChatRecording = false;
        let voiceChatMediaRecorder = null;
        let voiceChatAudioChunks = [];
        
        async function toggleVoiceChat() {
            const voiceBtn = document.getElementById('voiceChatBtn');
            
            if (!isVoiceChatRecording) {
                // Start recording for full voice chat
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    voiceChatMediaRecorder = new MediaRecorder(stream);
                    voiceChatAudioChunks = [];
                    
                    voiceChatMediaRecorder.ondataavailable = (event) => {
                        voiceChatAudioChunks.push(event.data);
                    };
                    
                    voiceChatMediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(voiceChatAudioChunks, { type: 'audio/wav' });
                        await sendVoiceMessage(audioBlob);
                        
                        // Stop microphone access
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    voiceChatMediaRecorder.start();
                    isVoiceChatRecording = true;
                    
                    voiceBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
                    voiceBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                    voiceBtn.style.borderColor = '#ef4444';
                    
                    // Show recording indicator
                    addSystemMessage('üé§ Recording voice message... Click "Stop Recording" when finished speaking.');
                    
                } catch (error) {
                    console.error('Error accessing microphone for voice chat:', error);
                    addSystemMessage('‚ùå Could not access microphone. Please check permissions.');
                }
            } else {
                // Stop recording
                if (voiceChatMediaRecorder && voiceChatMediaRecorder.state === 'recording') {
                    voiceChatMediaRecorder.stop();
                }
                isVoiceChatRecording = false;
                
                voiceBtn.innerHTML = '<i class="fas fa-phone"></i> Voice Chat';
                voiceBtn.style.background = '';
                voiceBtn.style.borderColor = '';
            }
        }
        
        async function sendVoiceMessage(audioBlob) {
            try {
                addSystemMessage('üîÑ Processing your voice message...');
                
                const formData = new FormData();
                formData.append('audio', audioBlob, 'voice_message.wav');
                formData.append('character', selectedCharacter || 'Blayzo');
                
                const response = await fetch('/api/voice-chat/process', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Add transcribed message as user message
                    if (data.transcript) {
                        addMessage(data.transcript, 'user');
                    }
                    
                    // Add AI response as assistant message
                    if (data.response) {
                        addMessage(data.response, 'assistant');
                        
                        // Play AI response as speech if audio is provided
                        if (data.audio_url) {
                            const audio = new Audio(data.audio_url);
                            audio.play().catch(e => {/* Audio playback failed, silent in production */});
                        }
                    }
                } else {
                    addSystemMessage('‚ùå ' + (data.error || 'Voice processing failed'));
                }
                
            } catch (error) {
                addSystemMessage('‚ùå Voice chat error. Please try again.');
            }
        }
        
        function addSystemMessage(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message';
            messageDiv.innerHTML = `<div class="message-content">${message}</div>`;
            
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Speech Recognition Integration
        let speechRecognition = null;
        let isSpeechListening = false;

        function initializeSpeechRecognition() {
            const speechBtn = document.getElementById('speechBtn');
            const speechStatus = document.getElementById('speechStatus');
            const messageInput = document.getElementById('messageInput');

            // Check for browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                speechBtn.disabled = true;
                speechBtn.style.opacity = '0.5';
                speechStatus.innerText = "Voice input not supported in this browser";
                speechStatus.style.color = '#ef4444';
                return;
            }

            speechRecognition = new SpeechRecognition();
            speechRecognition.lang = 'en-US';
            speechRecognition.continuous = false;
            speechRecognition.interimResults = true;
            speechRecognition.maxAlternatives = 1;

            speechBtn.addEventListener('click', toggleSpeechRecognition);

            speechRecognition.onstart = () => {
                isSpeechListening = true;
                speechBtn.classList.add('listening');
                speechBtn.innerHTML = '<i class="fas fa-stop"></i>';
                speechStatus.innerText = "Listening... speak now";
                speechStatus.classList.add('listening');
            };

            speechRecognition.onresult = (event) => {
                let transcript = '';
                let isFinal = false;

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    if (result.isFinal) {
                        transcript += result[0].transcript;
                        isFinal = true;
                    } else {
                        transcript += result[0].transcript;
                    }
                }

                if (transcript.trim()) {
                    if (isFinal) {
                        // Add the final transcript to the textarea
                        const currentText = messageInput.value;
                        const newText = currentText ? currentText + ' ' + transcript.trim() : transcript.trim();
                        messageInput.value = newText;
                        
                        // Trigger input event to enable send button if needed
                        messageInput.dispatchEvent(new Event('input', { bubbles: true }));
                        
                        speechStatus.innerText = "Speech recognized! You can continue typing or click send.";
                        speechStatus.classList.remove('listening');
                        speechStatus.classList.add('transcribing');
                        
                        setTimeout(() => {
                            speechStatus.innerText = "Click microphone to start voice input";
                            speechStatus.classList.remove('transcribing');
                        }, 3000);
                    } else {
                        // Show interim results in status
                        speechStatus.innerText = `Hearing: "${transcript}"`;
                    }
                }
            };

            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isSpeechListening = false;
                speechBtn.classList.remove('listening');
                speechBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                speechStatus.classList.remove('listening');
                
                const errorMessages = {
                    'network': 'Network error. Please check your connection.',
                    'not-allowed': 'Microphone access denied. Please allow microphone access.',
                    'no-speech': 'No speech detected. Please try again.',
                    'audio-capture': 'Microphone not found. Please check your audio settings.',
                    'service-not-allowed': 'Speech service not allowed. Please try again.',
                    'aborted': 'Speech recognition was stopped.',
                    'language-not-supported': 'Language not supported.',
                    'bad-grammar': 'Grammar error in speech recognition.'
                };
                
                const errorMessage = errorMessages[event.error] || `Speech recognition error: ${event.error}`;
                speechStatus.innerText = errorMessage;
                speechStatus.style.color = '#ef4444';
                
                setTimeout(() => {
                    speechStatus.innerText = "Click microphone to start voice input";
                    speechStatus.style.color = '#94a3b8';
                }, 4000);
            };

            speechRecognition.onend = () => {
                isSpeechListening = false;
                speechBtn.classList.remove('listening');
                speechBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                speechStatus.classList.remove('listening');
                
                if (!speechStatus.classList.contains('transcribing')) {
                    speechStatus.innerText = "Click microphone to start voice input";
                }
            };
        }

        function toggleSpeechRecognition() {
            if (!speechRecognition) return;

            if (!isSpeechListening) {
                try {
                    speechRecognition.start();
                } catch (error) {
                    document.getElementById('speechStatus').innerText = "Error starting voice input. Please try again.";
                }
            } else {
                speechRecognition.stop();
            }
        }

        // Initialize speech recognition when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeSpeechRecognition();
            
            // Initialize tier limits display
            updateTierLimits();
            
            // Update tier limits every 30 seconds
            setInterval(updateTierLimits, 30000);
            
            // Update tier limits when user returns to page (after using features)
            window.addEventListener('focus', () => {
                console.log('üîÑ Page gained focus - refreshing feature usage counters');
                updateTierLimits();
            });
            
            // Also update when page becomes visible (tab switching)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    console.log('üîÑ Page became visible - refreshing feature usage counters');
                    updateTierLimits();
                }
            });
            
            // Debug premium features only for premium users or when debugging
            const effectivePlan = '{{ effective_plan }}';
            if (effectivePlan !== 'free' || sessionStorage.getItem('debugPremiumFeatures')) {
                emergencyDebugPremiumFeatures();
            }
        });
        
        // Update tier limits display in real-time
        async function updateTierLimits() {
            try {
                // Try v1 entitlements endpoint first
                let data = null;
                try {
                    const response = await fetch('/v1/entitlements', { credentials: 'include' });
                    if (response.ok) {
                        const entitlements = await response.json();
                        // Convert v1 format to legacy tier-limits format
                        data = {
                            success: true,
                            limits: entitlements.daily_limits,
                            plan: entitlements.plan,
                            trial_active: entitlements.status === 'trial'
                        };
                    }
                } catch (v1Error) {
                    console.warn('V1 entitlements failed, falling back to legacy API:', v1Error);
                    // Fallback to legacy API
                    const response = await fetch('/api/tier-limits');
                    data = await response.json();
                }
                
                if (!data.success) {
                    return;
                }
                
                
                
                const { limits, usage, tier, unlimited_features } = data;
                
                // Update decoder button
                const decoderBtn = document.querySelector('[data-feature="decoder"]');
                const decoderLimit = document.getElementById('decoderLimit');
                if (decoderBtn && decoderLimit) {
                    const decoderUsed = usage.decoder || 0;
                    const decoderMax = limits.decoder;
                    
                    if (unlimited_features.includes('decoder') || decoderMax === 'unlimited' || decoderMax >= 999999) {
                        decoderLimit.textContent = '‚àû';
                        decoderBtn.classList.add('unlimited');
                        decoderBtn.setAttribute('data-tooltip', `Unlimited decoder uses available`);
                    } else {
                        decoderLimit.textContent = `${decoderUsed}/${decoderMax}`;
                        decoderBtn.classList.remove('unlimited', 'limit-exceeded', 'limit-warning');
                        
                        if (decoderUsed >= decoderMax) {
                            decoderBtn.classList.add('limit-exceeded');
                            decoderBtn.setAttribute('data-tooltip', `Daily limit reached (${decoderUsed}/${decoderMax})`);
                        } else if (decoderUsed >= decoderMax * 0.8) {
                            decoderBtn.classList.add('limit-warning');
                            decoderBtn.setAttribute('data-tooltip', `${decoderMax - decoderUsed} uses remaining today`);
                        } else {
                            decoderBtn.setAttribute('data-tooltip', `${decoderMax - decoderUsed} uses remaining today`);
                        }
                    }
                }
                
                // Update fortune button
                const fortuneBtn = document.querySelector('[data-feature="fortune"]');
                const fortuneLimit = document.getElementById('fortuneLimit');
                if (fortuneBtn && fortuneLimit) {
                    const fortuneUsed = usage.fortune || 0;
                    const fortuneMax = limits.fortune;
                    
                    if (unlimited_features.includes('fortune') || fortuneMax === 'unlimited' || fortuneMax >= 999999) {
                        fortuneLimit.textContent = '‚àû';
                        fortuneBtn.classList.add('unlimited');
                        fortuneBtn.setAttribute('data-tooltip', `Unlimited fortune uses available`);
                    } else {
                        fortuneLimit.textContent = `${fortuneUsed}/${fortuneMax}`;
                        fortuneBtn.classList.remove('unlimited', 'limit-exceeded', 'limit-warning');
                        
                        if (fortuneUsed >= fortuneMax) {
                            fortuneBtn.classList.add('limit-exceeded');
                            fortuneBtn.setAttribute('data-tooltip', `Daily limit reached (${fortuneUsed}/${fortuneMax})`);
                        } else if (fortuneUsed >= fortuneMax * 0.8) {
                            fortuneBtn.classList.add('limit-warning');
                            fortuneBtn.setAttribute('data-tooltip', `${fortuneMax - fortuneUsed} uses remaining today`);
                        } else {
                            fortuneBtn.setAttribute('data-tooltip', `${fortuneMax - fortuneUsed} uses remaining today`);
                        }
                    }
                }
                
                // Update horoscope button
                const horoscopeBtn = document.querySelector('[data-feature="horoscope"]');
                const horoscopeLimit = document.getElementById('horoscopeLimit');
                if (horoscopeBtn && horoscopeLimit) {
                    const horoscopeUsed = usage.horoscope || 0;
                    const horoscopeMax = limits.horoscope;
                    
                    if (unlimited_features.includes('horoscope') || horoscopeMax === 'unlimited' || horoscopeMax >= 999999) {
                        horoscopeLimit.textContent = '‚àû';
                        horoscopeBtn.classList.add('unlimited');
                        horoscopeBtn.setAttribute('data-tooltip', `Unlimited horoscope uses available`);
                    } else {
                        horoscopeLimit.textContent = `${horoscopeUsed}/${horoscopeMax}`;
                        horoscopeBtn.classList.remove('unlimited', 'limit-exceeded', 'limit-warning');
                        
                        if (horoscopeUsed >= horoscopeMax) {
                            horoscopeBtn.classList.add('limit-exceeded');
                            horoscopeBtn.setAttribute('data-tooltip', `Daily limit reached (${horoscopeUsed}/${horoscopeMax})`);
                        } else if (horoscopeUsed >= horoscopeMax * 0.8) {
                            horoscopeBtn.classList.add('limit-warning');
                            horoscopeBtn.setAttribute('data-tooltip', `${horoscopeMax - horoscopeUsed} uses remaining today`);
                        } else {
                            horoscopeBtn.setAttribute('data-tooltip', `${horoscopeMax - horoscopeUsed} uses remaining today`);
                        }
                    }
                }
                
                // Update creative writing button
                const creativeBtn = document.querySelector('[data-feature="creative_writer"]');
                const creativeLimit = document.getElementById('creativeLimit');
                console.log(`üé® Creative button found: ${!!creativeBtn}, Creative limit element found: ${!!creativeLimit}`);
                if (creativeBtn && creativeLimit) {
                    const creativeUsed = usage.creative_writer || 0;
                    const creativeMax = limits.creative_writer;
                    
                    if (unlimited_features.includes('creative_writer') || creativeMax === 'unlimited' || creativeMax >= 999999) {
                        creativeLimit.textContent = '‚àû';
                        creativeBtn.classList.add('unlimited');
                        creativeBtn.setAttribute('data-tooltip', `Unlimited creative writing uses available`);
                    } else {
                        creativeLimit.textContent = `${creativeUsed}/${creativeMax}`;
                        creativeBtn.classList.remove('unlimited', 'limit-exceeded', 'limit-warning');
                        
                        if (creativeUsed >= creativeMax) {
                            creativeBtn.classList.add('limit-exceeded');
                            creativeBtn.setAttribute('data-tooltip', `Daily limit reached (${creativeUsed}/${creativeMax})`);
                        } else if (creativeUsed >= creativeMax * 0.8) {
                            creativeBtn.classList.add('limit-warning');
                            creativeBtn.setAttribute('data-tooltip', `${creativeMax - creativeUsed} uses remaining today`);
                        } else {
                            creativeBtn.setAttribute('data-tooltip', `${creativeMax - creativeUsed} uses remaining today`);
                        }
                    }
                }
                
                console.log('‚úÖ Tier limits updated successfully');
                
                
            } catch (error) {
                // Show default limits for bronze users when API fails
                
                // Set default bronze tier limits
                const decoderLimit = document.getElementById('decoderLimit');
                const fortuneLimit = document.getElementById('fortuneLimit');
                const horoscopeLimit = document.getElementById('horoscopeLimit');
                const creativeLimit = document.getElementById('creativeLimit');
                
                if (decoderLimit) decoderLimit.textContent = '0/3';
                if (fortuneLimit) fortuneLimit.textContent = '0/2';
                if (horoscopeLimit) horoscopeLimit.textContent = '0/3';
                if (creativeLimit) creativeLimit.textContent = '0/2';
                
                // Ensure all tier buttons are visible
                document.querySelectorAll('.tier-btn').forEach(btn => {
                    btn.style.display = 'inline-block';
                });
            }
        }
        
        async function emergencyDebugPremiumFeatures() {
            // Logging removed for production hygiene
            
            // Check if premium feature elements exist in HTML
            const voiceJournal = document.querySelector('a[href="/voice-journaling"]');
            const aiImages = document.querySelector('a[href="/ai-image-generation"]');
            const relationships = document.querySelector('a[href="/relationship-profiles"]');
            const meditations = document.querySelector('a[href="/emotional-meditations"]');
            const writeBtn = document.querySelector('a[href="/creative-writing"]');
            
            const effectivePlan = '{{ effective_plan }}';
            const expectedFeatures = {
                free: ['writeBtn'],
                growth: ['writeBtn', 'voiceJournal', 'aiImages'],
                max: ['writeBtn', 'voiceJournal', 'aiImages', 'relationships', 'meditations']
            };
            
            const shouldHave = expectedFeatures[effectivePlan] || [];
            const actualFeatures = {
                voiceJournal: voiceJournal ? 'EXISTS' : 'MISSING',
                aiImages: aiImages ? 'EXISTS' : 'MISSING', 
                relationships: relationships ? 'EXISTS' : 'MISSING',
                meditations: meditations ? 'EXISTS' : 'MISSING',
                writeBtn: writeBtn ? 'EXISTS' : 'MISSING'
            };
            
            // Only log in development mode
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Logging removed for production hygiene
            }
            
            // Only warn about missing features that should exist for this plan
            const missing = shouldHave.filter(feature => actualFeatures[feature] === 'MISSING');
            if (missing.length > 0 && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
                // Logging removed for production hygiene
            } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                // Logging removed for production hygiene
            }
            
            // Check session state from backend
            try {
                const response = await fetch('/api/user-info');
                const sessionData = await response.json();
                // Logging removed for production hygiene
                
                // Show alert with debug info ONLY if user SHOULD have premium features but doesn't
                const shouldHavePremium = sessionData.access_silver || sessionData.access_gold || sessionData.trial_active;
                const hasPremiumFeatures = voiceJournal || aiImages || relationships || meditations || writeBtn;
                
                if (shouldHavePremium && !hasPremiumFeatures) {
                    // Alert removed for production hygiene
                } else if (!shouldHavePremium && !hasPremiumFeatures) {
                    // Logging removed for production hygiene
                } else {
                    // Logging removed for production hygiene
                }
            } catch (error) {
                // Logging removed for production hygiene
            }
        }

        // ====== DISABLED OLD TRIAL TIMER SYSTEM - Using new system to prevent conflicts ======
        // DISABLED: const ring = document.querySelector('.progress-ring-circle');
        // DISABLED: const ringText = document.getElementById('ring-text');
        // DISABLED: const ringWrapper = document.getElementById('trial-ring-container');
        const alertSound = document.getElementById('trial-alert-sound');
        const confettiCanvas = document.getElementById('confetti-canvas');

        // OLD ring timer variables removed - using new trial-timer-container system

        // DISABLED: setRingProgress function - old ring timer system disabled
        // function setRingProgress(percent) {
        //     if (!ring) return;
        //     const offset = CIRCUMFERENCE - (percent * CIRCUMFERENCE);
        //     ring.style.strokeDashoffset = offset;
        // }

        function playConfetti() {
            if (!confettiCanvas || !window.confetti) return;
            confettiCanvas.classList.remove("hidden");
            window.confetti({
                particleCount: 200,
                spread: 100,
                origin: { y: 0.6 }
            });
            setTimeout(() => confettiCanvas.classList.add("hidden"), 3000);
        }

        // =========================
        // Circular Trial Timer System
        // =========================
        async function loadTrial() {
            // Try v1 entitlements endpoint first
            let d = null;
            try {
                const r = await fetch('/v1/entitlements', { credentials: 'include' });
                if (r.ok) {
                    const entitlements = await r.json();
                    // Convert v1 format to legacy format
                    d = {
                        logged_in: true,
                        active: entitlements.status === 'trial',
                        expires_at: entitlements.period_end
                    };
                }
            } catch (v1Error) {
                console.warn('V1 entitlements failed, falling back to legacy API:', v1Error);
                // Fallback to legacy API
                const r = await fetch('/api/trial-status', { credentials: 'include' });
                d = await r.json();
            }
            
            if (!d.logged_in) { 
                return; 
            }

            const banner = document.getElementById('trial-banner');

            if (!d.active) {
                // No active trial, timer hidden
                if (banner) banner.style.display = 'none';
                
                // Stop any running circular timer
                if (window.chatCircularTimer) {
                    window.chatCircularTimer.stop();
                }
                return;
            }
            
            // Active trial found, showing timer
            if (banner) banner.style.display = 'flex';

            // Initialize circular timer if not already running
            if (!window.chatCircularTimer || !window.chatCircularTimer.isRunning()) {
                initChatCircularTimer(d);
            }
        }
        
        // Initialize circular trial timer for chat page
        function initChatCircularTimer(data) {
            const container = document.getElementById('trial-circular-timer');
            if (!container || !data.expires_at) return;
            
            // Destroy any existing timer
            if (window.chatCircularTimer) {
                window.chatCircularTimer.destroy();
            }
            
            // Create new circular timer
            window.chatCircularTimer = new CircularTrialTimer('trial-circular-timer', {
                size: 50,  // Smaller, more compact
                stroke: 3,
                showLabel: false,
                onExpire: function() {
                    // Hide banner and clean up, but don't auto-refresh to prevent loops
                    const banner = document.getElementById('trial-banner');
                    if (banner) banner.style.display = 'none';
                    console.log('‚è∞ Chat timer expired, hiding banner');
                }
            });
            
            // Start the timer
            window.chatCircularTimer.start(data.expires_at);
        }

        // Legacy function for compatibility - DISABLED to prevent timezone bugs
        function updateSimpleTimer(trialRemaining) {
            // DISABLED: Old timer had timezone issues causing 8:99.99 display
            // Only use loadTrial() which has proper UTC handling
        }

        async function refreshUserStatus() {
            try {
                const res = await fetch('/api/user-info');
                const data = await res.json();

                if (!data.success) {
                    return;
                }

                const { trial_active, trial_remaining, effective_plan, user_plan, trial_used_permanently } = data;

                // Update trial badge
                const trialBadge = document.getElementById('trial-badge');
                
                if (trial_active && trial_remaining > 0) {
                    // Show trial badge
                    if (trialBadge) trialBadge.style.display = 'inline-flex';
                } else {
                    // Hide trial badge if no trial active
                    if (trialBadge) trialBadge.style.display = 'none';
                }
                
                // DON'T call loadTrial() here - let it run independently to avoid conflicts
                // The loadTrial() function runs on its own timer and handles timezone correctly

                // DISABLED OLD RING TIMER - Preventing conflicts with new timer system
                // Use new timer system instead (trial-timer-container)
                

                // Hide trial button if used or active
                const trialBtn = document.getElementById("start-trial-btn");
                if (trialBtn && (trial_active || trial_used_permanently)) {
                    trialBtn.classList.add("hidden");
                }

                // Premium features are now conditionally rendered by server template
                // No need for JavaScript show/hide logic anymore
                

                // Confetti if user subscribed after trial
                if (!trial_active && user_plan !== "bronze" && alertPlayed) {
                    playConfetti();
                    alertPlayed = false;
                }

            } catch (error) {
                
            }
        }

        async function startTrial() {
            try {
                const res = await fetch('/api/trial/activate', { method: 'POST' });
                const data = await res.json();
                
                if (data.success) {
                    refreshUserStatus();
                    // Hide the trial button immediately
                    const trialBtn = document.getElementById("start-trial-btn");
                    if (trialBtn) {
                        trialBtn.classList.add("hidden");
                    }
                }
            } catch (error) {
                
            }
        }

        // Initialize robust timer system - MULTIPLE TRIGGERS
        
        
        // Try multiple ways to ensure loadTrial runs
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                loadTrial();
            });
        } else {
            loadTrial();
        }
        
        // Also call it after a short delay as backup
        setTimeout(() => {
            if (typeof loadTrial === 'function') {
                loadTrial();
            }
        }, 2000);
        
        // Refresh user status less frequently 
        setInterval(refreshUserStatus, 15000); // Refresh every 15 seconds (less aggressive)  
        refreshUserStatus(); // Run once on load
        
        // Enhanced Theme System Functions
        function toggleThemeSelector() {
            const panel = document.getElementById('themeSelector');
            const backdrop = document.getElementById('themeModalBackdrop');
            
            if (panel && backdrop) {
                const isVisible = panel.style.display !== 'none';
                
                if (isVisible) {
                    // Hide modal
                    panel.style.display = 'none';
                    backdrop.style.display = 'none';
                    backdrop.classList.remove('show');
                    document.body.style.overflow = 'auto';
                } else {
                    // Show modal
                    backdrop.style.display = 'block';
                    panel.style.display = 'block';
                    setTimeout(() => backdrop.classList.add('show'), 10);
                    document.body.style.overflow = 'hidden';
                    
                    // Add tier-specific styling to panel
                    const isGold = {% if companion_tier == 'gold' %}true{% else %}false{% endif %};
                    if (isGold) {
                        panel.classList.add('gold-tier');
                    }
                }
            }
        }
        
        // Apply background color
        function applyBackgroundColor(gradientValue) {
            document.body.style.background = gradientValue;
            localStorage.setItem('customBackground', gradientValue);
            
            // Save to server for persistent login sessions
            saveThemeToServer('background', gradientValue);
        }
        
        // Apply text color
        function applyTextColor(colorValue) {
            document.documentElement.style.setProperty('--text-color', colorValue);
            document.body.style.color = colorValue;
            
            // Update specific text elements
            const textElements = document.querySelectorAll('h1, h2, h3, h4, p, span, .message-content, .character-details');
            textElements.forEach(el => {
                el.style.color = colorValue;
            });
            
            localStorage.setItem('customTextColor', colorValue);
            
            // Save to server for persistent login sessions
            saveThemeToServer('text', colorValue);
        }
        
        // Save theme settings to server
        async function saveThemeToServer(type, value) {
            try {
                await fetch('/api/save-theme', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        type: type,
                        value: value
                    })
                });
            } catch (error) {
                console.log('Theme save failed:', error);
            }
        }
        
        // Load theme from server
        async function loadThemeFromServer() {
            try {
                const response = await fetch('/api/get-theme', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    if (data.background) {
                        document.body.style.background = data.background;
                    }
                    if (data.text) {
                        applyTextColor(data.text);
                    }
                }
            } catch (error) {
                console.log('Theme load failed:', error);
            }
        }
        
        // Quick preset themes
        function applyPreset(preset) {
            const presets = {
                'default': {
                    background: 'linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%)',
                    text: '#ffffff'
                },
                'dark': {
                    background: 'linear-gradient(135deg, #000000, #1a1a1a)',
                    text: '#e0e0e0'
                },
                'warm': {
                    background: 'linear-gradient(135deg, #1a0f00, #3d2200, #5a3300)',
                    text: '#ffb347'
                },
                'gold': {
                    background: 'linear-gradient(135deg, #ffd700, #ffb347)',
                    text: '#000000'
                },
                'cosmic': {
                    background: 'linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e)',
                    text: '#00ffff'
                }
            };
            
            if (presets[preset]) {
                applyBackgroundColor(presets[preset].background);
                applyTextColor(presets[preset].text);
            }
        }
        
        // Initialize enhanced theme system
        document.addEventListener('DOMContentLoaded', function() {
            // Load from server first (persistent across logins), fallback to localStorage
            loadThemeFromServer().then(() => {
                // If server load failed, use localStorage as fallback
                const savedBackground = localStorage.getItem('customBackground');
                const savedTextColor = localStorage.getItem('customTextColor');
                
                if (savedBackground && !document.body.style.background) {
                    document.body.style.background = savedBackground;
                }
                if (savedTextColor && !document.body.style.color) {
                    applyTextColor(savedTextColor);
                }
            });
            
            // Background color options
            document.querySelectorAll('.color-option[data-type="background"]').forEach(option => {
                option.addEventListener('click', function() {
                    const bgValue = this.getAttribute('data-value');
                    applyBackgroundColor(bgValue);
                    
                    // Visual feedback
                    document.querySelectorAll('.background-colors .color-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // Text color options
            document.querySelectorAll('.color-option[data-type="text"]').forEach(option => {
                option.addEventListener('click', function() {
                    const textValue = this.getAttribute('data-value');
                    applyTextColor(textValue);
                    
                    // Visual feedback
                    document.querySelectorAll('.text-colors .color-option').forEach(opt => 
                        opt.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
            
            // Preset buttons
            document.querySelectorAll('.preset-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const preset = this.getAttribute('data-preset');
                    applyPreset(preset);
                    
                    // Clear selections
                    document.querySelectorAll('.color-option').forEach(opt => 
                        opt.classList.remove('selected'));
                });
            });
        });
        
        // Close theme panel when clicking outside (handled by backdrop onclick)
        // Removed click outside handler as backdrop handles this now
    </script>
    
    <script src="{{ url_for('static', filename='js/chat.js') }}?v={{ range(1000000) | random }}"></script>
</body>
    <script src="/static/js/mini-assistant-modal.js"></script>
</html>