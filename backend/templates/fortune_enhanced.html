<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystical Tarot Reading - SoulBridge AI</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    
    <!-- Ad-Free Detection Script -->
    <script>
        window.__AD_FREE__ = {{ 'true' if ad_free else 'false' }};
        window.__USER_ID__ = {{ user_session.get('user_id', 1) }};
    </script>
    
    <!-- Conditional AdSense Loading (Only for non-ad-free users) -->
    <script>
        (function() {
            var adFree = (window.__AD_FREE__ === true || window.__AD_FREE__ === 'true');
            if (!adFree) {
                var s = document.createElement('script');
                s.async = true;
                s.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3869471953521437";
                s.crossOrigin = "anonymous";
                document.head.appendChild(s);
                console.log('üì∫ AdSense loaded for fortune page');
            } else {
                console.log('üö´ AdSense blocked - user has ad-free subscription');
            }
        })();
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Inter:wght@300;400;500&display=swap');
        
        :root {
            --gap: 14px;
            --card-w: 180px;
            --card-h: 300px;
            --radius: 12px;
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #f59e0b;
            --dark: #1e1b4b;
            --darker: #0f0c29;
            --light: #f8fafc;
            --text-light: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            margin: 0;
            color: var(--text-light);
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, #24184f 100%);
            min-height: 100vh;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(245, 158, 11, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        
        .navbar {
            background: rgba(30, 27, 75, 0.9);
            backdrop-filter: blur(12px);
            padding: 16px 24px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.3);
        }
        
        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 50%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .back-btn {
            padding: 8px 16px;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 8px;
            color: var(--text-light);
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(139, 92, 246, 0.3);
            transform: translateY(-1px);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .character-intro {
            background: rgba(30, 27, 75, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
        }
        
        .character-intro h2 {
            font-family: 'Cinzel', serif;
            color: var(--accent);
            margin: 0 0 12px 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 12px;
            justify-content: center;
        }
        
        .character-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--accent);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);
        }
        
        .controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: end;
            margin-bottom: 24px;
        }
        
        .panel {
            background: rgba(30, 27, 75, 0.4);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
        }
        
        label {
            color: var(--text-light);
            font-weight: 500;
            display: block;
            margin-bottom: 8px;
        }
        
        select, input[type="text"], input[type="number"] {
            padding: 10px 12px;
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 8px;
            background: rgba(15, 12, 41, 0.8);
            color: var(--text-light);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        button {
            padding: 12px 24px;
            border: 0;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }
        
        button:disabled {
            opacity: .6;
            cursor: not-allowed;
            transform: none;
        }
        
        .cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(var(--card-w), 1fr));
            gap: var(--gap);
            margin-top: 20px;
        }
        
        .card3d {
            width: var(--card-w);
            height: var(--card-h);
            perspective: 1000px;
            margin: 0 auto;
        }
        
        .inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform .7s ease;
            transform-style: preserve-3d;
            border-radius: var(--radius);
        }
        
        .flipped .inner {
            transform: rotateY(180deg);
        }
        
        .face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
            border: 1px solid rgba(245, 158, 11, 0.4);
        }
        
        .face img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        
        .back {
            transform: rotateY(180deg);
        }
        
        .meta {
            margin-top: 12px;
            font-size: 14px;
            background: rgba(30, 27, 75, 0.6);
            backdrop-filter: blur(8px);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-right: 8px;
            margin-bottom: 4px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }
        
        .sym {
            color: #999;
            font-size: 13px;
        }
        
        details {
            background: rgba(30, 27, 75, 0.4);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 10px;
            padding: 8px 10px;
            margin-top: 8px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--accent);
        }
        
        .error {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">‚ú® SoulBridge AI ‚ú®</div>
            <a href="/dashboard" class="back-btn">‚Üê Back to Dashboard</a>
        </div>
    </nav>
    
    <div class="container">
        <div class="character-intro">
            <h2>
                <img src="/static/logos/Fortune Teller Sky.png" class="character-avatar" alt="Fortune Teller Sky">
                Welcome, seeker of wisdom
            </h2>
            <p>I am your spiritual guide, here to illuminate the path ahead through the ancient art of tarot. The cards hold profound insights waiting to be revealed. Let me draw the sacred cards and interpret their mystical messages for you...</p>
            <p><em>Choose your spread, focus your intention, and let the universe speak through the cards.</em></p>
        </div>
        
        <div class="controls">
            <div class="panel">
                <label>Spread 
                    <select id="spread"></select>
                </label>
            </div>
            <div class="panel">
                <label><input type="checkbox" id="reversals" checked /> Include reversals</label>
            </div>
            <div class="panel">
                <label><input type="checkbox" id="clarifiers" /> Add clarifier card</label>
            </div>
            <div class="panel">
                <label><input type="checkbox" id="interpretation" checked /> AI Interpretation</label>
            </div>
            <div class="panel">
                <button id="draw">Draw Cards</button>
            </div>
        </div>
        
        <div id="reading"></div>
    </div>

    <script>
        const API = "/api/v2";
        const IMG_EXT = ".png";
        const IMG_BASE = "/static/tarot/";
        const BACK_IMG = IMG_BASE + "back" + IMG_EXT;

        function cardUrl(slug) {
            return IMG_BASE + slug + IMG_EXT;
        }

        async function loadSpreads() {
            try {
                const r = await fetch(API + "/fortune/spreads");
                const d = await r.json();
                const sel = document.getElementById("spread");
                
                const spreads = {
                    "1 Card": 1,
                    "3 Card": 3,
                    "5 Card": 5,
                    "Celtic Cross": 10
                };
                
                Object.entries(spreads).forEach(([name, count]) => {
                    const o = document.createElement("option");
                    o.value = name;
                    o.textContent = `${name} (${count})`;
                    sel.appendChild(o);
                });
                sel.value = "3 Card";
            } catch (e) {
                console.error("Failed to load spreads:", e);
            }
        }

        function cardHtml(item) {
            const rev = item.orientation === "Reversed";
            const flipClass = "card3d" + (rev ? " flipped" : "");
            const front = cardUrl(item.slug);
            const back = BACK_IMG;
            
            return `<div class="panel" style="padding:12px">
                <div class="${flipClass}" onclick="this.classList.toggle('flipped')">
                    <div class="inner">
                        <div class="face front"><img src="${front}" onerror="this.src='${back}'" alt="${item.card}" /></div>
                        <div class="face back"><img src="${back}" alt="Back" /></div>
                    </div>
                </div>
                <div class="meta">
                    <span class="badge">${item.position}</span>
                    <span class="badge">${item.orientation}</span>
                    <div><strong>${item.card}</strong></div>
                    <div class="grid">
                        <div>${item.meaning}</div>
                        ${item.symbols ? `<div class="sym"><strong>Symbols:</strong> ${item.symbols}</div>` : ""}
                    </div>
                </div>
                ${Array.isArray(item.clarifiers) && item.clarifiers.length ? `<details><summary>Clarifiers (${item.clarifiers.length})</summary>
                    <div class="cards">
                        ${item.clarifiers.map(c => `<div>
                            <div class="${c.orientation === "Reversed" ? "card3d flipped" : "card3d"}">
                                <div class="inner">
                                    <div class="face front"><img src="${cardUrl(c.slug)}" onerror="this.src='${back}'" alt="${c.card}" /></div>
                                    <div class="face back"><img src="${back}" alt="Back" /></div>
                                </div>
                            </div>
                            <div class="meta" style="text-align:center">
                                <span class="badge">${c.orientation}</span>
                                <div><small>${c.card}</small></div>
                            </div>
                        </div>`).join("")}
                    </div>
                </details>` : ""}
            </div>`;
        }

        async function draw() {
            const spread = document.getElementById("spread").value;
            const reversals = document.getElementById("reversals").checked;
            const clarifiers = document.getElementById("clarifiers").checked ? 1 : 0;
            const interpretation = document.getElementById("interpretation").checked;
            const userId = window.__USER_ID__ || 1;
            
            const body = { 
                spread_type: spread.toLowerCase().replace(' ', ''), 
                reversals, 
                clarifiers, 
                interpretation,
                user_id: userId
            };
            
            const wrap = document.getElementById("reading");
            wrap.innerHTML = '<div class="loading">‚ú® Drawing your cards...</div>';
            
            try {
                const r = await fetch(API + "/fortune/enhanced", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(body)
                });
                const d = await r.json();
                
                if (!d.success) {
                    wrap.innerHTML = `<div class="error">${d.error || 'Reading failed'}</div>`;
                    return;
                }
                
                let html = `<div class="panel">
                    <div><strong>${spread}</strong> ‚Ä¢ ${reversals ? "Reversals On" : "Reversals Off"} ‚Ä¢ ${new Date().toLocaleString()}</div>
                    ${clarifiers ? `<div>Clarifiers: 1 per position</div>` : ""}
                    <div style="color: var(--accent); font-size: 12px; margin-top: 4px; display: flex; align-items: center; gap: 6px;">
                        <img src="/static/logos/Fortune Teller Sky.png" style="width: 16px; height: 16px; border-radius: 50%;" alt=""> 
                        Saved to your library
                    </div>
                </div>
                <div class="cards">${d.cards.map(cardHtml).join("")}</div>`;
                
                // Add AI interpretation if available
                if (d.reading) {
                    html += `<div class="panel" style="margin-top: 24px; background: rgba(245, 158, 11, 0.1); border: 2px solid rgba(245, 158, 11, 0.3); backdrop-filter: blur(12px);">
                        <h3 style="color: var(--accent); margin-top: 0; font-family: 'Cinzel', serif; display: flex; align-items: center; gap: 12px;">
                            <img src="/static/logos/Fortune Teller Sky.png" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);" alt="Fortune Teller"> 
                            <span>Your Personal Reading</span>
                        </h3>
                        <div style="line-height: 1.7; color: var(--text-light); font-size: 16px; font-style: italic;">${d.reading.replace(/\n/g, '<br>')}</div>
                    </div>`;
                }
                
                wrap.innerHTML = html;
                
            } catch (e) {
                wrap.innerHTML = `<div class="error">Network error: ${e.message}</div>`;
            }
        }

        document.getElementById("draw").addEventListener("click", draw);
        loadSpreads();
    </script>
</body>
</html>