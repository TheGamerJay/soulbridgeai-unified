<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoulBridge AI - Soul Companion</title>
    <!-- Cache busting for color updates -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            font-family: system-ui, -apple-system, sans-serif;
            background: #000000;
            color: #22d3ee;
        }
    </style>
</head>
<body style="background: #000000;">
    <div id="app">
        <div class="loading">Loading SoulBridge AI - Soul Companion...</div>
    </div>
    
    <!-- Pass data from Flask to React -->
    <script>
        window.APP_DATA = {
            userPlan: "soul_companion", // Unified Soul Companion tier
            trialActive: {{ 'true' if trial_active else 'false' }},
            companionInfo: {
                name: "{{ ai_character_name or companion_info.name if companion_info else 'GamerJay' }}",
                image: "{{ companion_avatar or companion_info.image_url if companion_info else '/static/logos/GamerJay.png' }}",
                greeting: "{{ (companion_info.greeting if companion_info and companion_info.greeting else 'Hey there! Ready to explore some features together?') | safe }}"
            }
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const Send = window.lucide?.Send || (() => React.createElement('span', {}, '→'));

        function SoulCompanionChatPage({ userPlan = "soul_companion", trialActive = false }) {
          // Credit balance state
          const [credits, setCredits] = React.useState(null);
          const [creditsLoading, setCreditsLoading] = React.useState(true);

          // Load user theme or use Soul Companion defaults
          const [theme, setTheme] = React.useState({
            background: '#1a1a1a',
            text: '#22d3ee',
            accent: '#22d3ee'
          });

          // Fetch credit balance
          const fetchCredits = React.useCallback(async () => {
            try {
              const response = await fetch('/api/credits/balance', {
                method: 'GET',
                credentials: 'include'
              });
              const data = await response.json();
              if (data.success) {
                setCredits(data.balance);
              }
            } catch (error) {
              console.error('Failed to fetch credits:', error);
            } finally {
              setCreditsLoading(false);
            }
          }, []);

          React.useEffect(() => {
            // Load user theme from API
            fetch('/api/user/get-theme?tier=soul_companion')
              .then(response => response.json())
              .then(data => {
                if (data.success && data.theme) {
                  setTheme(data.theme);
                  // Apply theme to body
                  document.body.style.background = `linear-gradient(135deg, ${data.theme.background} 0%, ${data.theme.accent}40 50%, ${data.theme.background} 100%)`;
                  document.body.style.color = data.theme.text;
                }
              })
              .catch(error => console.log('Using default Soul Companion theme'));

            // Fetch initial credit balance
            fetchCredits();
          }, [fetchCredits]);

          const colors = {
            primary: theme.accent,
            secondary: theme.background,
            gradient: 'from-cyan-400 to-cyan-500'
          };
          
          console.log('💫 SOUL COMPANION: Theme colors =', colors);
          
          // Get companion info from backend data
          const companion = window.APP_DATA?.companionInfo || {
            name: "GamerJay",
            image: "/static/logos/GamerJay.png", 
            greeting: "Hey there! Ready to explore some features together?"
          };
          
          // Load conversation history from localStorage or use default greeting
          const getStoredMessages = () => {
            try {
              const storageKey = `soulbridge_chat_${companion.name.replace(/\s+/g, '_')}`;
              const stored = localStorage.getItem(storageKey);
              if (stored) {
                const parsed = JSON.parse(stored);
                return parsed.map(msg => ({
                  ...msg,
                  companion: msg.companion || companion
                }));
              }
            } catch (e) {
              console.warn('Failed to load chat history:', e);
            }
            return [{ id: 1, sender: "bot", text: `${companion.greeting} How can I help you today?`, companion: companion }];
          };

          const [messages, setMessages] = useState(getStoredMessages());
          const [input, setInput] = useState("");
          const [loading, setLoading] = useState(false);

          // Save messages to localStorage whenever messages change
          useEffect(() => {
            try {
              const storageKey = `soulbridge_chat_${companion.name.replace(/\s+/g, '_')}`;
              localStorage.setItem(storageKey, JSON.stringify(messages));
            } catch (e) {
              console.warn('Failed to save chat history:', e);
            }
          }, [messages, companion.name]);

          // Clear conversation function
          const clearConversation = () => {
            if (confirm('Clear this conversation? This cannot be undone.')) {
              const defaultMessages = [{ id: 1, sender: "bot", text: `${companion.greeting} How can I help you today?`, companion: companion }];
              setMessages(defaultMessages);
              try {
                const storageKey = `soulbridge_chat_${companion.name.replace(/\s+/g, '_')}`;
                localStorage.removeItem(storageKey);
              } catch (e) {
                console.warn('Failed to clear chat history:', e);
              }
            }
          };

          // Soul Companion features
          const features = [
            {
              icon: "🧠", 
              label: "Decoder", 
              route: "decoder",
              tag: "2 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "🔮", 
              label: "Fortune", 
              route: "fortune",
              tag: "3 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "⭐", 
              label: "Horoscope", 
              route: "horoscope",
              tag: "2 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "✍️", 
              label: "Creative Writer", 
              route: "creative-writing",
              tag: "5 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "🤖", 
              label: "AI Companions", 
              route: "companion-selection",
              tag: "Always Available",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "🎤",
              label: "Voice Journal",
              route: "voice/journal",
              tag: "8 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "🎨",
              label: "AI Images",
              route: "ai-image-generation/",
              tag: "12 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "🎭", 
              label: "Mini Studio", 
              route: "mini-studio",
              tag: "10 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "🧘",
              label: "Meditations",
              route: "meditations",
              tag: "6 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "💝",
              label: "Relationships",
              route: "relationship-profiles/",
              tag: "7 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "🌀", 
              label: "Soul Riddle", 
              route: "soul-riddle",
              tag: "4 credits",
              available: true,
              tier: "soul_companion"
            },
            {
              icon: "🎨", 
              label: "Theme Palette", 
              route: "theme-palette",
              tag: "3 credits",
              available: true,
              tier: "soul_companion"
            }
          ];

          const handleFeatureClick = (feature) => {
            if (feature.available) {
              if (feature.route === "clear-conversation") {
                clearConversation();
              } else {
                window.location.href = `/${feature.route}`;
              }
            }
          };

          const sendMessage = async () => {
            if (!input.trim() || loading) return;

            const userMessage = { id: Date.now(), sender: "user", text: input };
            setMessages(prev => [...prev, userMessage]);
            setInput("");
            setLoading(true);

            try {
              const conversationHistory = messages.slice(-10).map(msg => ({
                role: msg.sender === "user" ? "user" : "assistant",
                content: msg.text
              }));
              
              const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ 
                  message: input,
                  character: companion.name,
                  conversation_history: conversationHistory,
                  user_tier: "bronze"
                })
              });

              const data = await response.json();
              
              if (data.success) {
                setMessages(prev => [...prev, {
                  id: Date.now() + 1,
                  sender: "bot",
                  text: data.response,
                  companion: companion
                }]);
              } else {
                throw new Error(data.error || 'Failed to get response');
              }
            } catch (error) {
              setMessages(prev => [...prev, {
                id: Date.now() + 1,
                sender: "bot",
                text: "I'm having trouble connecting right now. Please try again in a moment.",
                companion: companion
              }]);
            } finally {
              setLoading(false);
            }
          };

          return React.createElement('div', { 
            className: "flex flex-col h-screen text-white",
            style: { backgroundColor: '#000000' }
          },
            // Soul Companion welcome banner
            React.createElement('div', { 
              className: "text-center py-1 text-xs font-medium border-b text-white",
              style: { backgroundColor: colors.primary + "20", borderColor: colors.primary }
            }, 
              "💫 Soul Companion - All features unlocked with Artistic Time credits"
            ),

            // Top bar with bronze-specific styling
            React.createElement('div', { 
              className: "sticky top-0 z-20 w-full shadow-sm",
              style: { backgroundColor: '#000000' }
            },
              React.createElement('div', { className: "flex items-center justify-center py-2 text-sm font-medium text-white gap-4" },
                React.createElement('span', { style: { color: colors.primary } }, 'Soul Companion 💫'),
                trialActive && React.createElement('span', { 
                  className: "px-2 py-1 rounded-full bg-green-500/20 text-green-300 text-xs" 
                }, "Trial Active"),
                
                // Credit counter display
                React.createElement('div', { 
                  className: "flex items-center gap-2 px-3 py-1 rounded-full border text-xs font-medium",
                  style: {
                    backgroundColor: colors.primary + '15',
                    borderColor: colors.primary + '40',
                    color: colors.primary
                  }
                },
                  React.createElement('span', { className: "text-base" }, "⚡"),
                  React.createElement('span', {}, 
                    creditsLoading ? "Loading..." : 
                    credits !== null ? `${credits} Artistic Time` : "Credits unavailable"
                  ),
                  credits !== null && React.createElement('button', {
                    onClick: fetchCredits,
                    className: "ml-1 opacity-60 hover:opacity-100 transition-opacity",
                    title: "Refresh balance"
                  }, "🔄")
                )
              ),
              
              // Feature chips with Soul Companion colors
              React.createElement('div', { className: "max-w-6xl mx-auto px-3 py-2 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3" },
                features.map((f, i) => 
                  React.createElement('button', {
                    key: i,
                    onClick: () => handleFeatureClick(f),
                    className: `group flex flex-col items-center gap-1 rounded-lg px-2 py-3 text-sm font-medium ring-1 transition-all min-h-[80px] cursor-pointer text-white`,
                    style: { 
                      backgroundColor: '#111111',
                      borderColor: colors.primary,
                      ':hover': { backgroundColor: '#222222' }
                    }
                  },
                    React.createElement('span', { className: "text-xl mb-1" }, f.icon),
                    React.createElement('span', { className: "text-xs font-medium text-center leading-tight px-1" }, f.label),
                    React.createElement('span', {
                      className: "mt-1 rounded-md px-1.5 py-0.5 text-[10px] font-semibold ring-1",
                      style: {
                        backgroundColor: `${colors.primary}15`,
                        color: colors.primary,
                        borderColor: `${colors.primary}30`
                      }
                    }, f.tag)
                  )
                )
              )
            ),

            // Action buttons bar with bronze styling
            React.createElement('div', { 
              className: "border-b p-3",
              style: {
                borderColor: colors.primary + '30',
                backgroundColor: '#000000'
              }
            },
              React.createElement('div', { className: "max-w-3xl mx-auto flex gap-2 justify-center flex-wrap" },
                [
                  { icon: "💾", label: "Save Chat", action: "save-chat" },
                  { icon: "📚", label: "Library", action: "library" },
                  { icon: "🗑️", label: "Clear Chat", action: "clear-chat" }
                ].map((btn, i) => 
                  React.createElement('button', {
                    key: i,
                    onClick: () => {
                      if (btn.action === "clear-chat") {
                        clearConversation();
                      } else {
                        window.location.href = `/${btn.action}`;
                      }
                    },
                    className: "flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all hover:opacity-80",
                    style: {
                      backgroundColor: colors.primary + '15',
                      border: `1px solid ${colors.primary}30`,
                      color: colors.primary
                    }
                  },
                    React.createElement('span', {}, btn.icon),
                    React.createElement('span', {}, btn.label)
                  )
                )
              )
            ),

            // Chat area with bronze styling
            React.createElement('div', { className: "flex-1 overflow-y-auto" },
              React.createElement('div', { className: "max-w-3xl mx-auto w-full p-4 space-y-4" },
                messages.map((msg) =>
                  React.createElement('div', {
                    key: msg.id,
                    className: `flex ${msg.sender === "user" ? "justify-end" : "justify-start"}`
                  },
                    msg.sender !== "user" && React.createElement('div', {
                      className: "w-8 h-8 shrink-0 mr-2 rounded-full overflow-hidden bg-gray-800 border-2",
                      style: { borderColor: colors.primary }
                    }, 
                      msg.companion && msg.companion.image 
                        ? React.createElement('img', {
                            src: msg.companion.image,
                            alt: msg.companion.name || 'AI',
                            className: "w-full h-full object-cover"
                          })
                        : React.createElement('div', {
                            className: "w-full h-full flex items-center justify-center text-white font-bold",
                            style: { backgroundColor: colors.primary }
                          }, "🤖")
                    ),
                    React.createElement('div', {
                      className: `max-w-[85%] rounded-2xl px-4 py-2 ${
                        msg.sender === "user" 
                          ? "text-black ml-auto" 
                          : "bg-white text-gray-900 border border-gray-200"
                      }`,
                      style: msg.sender === "user" ? {
                        backgroundColor: colors.primary
                      } : {}
                    },
                      React.createElement('p', { className: "text-sm leading-relaxed whitespace-pre-wrap" }, msg.text)
                    )
                  )
                )
              )
            ),

            // Input area with bronze styling
            React.createElement('div', { 
              className: "border-t p-4",
              style: {
                borderColor: colors.primary + '30',
                backgroundColor: '#000000'
              }
            },
              React.createElement('div', { className: "max-w-3xl mx-auto flex gap-3" },
                React.createElement('input', {
                  type: "text",
                  value: input,
                  onChange: (e) => setInput(e.target.value),
                  onKeyPress: (e) => e.key === 'Enter' && sendMessage(),
                  placeholder: "Type your message...",
                  className: "flex-1 rounded-full px-4 py-2 text-sm focus:outline-none transition-all",
                  style: { 
                    border: `2px solid ${colors.primary}60`,
                    backgroundColor: 'white',
                    color: '#1f2937'
                  },
                  onFocus: (e) => {
                    e.target.style.boxShadow = `0 0 0 3px ${colors.primary}30`;
                    e.target.style.borderColor = colors.primary;
                  },
                  onBlur: (e) => {
                    e.target.style.boxShadow = 'none';
                    e.target.style.borderColor = colors.primary + '60';
                  },
                  disabled: loading
                }),
                React.createElement('button', {
                  onClick: sendMessage,
                  disabled: loading || !input.trim(),
                  className: "rounded-full px-4 py-2 text-black font-medium transition-all hover:opacity-90 disabled:opacity-50",
                  style: { 
                    backgroundColor: colors.primary
                  }
                }, React.createElement(Send, { size: 24 }))
              )
            )
          );
        }

        // Mount Bronze Chat App
        try {
            const container = document.getElementById('app');
            if (container && window.ReactDOM && window.APP_DATA) {
                console.log('🥉 BRONZE CHAT: Mounting with fixed bronze colors');
                
                const root = ReactDOM.createRoot(container);
                root.render(React.createElement(SoulCompanionChatPage, {
                    userPlan: "soul_companion",
                    trialActive: window.APP_DATA.trialActive
                }));
                console.log('Soul Companion chat mounted successfully');
            }
        } catch (error) {
            console.error('Failed to mount Soul Companion chat:', error);
            document.getElementById('app').innerHTML = '<div style="padding: 20px; text-align: center; color: #00FFFF;"><h2>Loading Error</h2><p>Please refresh the page</p></div>';
        }
    </script>
</body>
</html>