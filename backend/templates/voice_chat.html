<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SoulBridgeAI Plus ‚Äì Full Voice Chat Interface</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/themes.css') }}">
  <style>
    body {
      background: linear-gradient(135deg, #000428, #004e92);
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 700px;
      margin: auto;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    h1 {
      background: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff, #06ffa5, #ffbe0b, #fb5607);
      background-size: 400% 400%;
      animation: galaxyText 3s ease-in-out infinite;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      text-align: center;
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 10px;
    }

    h2 {
      color: #22d3ee;
      text-align: center;
      font-size: 1.2rem;
      margin-bottom: 30px;
      opacity: 0.9;
    }

    .voice-control {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      margin: 30px 0;
    }

    .main-voice-btn {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: white;
      box-shadow: 0 10px 30px rgba(255, 0, 110, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .main-voice-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 15px 40px rgba(255, 0, 110, 0.5);
    }

    .main-voice-btn.recording {
      animation: recordingPulse 0.8s infinite;
      background: linear-gradient(45deg, #dc2626, #ef4444, #f87171);
    }

    @keyframes recordingPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 10px 30px rgba(220, 38, 38, 0.5); }
      50% { transform: scale(1.05); box-shadow: 0 15px 40px rgba(220, 38, 38, 0.8); }
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    @keyframes galaxyText {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .status-display {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      min-height: 25px;
      padding: 10px 20px;
      border-radius: 25px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      margin: 20px 0;
    }

    .status-display.listening { color: #ef4444; }
    .status-display.thinking { color: #fbbf24; }
    .status-display.speaking { color: #10b981; }
    .status-display.ready { color: #22d3ee; }

    .response-area {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      min-height: 100px;
      font-size: 1rem;
      line-height: 1.6;
      color: #e2e8f0;
    }

    .controls-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }

    .control-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 12px 20px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .control-btn.stop {
      background: rgba(220, 38, 38, 0.2);
      border-color: rgba(220, 38, 38, 0.4);
    }

    .control-btn.stop:hover {
      background: rgba(220, 38, 38, 0.3);
    }

    .settings-panel {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin-top: 20px;
    }

    .settings-panel h3 {
      color: #22d3ee;
      margin: 0 0 15px 0;
      font-size: 1.1rem;
    }

    select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 0.95rem;
      backdrop-filter: blur(10px);
    }

    select option {
      background: #1a1a1a;
      color: white;
    }

    .back-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(34, 211, 238, 0.8);
      color: #000;
      padding: 10px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s ease;
      text-decoration: none;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .back-btn:hover {
      background: rgba(34, 211, 238, 1);
      transform: translateY(-2px);
    }

    .premium-notice {
      background: linear-gradient(45deg, #ff006e, #8338ec, #3a86ff, #06ffa5, #ffbe0b, #fb5607);
      background-size: 400% 400%;
      animation: galaxyText 3s ease-in-out infinite;
      color: #000;
      padding: 15px;
      border-radius: 15px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 30px;
    }

    .input-area {
      display: none;
    }

    .simple-instruction {
      text-align: center;
      color: #94a3b8;
      font-size: 1rem;
      margin: 15px 0;
    }
  </style>
</head>
<body>

<!-- Back Button -->
<a href="/" class="back-btn">‚Üê Back to Chat</a>

<div class="container">
  <div class="premium-notice">
    ‚≠ê SoulBridge Plus Exclusive Feature ‚≠ê
  </div>

  <h1>SoulBridgeAI Plus ‚Äì Full Voice Chat</h1>
  <h2>AI Voice Chat Interaction</h2>
  
  <div id="premiumCheck" style="display: none;">
    <p style="color: #dc2626; text-align: center; font-weight: bold;">
      üîí This feature requires SoulBridge Plus subscription.
      <br><a href="/subscription" style="color: #ffd700;">Upgrade Now</a>
    </p>
  </div>

  <div id="voiceInterface">
    <!-- Hidden input for voice recognition -->
    <input type="text" id="userInput" class="input-area" placeholder="Voice input will appear here">
    
    <!-- Main Voice Control -->
    <div class="voice-control">
      <p class="simple-instruction">Tap the button and speak to your Galaxy Companion</p>
      
      <button class="main-voice-btn" id="voiceBtn" onclick="startRecognition()">
        üé§
      </button>
      
      <div class="status-display ready" id="status">Ready to listen</div>
    </div>
    
    <!-- AI Response Area -->
    <div class="response-area" id="aiResponse">
      Your Galaxy Companion's voice response will appear here...
    </div>
    
    <!-- Control Buttons -->
    <div class="controls-grid">
      <button class="control-btn" onclick="sendToAI()">üí¨ Send Message</button>
      <button class="control-btn stop" onclick="stopSpeaking()">üõë Stop Speaking</button>
    </div>
    
    <!-- Conversation Mode Toggle -->
    <div style="text-align: center; margin: 20px 0;">
      <button class="control-btn" id="conversationModeBtn" onclick="toggleConversationMode()" style="background: linear-gradient(45deg, #ff006e, #8338ec); border: none; width: 100%;">
        üó£Ô∏è Start Conversation Mode
      </button>
      <p style="color: #94a3b8; font-size: 0.9rem; margin-top: 10px;">
        Conversation Mode: Natural back-and-forth chat like two humans talking
      </p>
    </div>
    
    <!-- Settings Panel -->
    <div class="settings-panel">
      <h3>Voice Settings</h3>
      
      <label for="characterSelect" style="display: block; margin-bottom: 10px; color: #22d3ee; font-weight: 600;">Galaxy Companion:</label>
      <select id="characterSelect" style="margin-bottom: 15px;">
        <option value="Blayzion">Blayzion - Mystical Cosmic Sage</option>
        <option value="Crimson">Crimson - Loyal Guardian Warrior</option>
        <option value="Blayzia">Blayzia - Divine Healing Light</option>
        <option value="Violet">Violet - Ethereal Spiritual Guide</option>
      </select>
      
      <label for="voiceSelect" style="display: block; margin-bottom: 10px; color: #22d3ee; font-weight: 600;">AI Voice:</label>
      <select id="voiceSelect"></select>
    </div>
  </div>
</div>

<script>
  let voices = [];
  let recognition;
  let isRecording = false;
  let isConversationMode = false;
  let conversationActive = false;
  const voiceSelect = document.getElementById("voiceSelect");
  const characterSelect = document.getElementById("characterSelect");
  const voiceBtn = document.getElementById("voiceBtn");
  const status = document.getElementById("status");
  const conversationModeBtn = document.getElementById("conversationModeBtn");

  // Check galaxy companion access
  function checkPremiumAccess() {
    const hasPurchasedBlayzion = localStorage.getItem('purchasedBlayzion') === 'true';
    const hasPurchasedBlayzia = localStorage.getItem('purchasedBlayzia') === 'true';
    const hasGalaxyCompanions = hasPurchasedBlayzion && hasPurchasedBlayzia;
    
    if (!hasGalaxyCompanions) {
      document.getElementById("voiceSelect").disabled = true;
      document.getElementById("userInput").disabled = true;
      document.getElementById('premiumCheck').style.display = 'block';
      document.getElementById('voiceInterface').style.display = 'none';
      
      // Update the premium notice
      const premiumNotice = document.querySelector('.premium-notice');
      premiumNotice.innerHTML = 'üåü Galaxy Companion Exclusive Feature üåü';
      
      const premiumCheck = document.getElementById('premiumCheck');
      premiumCheck.innerHTML = `
        <p style="color: #dc2626; text-align: center; font-weight: bold;">
          üîí Voice features are unlocked only by purchasing both Galaxy companions.
          <br><a href="/" style="color: #ffd700;">Purchase Galaxy Companions</a>
        </p>
      `;
      return false;
    }
    return true;
  }

  // Load custom colors if premium user
  function loadCustomColors() {
    const savedBgColor = localStorage.getItem('customBgColor');
    const savedTextColor = localStorage.getItem('customTextColor');
    const isPremium = localStorage.getItem('isPremium');
    
    if (isPremium === 'true') {
      if (savedBgColor) {
        document.body.style.backgroundColor = savedBgColor;
      }
      if (savedTextColor) {
        document.body.style.color = savedTextColor;
      }
    }
  }

  function populateVoiceList() {
    voices = window.speechSynthesis.getVoices();
    voiceSelect.innerHTML = '';
    
    if (voices.length === 0) {
      const option = document.createElement('option');
      option.textContent = 'Loading voices...';
      voiceSelect.appendChild(option);
      return;
    }
    
    voices.forEach((voice, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = `${voice.name} (${voice.lang})`;
      voiceSelect.appendChild(option);
    });
    
    // Select a good default voice if available
    const preferredVoices = voices.filter(voice => 
      voice.lang.startsWith('en') && 
      (voice.name.includes('Google') || voice.name.includes('Microsoft'))
    );
    if (preferredVoices.length > 0) {
      const defaultIndex = voices.indexOf(preferredVoices[0]);
      voiceSelect.value = defaultIndex;
    }
  }

  function startRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("üö´ Speech recognition not supported in this browser. Try Chrome or Edge.");
      return;
    }

    if (isRecording) {
      stopRecognition();
      return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.continuous = false;

    recognition.onstart = () => {
      isRecording = true;
      voiceBtn.textContent = "üõë";
      voiceBtn.classList.add('recording');
      status.textContent = "üé§ Listening... Speak now!";
      status.className = "status-display listening";
    };

    recognition.onresult = (event) => {
      const speechResult = event.results[0][0].transcript;
      document.getElementById("userInput").value = speechResult;
      status.textContent = `‚úì Heard: "${speechResult}"`;
      status.className = "status-display ready";
      
      // Auto-send after getting voice input
      setTimeout(() => {
        sendToAI();
      }, 1000);
    };

    recognition.onerror = (event) => {
      status.textContent = `‚ùå Error: ${event.error}`;
      status.className = "status-display ready";
      stopRecognition();
    };

    recognition.onend = () => {
      stopRecognition();
    };

    recognition.start();
  }

  function stopRecognition() {
    if (recognition) {
      recognition.stop();
    }
    isRecording = false;
    voiceBtn.textContent = "üé§";
    voiceBtn.classList.remove('recording');
    if (status.textContent.includes("Listening")) {
      status.textContent = "Ready to listen";
      status.className = "status-display ready";
    }
  }

  async function sendToAI() {
    const userText = document.getElementById("userInput").value.trim();
    if (userText === '') {
      alert("Please enter some text or use voice input first!");
      return;
    }

    const selectedCharacter = characterSelect.value;
    status.textContent = "ü§ñ Your Galaxy Companion is thinking...";
    status.className = "status-display thinking";

    try {
      // Send to your existing AI backend
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: userText,
          character: selectedCharacter
        })
      });

      const data = await response.json();
      
      if (data.success) {
        const aiText = data.response;
        document.getElementById("aiResponse").textContent = aiText;
        status.textContent = `üó£Ô∏è ${selectedCharacter} is speaking...`;
        status.className = "status-display speaking";
        speakText(aiText);
      } else {
        throw new Error(data.error || 'AI request failed');
      }
    } catch (error) {
      console.error('Error:', error);
      const fallbackText = `I heard you say: "${userText}". I'm here to guide you on your cosmic journey with wisdom and insight.`;
      document.getElementById("aiResponse").textContent = fallbackText;
      status.textContent = `üó£Ô∏è ${selectedCharacter} is speaking...`;
      status.className = "status-display speaking";
      speakText(fallbackText);
    }
    
    // Clear input for next message
    document.getElementById("userInput").value = "";
  }

  function speakText(text) {
    if (!text) return;
    
    const synth = window.speechSynthesis;
    synth.cancel(); // Stop any current speech
    
    const utterance = new SpeechSynthesisUtterance(text);
    const selectedIndex = voiceSelect.value;
    
    if (voices[selectedIndex]) {
      utterance.voice = voices[selectedIndex];
    }
    
    utterance.rate = 0.9;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    
    utterance.onend = () => {
      status.textContent = "Ready to listen";
      status.className = "status-display ready";
      
      // In conversation mode, automatically start listening again
      if (isConversationMode && conversationActive) {
        setTimeout(() => {
          startRecognition();
        }, 1000); // Wait 1 second before starting next listen cycle
      }
    };
    
    utterance.onerror = (event) => {
      status.textContent = "‚ùå Speech error occurred";
      status.className = "status-display ready";
    };
    
    synth.speak(utterance);
  }

  function stopSpeaking() {
    window.speechSynthesis.cancel();
    status.textContent = "üõë Speech stopped";
    status.className = "status-display ready";
  }

  // Initialize on page load
  window.addEventListener('load', () => {
    loadCustomColors();
    
    if (!checkPremiumAccess()) {
      return;
    }
    
    // Load voices
    populateVoiceList();
    if (window.speechSynthesis.onvoiceschanged !== undefined) {
      window.speechSynthesis.onvoiceschanged = populateVoiceList;
    }
    
    // Set default character from localStorage if available
    const savedCharacter = localStorage.getItem('selectedCharacter');
    if (savedCharacter) {
      characterSelect.value = savedCharacter;
    }
  });

  // Conversation mode toggle function
  function toggleConversationMode() {
    isConversationMode = !isConversationMode;
    
    if (isConversationMode) {
      conversationActive = true;
      conversationModeBtn.textContent = "üõë Stop Conversation Mode";
      conversationModeBtn.style.background = "linear-gradient(45deg, #dc2626, #ef4444)";
      status.textContent = "üó£Ô∏è Conversation Mode Active - Tap mic to start continuous chat";
      status.className = "status-display ready";
    } else {
      conversationActive = false;
      conversationModeBtn.textContent = "üó£Ô∏è Start Conversation Mode";
      conversationModeBtn.style.background = "linear-gradient(45deg, #ff006e, #8338ec)";
      status.textContent = "Ready to listen";
      status.className = "status-display ready";
      
      // Stop any ongoing speech recognition
      if (isRecording) {
        stopRecognition();
      }
      
      // Stop any ongoing speech
      window.speechSynthesis.cancel();
    }
  }

  // Allow Enter key to send message
  document.getElementById('userInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      sendToAI();
    }
  });
</script>

</body>
</html>