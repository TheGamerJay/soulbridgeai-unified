// Complete working login system - replaces all broken functionality
document.addEventListener("DOMContentLoaded", function() {
    
    // === LOGIN FORM HANDLING ===
    const loginForm = document.getElementById("loginForm");
    const loginBtn = document.getElementById("loginBtn");
    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    
    if (loginForm) {
        loginForm.onsubmit = null;
        loginForm.addEventListener("submit", function(e) {
            const email = emailInput ? emailInput.value.trim() : "";
            const password = passwordInput ? passwordInput.value : "";
            if (!email || !password) {
                e.preventDefault();
                alert("Please enter both email and password");
                return;
            }
            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.textContent = "Signing in...";
            }
            // Let form submit naturally
        });
    }
    
    // === PASSWORD TOGGLE ===
    const passwordToggleBtn = document.getElementById("loginToggleBtn");
    if (passwordToggleBtn && passwordInput) {
        passwordToggleBtn.addEventListener("click", function() {
            if (passwordInput.type === "password") {
                passwordInput.type = "text";
                passwordToggleBtn.textContent = "üôà";
            } else {
                passwordInput.type = "password";
                passwordToggleBtn.textContent = "üëÅÔ∏è";
            }
        });
    }
    
    // === THEME TOGGLE ===
    const themeToggle = document.getElementById("themeToggle");
    if (themeToggle) {
        themeToggle.addEventListener("click", function() {
            document.body.classList.toggle("day-mode");
            const isDayMode = document.body.classList.contains("day-mode");
            
            const themeText = document.getElementById("themeText");
            const themeIcon = document.getElementById("themeIcon");
            
            if (isDayMode) {
                if (themeText) themeText.textContent = "Day Mode is ON";
                if (themeIcon) themeIcon.textContent = "‚òÄÔ∏è";
                themeToggle.style.background = "rgba(255, 193, 7, 0.8)";
                themeToggle.style.color = "#000";
                localStorage.setItem("theme", "day");
            } else {
                if (themeText) themeText.textContent = "Night Mode is ON";
                if (themeIcon) themeIcon.textContent = "üåô";
                themeToggle.style.background = "rgba(34, 211, 238, 0.8)";
                themeToggle.style.color = "#000";
                localStorage.setItem("theme", "night");
            }
        });
    }
    
    // === LANGUAGE TOGGLE ===
    const languageSelector = document.getElementById("languageSelector");
    const languageMenu = document.getElementById("languageMenu");
    
    if (languageSelector && languageMenu) {
        languageSelector.addEventListener("click", function() {
            languageMenu.style.display = languageMenu.style.display === "block" ? "none" : "block";
        });
        
        // Close menu when clicking outside
        document.addEventListener("click", function(event) {
            if (!languageSelector.contains(event.target) && !languageMenu.contains(event.target)) {
                languageMenu.style.display = "none";
            }
        });
    }
    
    // === LANGUAGE CHANGE ===
    window.changeLanguage = function(langCode) {
        console.log("üåç Changing language to:", langCode);
        localStorage.setItem("selectedLanguage", langCode);
        
        // Update language display (match template's currentLanguage element)
        const currentLanguage = document.getElementById("currentLanguage");
        const langMap = {
            'en': 'EN',
            'es': 'ES', 
            'fr': 'FR',
            'de': 'DE',
            'pt': 'PT',
            'zh': 'ZH',
            'ja': 'JP',
            'ru': 'RU'
        };
        
        if (currentLanguage && langMap[langCode]) {
            currentLanguage.textContent = langMap[langCode];
            console.log('üåê [EXTERNAL] Updated language display to:', langMap[langCode]);
        }
        
        // Hide menu
        if (languageMenu) {
            languageMenu.style.display = "none";
            console.log('üåê [EXTERNAL] Language menu hidden');
        }
        
        // Apply translations (basic implementation)
        console.log('üåê [EXTERNAL] About to call applyTranslations with:', langCode);
        try {
            applyTranslations(langCode);
        } catch (error) {
            console.error('üåê [EXTERNAL] Error in applyTranslations:', error);
        }
    };
    
    // === LOAD SAVED SETTINGS ===
    function loadSavedSettings() {
        // Load theme
        const savedTheme = localStorage.getItem("theme") || "night";
        if (savedTheme === "day" && document.body) {
            document.body.classList.add("day-mode");
            const themeText = document.getElementById("themeText");
            const themeIcon = document.getElementById("themeIcon");
            
            if (themeText) themeText.textContent = "Day Mode is ON";
            if (themeIcon) themeIcon.textContent = "‚òÄÔ∏è";
            if (themeToggle) {
                themeToggle.style.background = "rgba(255, 193, 7, 0.8)";
                themeToggle.style.color = "#000";
            }
        }
        
        // Load language (match template's currentLanguage element)
        const savedLang = localStorage.getItem("selectedLanguage") || "en";
        const currentLanguage = document.getElementById("currentLanguage");
        const langMap = {
            'en': 'EN',
            'es': 'ES',
            'fr': 'FR',
            'de': 'DE',
            'pt': 'PT',
            'zh': 'ZH',
            'ja': 'JP',
            'ru': 'RU'
        };
        
        if (currentLanguage && langMap[savedLang]) {
            currentLanguage.textContent = langMap[savedLang];
            console.log('üåê [EXTERNAL] Loaded saved language display:', langMap[savedLang]);
        }
        
        // Apply saved language translations
        applyTranslations(savedLang);
    }
    
    // === BASIC TRANSLATIONS ===
    function applyTranslations(langCode) {
        console.log('üåç [EXTERNAL] Applying translations for language:', langCode);
        
        const translations = {
            en: {
                sign_in: "Sign In",
                sign_in_subtitle: "Sign in to continue your journey",
                email_address: "Email Address", 
                password: "Password",
                forgot_password: "Forgot password?",
                welcome_back: "Welcome Back",
                no_account: "Don't have an account?",
                sign_up: "Sign up",
                language_en: "EN"
            },
            es: {
                sign_in: "Iniciar Sesi√≥n",
                sign_in_subtitle: "Inicia sesi√≥n para continuar tu viaje",
                email_address: "Direcci√≥n de Correo",
                password: "Contrase√±a", 
                forgot_password: "¬øOlvidaste tu contrase√±a?",
                welcome_back: "Bienvenido de Vuelta",
                no_account: "¬øNo tienes una cuenta?",
                sign_up: "Registrarse",
                language_en: "ES"
            },
            fr: {
                sign_in: "Se Connecter",
                sign_in_subtitle: "Connectez-vous pour continuer votre voyage",
                email_address: "Adresse E-mail",
                password: "Mot de Passe",
                forgot_password: "Mot de passe oubli√©?",
                welcome_back: "Bon Retour",
                no_account: "Vous n'avez pas de compte?",
                sign_up: "S'inscrire",
                language_en: "FR"
            },
            de: {
                sign_in: "Anmelden",
                sign_in_subtitle: "Melden Sie sich an, um Ihre Reise fortzusetzen",
                email_address: "E-Mail-Adresse",
                password: "Passwort",
                forgot_password: "Passwort vergessen?",
                welcome_back: "Willkommen zur√ºck",
                no_account: "Haben Sie kein Konto?",
                sign_up: "Registrieren",
                language_en: "DE"
            },
            pt: {
                sign_in: "Entrar",
                sign_in_subtitle: "Fa√ßa login para continuar sua jornada",
                email_address: "Endere√ßo de E-mail",
                password: "Senha",
                forgot_password: "Esqueceu a senha?",
                welcome_back: "Bem-vindo de Volta",
                no_account: "N√£o tem uma conta?",
                sign_up: "Cadastrar-se",
                language_en: "PT"
            },
            zh: {
                sign_in: "ÁôªÂΩï",
                sign_in_subtitle: "ÁôªÂΩï‰ª•ÁªßÁª≠ÊÇ®ÁöÑÊóÖÁ®ã",
                email_address: "ÁîµÂ≠êÈÇÆ‰ª∂Âú∞ÂùÄ",
                password: "ÂØÜÁ†Å",
                forgot_password: "ÂøòËÆ∞ÂØÜÁ†ÅÔºü",
                welcome_back: "Ê¨¢ËøéÂõûÊù•",
                no_account: "Ê≤°ÊúâË¥¶Êà∑Ôºü",
                sign_up: "Ê≥®ÂÜå",
                language_en: "ZH"
            },
            ja: {
                sign_in: "„É≠„Ç∞„Ç§„É≥",
                sign_in_subtitle: "„ÅÇ„Å™„Åü„ÅÆÊóÖ„ÇíÁ∂ö„Åë„Çã„Åü„ÇÅ„Å´„É≠„Ç∞„Ç§„É≥„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
                email_address: "„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ",
                password: "„Éë„Çπ„ÉØ„Éº„Éâ",
                forgot_password: "„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂøò„Çå„Åæ„Åó„Åü„ÅãÔºü",
                welcome_back: "„Åä„Åã„Åà„Çä„Å™„Åï„ÅÑ",
                no_account: "„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Å™„ÅÑ„Åß„Åô„ÅãÔºü",
                sign_up: "„Çµ„Ç§„É≥„Ç¢„ÉÉ„Éó",
                language_en: "JP"
            },
            ru: {
                sign_in: "–í–æ–π—Ç–∏",
                sign_in_subtitle: "–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–≤–æ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ",
                email_address: "–ê–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã",
                password: "–ü–∞—Ä–æ–ª—å",
                forgot_password: "–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?",
                welcome_back: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ",
                no_account: "–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?",
                sign_up: "–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è",
                language_en: "RU"
            }
        };
        
        const translation = translations[langCode] || translations.en;
        console.log('üåç [EXTERNAL] Translation object:', translation);
        
        // Find all elements with data-translate attribute
        const elements = document.querySelectorAll('[data-translate]');
        console.log('üåç [EXTERNAL] Found elements with data-translate:', elements.length);
        
        elements.forEach(element => {
            const key = element.getAttribute('data-translate');
            console.log('üåç [EXTERNAL] Processing element with key:', key, 'current text:', element.textContent.trim());
            if (translation[key]) {
                element.textContent = translation[key];
                console.log('üåç [EXTERNAL] Updated to:', translation[key]);
            } else {
                console.warn('üåç [EXTERNAL] Missing translation for key:', key);
            }
        });
        
        // Update placeholders
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        
        if (emailInput && translation.email_address) {
            emailInput.placeholder = translation.email_address;
            console.log('üåç [EXTERNAL] Updated email placeholder to:', translation.email_address);
        }
        if (passwordInput && translation.password) {
            passwordInput.placeholder = translation.password;
            console.log('üåç [EXTERNAL] Updated password placeholder to:', translation.password);
        }
        
        console.log('üåç [EXTERNAL] Translation application complete');
    }
    
    // Initialize settings
    loadSavedSettings();
    
});